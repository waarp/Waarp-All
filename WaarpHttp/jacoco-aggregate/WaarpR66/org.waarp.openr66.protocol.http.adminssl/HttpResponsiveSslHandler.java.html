<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>HttpResponsiveSslHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Http</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.protocol.http.adminssl</a> &gt; <span class="el_source">HttpResponsiveSslHandler.java</span></div><h1>HttpResponsiveSslHandler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.protocol.http.adminssl;

import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.HttpMethod;
import io.netty.handler.codec.http.HttpResponseStatus;
import io.netty.handler.codec.http.QueryStringDecoder;
import io.netty.handler.codec.http.cookie.DefaultCookie;
import org.joda.time.DateTime;
import org.joda.time.format.DateTimeFormat;
import org.joda.time.format.DateTimeFormatter;
import org.waarp.common.command.exception.Reply421Exception;
import org.waarp.common.command.exception.Reply530Exception;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.data.AbstractDbData.UpdatedInfo;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.digest.FilesystemBasedDigest;
import org.waarp.common.exception.InvalidArgumentException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.json.JsonHandler;
import org.waarp.common.logging.WaarpLogLevel;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.role.RoleDefault.ROLE;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.common.utility.Version;
import org.waarp.common.utility.WaarpShutdownHook;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.gateway.kernel.http.HttpWriteCacheEnable;
import org.waarp.openr66.client.Message;
import org.waarp.openr66.client.SubmitTransfer;
import org.waarp.openr66.client.utils.OutputFormat;
import org.waarp.openr66.context.ErrorCode;
import org.waarp.openr66.context.R66FiniteDualStates;
import org.waarp.openr66.context.R66Result;
import org.waarp.openr66.context.task.SpooledInformTask;
import org.waarp.openr66.database.DbConstantR66;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.database.data.DbHostConfiguration;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.database.data.DbTaskRunner.Columns;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessException;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.LocalServerHandler;
import org.waarp.openr66.protocol.localhandler.LocalTransaction;
import org.waarp.openr66.protocol.localhandler.ServerActions;
import org.waarp.openr66.protocol.localhandler.packet.ErrorPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket.TRANSFERMODE;
import org.waarp.openr66.protocol.localhandler.packet.TestPacket;
import org.waarp.openr66.protocol.networkhandler.NetworkTransaction;
import org.waarp.openr66.protocol.utils.NbAndSpecialId;
import org.waarp.openr66.protocol.utils.R66Future;
import org.waarp.openr66.protocol.utils.TransferUtils;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import static org.waarp.openr66.client.TransferArgs.*;

/**
 *
 */
<span class="fc" id="L98">public class HttpResponsiveSslHandler extends HttpSslHandler {</span>
  private static final String B_CENTER_P2 = &quot;&lt;/b&gt;&lt;/center&gt;&lt;/p&gt;&quot;;

  private static final String FILTER2 = &quot;Filter&quot;;

  private static final String ACTION2 = &quot;ACTION&quot;;

  private static final String OPEN_R66_WEB_ERROR2 = &quot;OpenR66 Web Error {}&quot;;

  /**
   * Internal Logger
   */
<span class="fc" id="L110">  private static final WaarpLogger logger =</span>
<span class="fc" id="L111">      WaarpLoggerFactory.getLogger(HttpResponsiveSslHandler.class);</span>

  public static final String LISTING_PAGE = &quot;Listing.html&quot;;

<span class="fc" id="L115">  private enum REQUEST {</span>
<span class="fc" id="L116">    Logon(&quot;Logon.html&quot;), Logout(&quot;Logon.html&quot;), index(&quot;index.html&quot;),</span>
<span class="fc" id="L117">    error(&quot;Error.html&quot;), unallowed(&quot;NotAllowed.html&quot;), Listing(LISTING_PAGE),</span>
<span class="fc" id="L118">    ListingReload(LISTING_PAGE), CancelRestart(&quot;CancelRestart.html&quot;),</span>
<span class="fc" id="L119">    Export(&quot;Export.html&quot;), Hosts(&quot;Hosts.html&quot;), Rules(&quot;Rules.html&quot;),</span>
<span class="fc" id="L120">    System(&quot;System.html&quot;), SystemLimited(&quot;SystemLimited.html&quot;),</span>
<span class="fc" id="L121">    Spooled(&quot;Spooled.html&quot;), SpooledDetailed(&quot;Spooled.html&quot;),</span>
<span class="fc" id="L122">    CreateTransfer(&quot;CreateTransfer.html&quot;);</span>

    private final String header;

    /**
     * Constructor for a unique file
     *
     * @param uniquefile
     */
<span class="fc" id="L131">    REQUEST(final String uniquefile) {</span>
<span class="fc" id="L132">      header = uniquefile;</span>
<span class="fc" id="L133">    }</span>

    /**
     * @param header
     * @param headerBody
     * @param body
     * @param endBody
     * @param end
     */
    REQUEST(final String header, final String headerBody, final String body,
<span class="nc" id="L143">            final String endBody, final String end) {</span>
<span class="nc" id="L144">      this.header = header;</span>
<span class="nc" id="L145">    }</span>

    /**
     * Reader for a unique file
     *
     * @return the content of the unique file
     */
    public String read(final HttpResponsiveSslHandler handler) {
<span class="fc" id="L153">      return handler.readFile(</span>
<span class="fc" id="L154">          Configuration.configuration.getHttpBasePath() + header);</span>
    }
  }


  public static final String LIMITROW1 = &quot;LIMITROW&quot;;
  public static final String REFRESH = &quot;REFRESH&quot;;
  private static final String XXXRESULTXXX = &quot;XXXRESULTXXX&quot;;
  private static final String XXXDATAJSONXXX = &quot;XXXDATAJSONXXX&quot;;
  private static final String XXXHOSTSIDSXXX = &quot;XXXHOSTSIDSXXX&quot;;
  private static final String XXXRULEIDSXXX = &quot;XXXRULEIDSXXX&quot;;
  private static final String XXXBLOCKSIZEXXX = &quot;XXXBLOCKSIZEXXX&quot;;

  private String indexResponsive() {
<span class="fc" id="L168">    final String index = REQUEST.index.read(this);</span>
<span class="fc" id="L169">    final StringBuilder builder = new StringBuilder(index);</span>
<span class="fc" id="L170">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXHOSTIDXXX.toString(),</span>
<span class="fc" id="L171">                                Configuration.configuration.getHostId());</span>
<span class="fc" id="L172">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L173">                                Messages.getString(</span>
                                    &quot;HttpSslHandler.2&quot;)); //$NON-NLS-1$
<span class="fc" id="L175">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXVERSIONXXX.toString(),</span>
<span class="fc" id="L176">                             Version.fullIdentifier());</span>
<span class="fc" id="L177">    return builder.toString();</span>
  }

  @Override
  protected final String error(final String mesg) {
<span class="fc" id="L182">    final String index = REQUEST.error.read(this);</span>
<span class="fc" id="L183">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  private String unallowedResponsive(final String mesg) {
<span class="fc" id="L187">    final String index = REQUEST.unallowed.read(this);</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    if (ParametersChecker.isEmpty(index)) {</span>
<span class="nc" id="L189">      return error(mesg);</span>
    }
<span class="fc" id="L191">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  @Override
  protected final String logon() {
<span class="fc" id="L196">    return REQUEST.Logon.read(this);</span>
  }

  private String setDbTaskRunnerJsonData(final String head, String errorText,
                                         final String startid,
                                         final String stopid,
                                         final Timestamp tstart,
                                         final Timestamp tstop,
                                         final String rule, final String req,
                                         final boolean pending,
                                         final boolean transfer,
                                         final boolean error,
                                         final boolean done,
                                         final boolean all) {
<span class="fc" id="L210">    final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="fc" id="L211">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L213">      preparedStatement =</span>
<span class="fc" id="L214">          DbTaskRunner.getFilterPrepareStatement(dbSession, getLimitRow(),</span>
                                                 false, startid, stopid, tstart,
                                                 tstop, rule, req, pending,
                                                 transfer, error, done, all,
                                                 seeAll);
<span class="fc" id="L219">      final String json =</span>
<span class="fc" id="L220">          DbTaskRunner.getJson(preparedStatement, getLimitRow());</span>
<span class="fc" id="L221">      return head.replace(XXXDATAJSONXXX, json);</span>
<span class="nc" id="L222">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L224">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L226">      logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L227">      errorText +=</span>
<span class="nc" id="L228">          Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() + &quot;&lt;BR/&gt;&quot;;</span>
    }
<span class="nc" id="L230">    return head.replace(XXXRESULTXXX, errorText);</span>
  }

  private String listingReload() {
<span class="fc" id="L234">    final String errorText = &quot;&quot;;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L236">      return getHeadNoParam(REQUEST.Listing, errorText);</span>
    }
<span class="fc" id="L238">    final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="fc" id="L239">    String head = REQUEST.Listing.read(this);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L241">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="pc bpc" id="L243" title="1 of 4 branches missed.">      if (FILTER2.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L244">        head = getFilter(errorText, head, isNotReload);</span>
      }
    }
<span class="fc" id="L247">    head =</span>
<span class="fc" id="L248">        resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                            false, true);
<span class="fc" id="L250">    head = setDbTaskRunnerJsonData(head, errorText, &quot;&quot;, &quot;&quot;, null, null, &quot;&quot;, &quot;&quot;,</span>
                                   false, false, false, false, true);
<span class="fc" id="L252">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String getFilter(final String errorText, String head,
                           final boolean isNotReload) {
<span class="fc" id="L257">    String startid = getTrimValue(&quot;startid&quot;);</span>
<span class="fc" id="L258">    String stopid = getTrimValue(&quot;stopid&quot;);</span>
<span class="pc bpc" id="L259" title="3 of 6 branches missed.">    if (isNotReload &amp;&amp; startid != null &amp;&amp; stopid == null) {</span>
<span class="nc" id="L260">      stopid = Long.MAX_VALUE + &quot;&quot;;</span>
    }
<span class="pc bpc" id="L262" title="3 of 6 branches missed.">    if (isNotReload &amp;&amp; stopid != null &amp;&amp; startid == null) {</span>
<span class="nc" id="L263">      startid = (DbConstantR66.ILLEGALVALUE + 1) + &quot;&quot;;</span>
    }
<span class="fc" id="L265">    String start = getValue(&quot;start&quot;);</span>
<span class="fc" id="L266">    String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L267">    final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L268">    final String req = getTrimValue(&quot;req&quot;);</span>
    final boolean pending;
    final boolean transfer;
    final boolean error;
    final boolean done;
    boolean all;
<span class="fc" id="L274">    pending = params.containsKey(&quot;pending&quot;);</span>
<span class="fc" id="L275">    transfer = params.containsKey(&quot;transfer&quot;);</span>
<span class="fc" id="L276">    error = params.containsKey(&quot;error&quot;);</span>
<span class="fc" id="L277">    done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L278">    all = params.containsKey(&quot;all&quot;);</span>
<span class="pc bpc" id="L279" title="7 of 8 branches missed.">    if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L280">      all = true;</span>
<span class="pc bpc" id="L281" title="4 of 8 branches missed.">    } else if (!(pending || transfer || error || done)) {</span>
<span class="fc" id="L282">      all = true;</span>
    }
<span class="fc" id="L284">    final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">    if (tstart != null) {</span>
<span class="nc" id="L286">      start = tstart.toString();</span>
    }
<span class="fc" id="L288">    final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">    if (tstop != null) {</span>
<span class="nc" id="L290">      stop = tstop.toString();</span>
    }
<span class="fc" id="L292">    head =</span>
<span class="fc" id="L293">        setDbTaskRunnerJsonData(head, errorText, startid, stopid, tstart, tstop,</span>
                                rule, req, pending, transfer, error, done, all);
<span class="pc bpc" id="L295" title="4 of 8 branches missed.">    head = resetOptionTransfer(head, startid == null? &quot;&quot; : startid,</span>
                               stopid == null? &quot;&quot; : stopid, start, stop,
                               rule == null? &quot;&quot; : rule, req == null? &quot;&quot; : req,
                               pending, transfer, error, done, all);
<span class="fc" id="L299">    return head;</span>
  }

  private String listing() {
<span class="fc" id="L303">    getParamsResponsive();</span>
<span class="fc" id="L304">    return listingReload();</span>
  }

  private String cancelRestart() {
<span class="fc" id="L308">    getParamsResponsive();</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L310">      return getHeadNoParam(REQUEST.CancelRestart, &quot;&quot;);</span>
    }
<span class="fc" id="L312">    String head = REQUEST.CancelRestart.read(this);</span>
<span class="fc" id="L313">    String errorText = &quot;&quot;;</span>
<span class="fc" id="L314">    final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="fc" id="L315">    final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L317">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">      if (&quot;Search&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L320">        head = getHeadSearchCancelRestart(head, errorText);</span>
<span class="fc bfc" id="L321" title="All 4 branches covered.">      } else if (FILTER2.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L322">        head = getFilter(errorText, head, isNotReload);</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">      } else if (&quot;RestartAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">                 &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                 &quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L326">        final RestartOrStopAll restartOrStopAll =</span>
<span class="fc" id="L327">            new RestartOrStopAll(head, errorText, seeAll, parm).invoke();</span>
<span class="fc" id="L328">        head = restartOrStopAll.getHead();</span>
<span class="fc" id="L329">        errorText = restartOrStopAll.getErrorText();</span>
<span class="pc bnc" id="L330" title="All 2 branches missed.">      } else if (&quot;Cancel&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                 &quot;CancelClean&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                 &quot;Stop&quot;.equalsIgnoreCase(parm)) {</span>
        // Cancel or Stop
<span class="nc" id="L334">        final boolean stop = &quot;Stop&quot;.equalsIgnoreCase(parm);</span>
<span class="nc" id="L335">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L336">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L337">        final String reqr = getValue(&quot;reqr&quot;);</span>
<span class="nc" id="L338">        final LocalChannelReference lcr =</span>
<span class="nc" id="L339">            Configuration.configuration.getLocalTransaction().getFromRequest(</span>
                reqd + ' ' + reqr + ' ' + specid);
        // stop the current transfer
        ErrorCode result;
        final long lspecid;
        try {
<span class="nc" id="L345">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L346">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L347">          errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + parm +</span>
<span class="nc" id="L348">                       Messages.getString(&quot;HttpSslHandler.3&quot;); //$NON-NLS-2$</span>
<span class="nc" id="L349">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L350">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L351">        }</span>
<span class="nc" id="L352">        DbTaskRunner taskRunner = null;</span>
        try {
<span class="nc" id="L354">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L355">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L357">        }</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (taskRunner == null) {</span>
<span class="nc" id="L359">          errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + parm +</span>
<span class="nc" id="L360">                       Messages.getString(&quot;HttpSslHandler.3&quot;); //$NON-NLS-2$</span>
<span class="nc" id="L361">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L362">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
<span class="nc bnc" id="L364" title="All 2 branches missed.">        final ErrorCode code =</span>
            stop? ErrorCode.StoppedTransfer : ErrorCode.CanceledTransfer;
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (lcr != null) {</span>
<span class="nc" id="L367">          final int rank = taskRunner.getRank();</span>
<span class="nc" id="L368">          lcr.sessionNewState(R66FiniteDualStates.ERROR);</span>
<span class="nc" id="L369">          final ErrorPacket error =</span>
<span class="nc" id="L370">              new ErrorPacket(&quot;Transfer &quot; + parm + ' ' + rank, code.getCode(),</span>
                              ErrorPacket.FORWARDCLOSECODE);
          try {
            // inform local instead of remote
<span class="nc" id="L374">            LocalServerHandler.channelRead0(lcr, error);</span>
<span class="nc" id="L375">          } catch (final Exception ignored) {</span>
            // nothing
<span class="nc" id="L377">          }</span>
<span class="nc" id="L378">          result = ErrorCode.CompleteOk;</span>
<span class="nc" id="L379">        } else {</span>
          // Transfer is not running
          // But is the database saying the contrary
<span class="nc" id="L382">          result = ErrorCode.TransferOk;</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">          if (taskRunner != null &amp;&amp; taskRunner.stopOrCancelRunner(code)) {</span>
<span class="nc" id="L384">            result = ErrorCode.CompleteOk;</span>
          }
        }
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (taskRunner != null) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">          if (&quot;CancelClean&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L389">            TransferUtils.cleanOneTransfer(taskRunner, null, authentHttp, null);</span>
          }
<span class="nc" id="L391">          final String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L392">          final String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L393">          head = resetOptionTransfer(head, String.valueOf(</span>
<span class="nc" id="L394">                                         taskRunner.getSpecialId() - 1), String.valueOf(</span>
<span class="nc" id="L395">                                         taskRunner.getSpecialId() + 1), tstart, tstop,</span>
<span class="nc" id="L396">                                     taskRunner.getRuleId(),</span>
<span class="nc" id="L397">                                     taskRunner.getRequested(), false, false,</span>
                                     false, false, true);
        }
<span class="nc" id="L400">        final String json = taskRunner.getJsonAsString();</span>
<span class="nc" id="L401">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + (result == ErrorCode.CompleteOk?</span>
<span class="nc" id="L403">            parm + Messages.getString(&quot;HttpSslHandler.5&quot;) :</span>
            //$NON-NLS-2$
<span class="nc" id="L405">            parm + Messages.getString(&quot;HttpSslHandler.4&quot;)) +</span>
                     &quot;&lt;/b&gt;&quot;; //$NON-NLS-1$
<span class="nc bnc" id="L407" title="All 2 branches missed.">      } else if (&quot;Restart&quot;.equalsIgnoreCase(parm)) {</span>
        // Restart
<span class="nc" id="L409">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L410">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L411">        final String reqr = getValue(&quot;reqr&quot;);</span>
        final long lspecid;
<span class="nc bnc" id="L413" title="All 6 branches missed.">        if (specid == null || reqd == null || reqr == null) {</span>
<span class="nc" id="L414">          errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + parm +</span>
<span class="nc" id="L415">                       Messages.getString(&quot;HttpSslHandler.3&quot;); //$NON-NLS-2$</span>
<span class="nc" id="L416">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L417">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        try {
<span class="nc" id="L420">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L421">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L422">          errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + parm +</span>
<span class="nc" id="L423">                       Messages.getString(&quot;HttpSslHandler.3&quot;); //$NON-NLS-2$</span>
<span class="nc" id="L424">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L425">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L426">        }</span>
        final DbTaskRunner taskRunner;
<span class="nc" id="L428">        String comment = &quot;&quot;;</span>
        try {
<span class="nc" id="L430">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L431">          final LocalChannelReference lcr =</span>
<span class="nc" id="L432">              Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L433">                                         .getFromRequest(taskRunner.getKey());</span>
<span class="nc" id="L434">          final R66Result finalResult =</span>
<span class="nc" id="L435">              TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L436">          comment = (String) finalResult.getOther();</span>
<span class="nc" id="L437">          final String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L438">          final String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L439">          head = resetOptionTransfer(head, String.valueOf(</span>
<span class="nc" id="L440">                                         taskRunner.getSpecialId() - 1), String.valueOf(</span>
<span class="nc" id="L441">                                         taskRunner.getSpecialId() + 1), tstart, tstop,</span>
<span class="nc" id="L442">                                     taskRunner.getRuleId(),</span>
<span class="nc" id="L443">                                     taskRunner.getRequested(), false, false,</span>
                                     false, false, true);
<span class="nc" id="L445">          final String json = taskRunner.getJsonAsString();</span>
<span class="nc" id="L446">          head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="nc" id="L447">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L448">          errorText +=</span>
<span class="nc" id="L449">              Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() +</span>
              &quot;&lt;BR/&gt;&quot;;
<span class="nc" id="L451">        }</span>
<span class="nc" id="L452">        errorText += &quot;&lt;br&gt;&lt;b&gt;&quot; + comment + &quot;&lt;/b&gt;&quot;;</span>
      }
    }
<span class="fc" id="L455">    head =</span>
<span class="fc" id="L456">        resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                            false, true);
<span class="fc" id="L458">    head = setDbTaskRunnerJsonData(head, errorText, &quot;&quot;, &quot;&quot;, null, null, &quot;&quot;, &quot;&quot;,</span>
                                   false, false, false, false, true);
<span class="fc" id="L460">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String getHeadSearchCancelRestart(String head, String errorText) {
<span class="fc" id="L464">    final String followId = getTrimValue(&quot;followId&quot;);</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">    if (followId != null) {</span>
      try {
<span class="fc" id="L467">        final int limit = getLimitRow();</span>
<span class="fc" id="L468">        final DbTaskRunner[] dbTaskRunners =</span>
<span class="fc" id="L469">            DbTaskRunner.getSelectSameFollowId(followId, true, limit,</span>
<span class="fc" id="L470">                                               &quot;*&quot;.equals(</span>
<span class="fc" id="L471">                                                   checkAuthorizedToSeeAll()));</span>
<span class="fc" id="L472">        final ArrayNode arrayNode = JsonHandler.createArrayNode();</span>
<span class="fc" id="L473">        final LocalTransaction localTransaction =</span>
<span class="fc" id="L474">            Configuration.configuration.getLocalTransaction();</span>
<span class="fc" id="L475">        int nb = 0;</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">        for (final DbTaskRunner runner : dbTaskRunners) {</span>
<span class="fc" id="L477">          final ObjectNode node = runner.getJson();</span>
<span class="fc" id="L478">          node.put(Columns.SPECIALID.name(),</span>
<span class="fc" id="L479">                   Long.toString(runner.getSpecialId()));</span>
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">          if (localTransaction == null) {</span>
<span class="nc" id="L481">            node.put(&quot;Running&quot;, false);</span>
          } else {
<span class="fc" id="L483">            node.put(&quot;Running&quot;, localTransaction.contained(runner.getKey()));</span>
          }
<span class="fc" id="L485">          arrayNode.add(node);</span>
<span class="fc" id="L486">          nb++;</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">          if (nb &gt;= limit) {</span>
<span class="nc" id="L488">            break;</span>
          }
        }
<span class="fc" id="L491">        final String json = WaarpStringUtils.cleanJsonForHtml(</span>
<span class="fc" id="L492">            JsonHandler.writeAsString(arrayNode)</span>
<span class="fc" id="L493">                       .replaceAll(&quot;(\\\&quot;\\{)([^}]+)(\\}\\\&quot;)&quot;, &quot;\&quot;{$2}\&quot;&quot;)</span>
<span class="fc" id="L494">                       .replaceAll(&quot;([^\\\\])(\\\\\&quot;)([a-zA-Z_0-9]+)(\\\\\&quot;)&quot;,</span>
                                   &quot;$1\\\\\&quot;$3\\\\\&quot;&quot;));
<span class="fc" id="L496">        head = head.replace(XXXDATAJSONXXX, json);</span>
<span class="nc" id="L497">      } catch (final WaarpDatabaseNoConnectionException e) {</span>
<span class="nc" id="L498">        logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L499">        errorText +=</span>
<span class="nc" id="L500">            Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() +</span>
            &quot;&lt;BR/&gt;&quot;;
<span class="nc" id="L502">        head = head.replace(XXXRESULTXXX, errorText);</span>
<span class="fc" id="L503">      }</span>
<span class="fc" id="L504">      head =</span>
<span class="fc" id="L505">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
    } else {
<span class="nc" id="L508">      final String startid = getTrimValue(&quot;startid&quot;);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">      final String stopid =</span>
<span class="nc" id="L510">          startid == null? null : Long.toString(Long.parseLong(startid) + 1);</span>
<span class="nc" id="L511">      head =</span>
<span class="nc" id="L512">          setDbTaskRunnerJsonData(head, errorText, startid, stopid, null, null,</span>
                                  null, null, false, false, false, false, true);
<span class="nc bnc" id="L514" title="All 2 branches missed.">      head =</span>
<span class="nc" id="L515">          resetOptionTransfer(head, startid == null? &quot;&quot; : startid, stopid, &quot;&quot;,</span>
                              &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false, false, true);
    }
<span class="fc" id="L518">    return head;</span>
  }

  private String getHeadNoParam(final REQUEST request, final String s) {
<span class="fc" id="L522">    String head = request.read(this);</span>
<span class="fc" id="L523">    head =</span>
<span class="fc" id="L524">        resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                            false, true);
<span class="fc" id="L526">    head = setDbTaskRunnerJsonData(head, s, &quot;&quot;, &quot;&quot;, null, null, &quot;&quot;, &quot;&quot;, false,</span>
                                   false, false, false, true);
<span class="fc" id="L528">    return head.replace(XXXRESULTXXX, &quot;&quot;).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String export() {
<span class="fc" id="L532">    getParamsResponsive();</span>
<span class="fc" id="L533">    String body = REQUEST.Export.read(this);</span>
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">    if (params == null) {</span>
<span class="fc" id="L535">      body =</span>
<span class="fc" id="L536">          resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              true, false);
<span class="fc" id="L538">      return body.replace(XXXRESULTXXX, &quot;&quot;);</span>
    }
<span class="nc" id="L540">    String start = getValue(&quot;start&quot;);</span>
<span class="nc" id="L541">    String stop = getValue(&quot;stop&quot;);</span>
<span class="nc" id="L542">    final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc" id="L543">    final String req = getTrimValue(&quot;req&quot;);</span>
    final boolean pending;
    boolean transfer;
    final boolean error;
    final boolean done;
    boolean all;
<span class="nc" id="L549">    pending = params.containsKey(&quot;pending&quot;);</span>
<span class="nc" id="L550">    transfer = params.containsKey(&quot;transfer&quot;);</span>
<span class="nc" id="L551">    error = params.containsKey(&quot;error&quot;);</span>
<span class="nc" id="L552">    done = params.containsKey(&quot;done&quot;);</span>
<span class="nc" id="L553">    all = params.containsKey(&quot;all&quot;);</span>
<span class="nc" id="L554">    boolean toPurge = params.containsKey(&quot;purge&quot;);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">    if (toPurge) {</span>
<span class="nc" id="L556">      transfer = false;</span>
    }
<span class="nc bnc" id="L558" title="All 8 branches missed.">    if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L559">      all = true;</span>
<span class="nc bnc" id="L560" title="All 8 branches missed.">    } else if (!(pending || transfer || error || done)) {</span>
<span class="nc" id="L561">      all = true;</span>
    }
<span class="nc" id="L563">    final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">    if (tstart != null) {</span>
<span class="nc" id="L565">      start = tstart.toString();</span>
    }
<span class="nc" id="L567">    final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">    if (tstop != null) {</span>
<span class="nc" id="L569">      stop = tstop.toString();</span>
    }
<span class="nc bnc" id="L571" title="All 4 branches missed.">    body =</span>
<span class="nc" id="L572">        resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, start, stop, rule == null? &quot;&quot; : rule,</span>
                            req == null? &quot;&quot; : req, pending, transfer, error,
                            done, all);
<span class="nc" id="L575">    boolean isexported = true;</span>
    // clean a bit the database before exporting
    try {
<span class="nc" id="L578">      DbTaskRunner.changeFinishedToDone();</span>
<span class="nc" id="L579">    } catch (final WaarpDatabaseNoConnectionException e2) {</span>
      // should not be
<span class="nc" id="L581">    }</span>
    // create export of log and optionally purge them from database
<span class="nc" id="L583">    DbPreparedStatement getValid = null;</span>
<span class="nc" id="L584">    NbAndSpecialId nbAndSpecialId = null;</span>
<span class="nc" id="L585">    final String basename =</span>
<span class="nc" id="L586">        Configuration.configuration.getArchivePath() + DirInterface.SEPARATOR +</span>
<span class="nc" id="L587">        Configuration.configuration.getHostId() + '_' +</span>
<span class="nc" id="L588">        System.currentTimeMillis() + &quot;_runners.xml&quot;;</span>
<span class="nc" id="L589">    final String filename =</span>
<span class="nc" id="L590">        Configuration.configuration.getBaseDirectory() + basename;</span>
<span class="nc" id="L591">    String errorMsg = &quot;&quot;;</span>
<span class="nc" id="L592">    final String seeAll = checkAuthorizedToSeeAll();</span>
    try {
<span class="nc" id="L594">      getValid = DbTaskRunner.getFilterPrepareStatement(dbSession, 0,</span>
                                                        // 0 means no limit
                                                        true, null, null,
                                                        tstart, tstop, rule,
                                                        req, pending, transfer,
                                                        error, done, all,
                                                        seeAll);
<span class="nc" id="L601">      nbAndSpecialId = DbTaskRunner.writeXMLWriter(getValid, filename);</span>
<span class="nc" id="L602">    } catch (final WaarpDatabaseNoConnectionException e1) {</span>
<span class="nc" id="L603">      isexported = false;</span>
<span class="nc" id="L604">      toPurge = false;</span>
<span class="nc" id="L605">      logger.warn(&quot;Export error: {}&quot;, e1.getMessage());</span>
<span class="nc" id="L606">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L607">    } catch (final WaarpDatabaseSqlException e1) {</span>
<span class="nc" id="L608">      isexported = false;</span>
<span class="nc" id="L609">      toPurge = false;</span>
<span class="nc" id="L610">      logger.warn(&quot;Export error: {}&quot;, e1.getMessage());</span>
<span class="nc" id="L611">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L612">    } catch (final OpenR66ProtocolBusinessException e) {</span>
<span class="nc" id="L613">      isexported = false;</span>
<span class="nc" id="L614">      toPurge = false;</span>
<span class="nc" id="L615">      logger.warn(&quot;Export error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L616">      errorMsg = e.getMessage();</span>
    } finally {
<span class="nc bnc" id="L618" title="All 2 branches missed.">      if (getValid != null) {</span>
<span class="nc" id="L619">        getValid.realClose();</span>
      }
    }
<span class="nc" id="L622">    int purge = 0;</span>
<span class="nc bnc" id="L623" title="All 4 branches missed.">    if (isexported &amp;&amp; nbAndSpecialId != null) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">      if (nbAndSpecialId.nb &lt;= 0) {</span>
<span class="nc" id="L625">        return body.replace(XXXRESULTXXX, Messages.getString(</span>
            &quot;HttpSslHandler.7&quot;)); //$NON-NLS-1$
      }
      // in case of purge
<span class="nc bnc" id="L629" title="All 4 branches missed.">      if (isexported &amp;&amp; toPurge) {</span>
        // purge with same filter all runners where globallasttep
        // is ALLDONE or ERROR
        // but getting the higher Special first
<span class="nc" id="L633">        final String stopId = Long.toString(nbAndSpecialId.higherSpecialId);</span>
        try {
<span class="nc" id="L635">          purge = DbTaskRunner.purgeLogPrepareStatement(dbSession, null, stopId,</span>
                                                        tstart, tstop, rule,
                                                        req, pending, transfer,
                                                        error, done, all);
<span class="nc" id="L639">        } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
          // nothing
<span class="nc" id="L641">        } catch (final WaarpDatabaseSqlException e) {</span>
<span class="nc" id="L642">          logger.warn(&quot;Purge error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L643">        }</span>
      }
    }
<span class="nc bnc" id="L646" title="All 2 branches missed.">    return body.replace(XXXRESULTXXX, &quot;Export &quot; + (isexported?</span>
<span class="nc" id="L647">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.8&quot;) + //$NON-NLS-2$</span>
        &quot;&lt;A href='&quot; + basename + &quot;' target='_blank'&gt;&quot; + basename + &quot;&lt;/A&gt;&quot; +
<span class="nc bnc" id="L649" title="All 2 branches missed.">        Messages.getString(&quot;HttpSslHandler.9&quot;) //$NON-NLS-4$</span>
        + (nbAndSpecialId != null? nbAndSpecialId.nb : 0) +
<span class="nc" id="L651">        Messages.getString(&quot;HttpSslHandler.10&quot;) + purge</span>
        //$NON-NLS-1$
<span class="nc" id="L653">        + Messages.getString(&quot;HttpSslHandler.11&quot;) + &quot;&lt;/B&gt;&quot; :</span>
        //$NON-NLS-1$
<span class="nc" id="L655">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.12&quot;))) + &quot;&lt;/B&gt;&quot; +</span>
           errorMsg; //$NON-NLS-1$
  }

  private String setCreateTransferJsonData(final String head,
                                           String errorText) {
<span class="fc" id="L661">    String result = head;</span>
    try {
<span class="fc" id="L663">      final DbHostAuth[] dbHostAuths = DbHostAuth.getAllHosts();</span>
<span class="fc" id="L664">      ArrayNode arrayNode = JsonHandler.createArrayNode();</span>
<span class="fc bfc" id="L665" title="All 2 branches covered.">      for (final DbHostAuth dbHostAuth : dbHostAuths) {</span>
<span class="fc" id="L666">        arrayNode.add(dbHostAuth.getHostid());</span>
      }
<span class="fc" id="L668">      result =</span>
<span class="fc" id="L669">          result.replace(XXXHOSTSIDSXXX, JsonHandler.writeAsString(arrayNode));</span>
<span class="fc" id="L670">      final DbRule[] dbRules = DbRule.getAllRules();</span>
<span class="fc" id="L671">      arrayNode = JsonHandler.createArrayNode();</span>
<span class="fc bfc" id="L672" title="All 2 branches covered.">      for (final DbRule dbRule : dbRules) {</span>
<span class="fc" id="L673">        arrayNode.add(dbRule.getIdRule());</span>
      }
<span class="fc" id="L675">      result =</span>
<span class="fc" id="L676">          result.replace(XXXRULEIDSXXX, JsonHandler.writeAsString(arrayNode));</span>
<span class="fc" id="L677">      result = result.replace(XXXBLOCKSIZEXXX,</span>
<span class="fc" id="L678">                              &quot;&quot; + Configuration.configuration.getBlockSize());</span>
      // select only not yet executed transfers
<span class="fc" id="L680">      return setDbTaskRunnerJsonData(result, errorText, &quot;&quot;, &quot;&quot;, null, null, &quot;&quot;,</span>
                                     &quot;&quot;, true, false, false, false, false);
<span class="nc" id="L682">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L683">      logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L684">      errorText +=</span>
<span class="nc" id="L685">          Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() + &quot;&lt;BR/&gt;&quot;;</span>
<span class="nc" id="L686">      return head.replace(XXXRESULTXXX, errorText);</span>
    }
  }

  private String createTransfer() {
<span class="fc" id="L691">    getParamsResponsive();</span>
<span class="fc" id="L692">    String head = REQUEST.CreateTransfer.read(this);</span>
<span class="fc" id="L693">    String errorText = &quot;&quot;;</span>
<span class="fc bfc" id="L694" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L695">      head = setCreateTransferJsonData(head, errorText);</span>
<span class="fc" id="L696">      return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L697">                 .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
    }
<span class="fc" id="L699">    final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L701">      final String parm = parms.get(0);</span>
<span class="fc" id="L702">      final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L703">      final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L704">      final String filename = getTrimValue(&quot;filename&quot;);</span>
<span class="fc" id="L705">      String transferinfo = getTrimValue(&quot;transferinfo&quot;);</span>
<span class="fc" id="L706">      final String startdate = getTrimValue(&quot;startdate&quot;);</span>
<span class="fc" id="L707">      final String blocksize = getTrimValue(&quot;blocksize&quot;);</span>
<span class="fc" id="L708">      final String followid = getTrimValue(&quot;followid&quot;);</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">      if (transferinfo == null) {</span>
<span class="nc" id="L710">        transferinfo = &quot;&quot;;</span>
      }
<span class="fc" id="L712">      String actionError = &quot;&quot;;</span>
<span class="fc" id="L713">      int iaction = 0;</span>
<span class="fc bfc" id="L714" title="All 2 branches covered.">      if (&quot;Create&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L715">        iaction = 1;</span>
<span class="fc" id="L716">        actionError = Messages.getString(</span>
            &quot;HttpSslHandler.CannotCreateTransfer&quot;);//$NON-NLS-1$
<span class="pc bpc" id="L718" title="1 of 2 branches missed.">      } else if (&quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L719">        iaction = 2;</span>
<span class="fc" id="L720">        actionError = Messages.getString(</span>
            &quot;HttpSslHandler.CannotUpdateTransfer&quot;);//$NON-NLS-1$
      }
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">      if (iaction &gt; 0) {</span>
<span class="fc" id="L724">        int iblocksize = Configuration.configuration.getBlockSize();</span>
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">        if (blocksize != null) {</span>
          try {
<span class="fc" id="L727">            iblocksize = Integer.parseInt(blocksize);</span>
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">            if (iblocksize &gt; Configuration.configuration.getBlockSize()) {</span>
<span class="nc" id="L729">              iblocksize = Configuration.configuration.getBlockSize();</span>
            }
<span class="fc" id="L731">          } catch (final NumberFormatException e1) {</span>
<span class="fc" id="L732">            errorText =</span>
<span class="fc" id="L733">                actionError + e1.getMessage() + B_CENTER_P2; //$NON-NLS-1$</span>
<span class="fc" id="L734">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="fc" id="L735">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L736">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L737">          }</span>
        }
<span class="fc" id="L739">        long lfollowId = Long.MIN_VALUE;</span>
<span class="pc bpc" id="L740" title="1 of 2 branches missed.">        if (followid != null) {</span>
          try {
<span class="fc" id="L742">            lfollowId = Long.parseLong(followid);</span>
<span class="nc" id="L743">          } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L744">            errorText =</span>
<span class="nc" id="L745">                actionError + e1.getMessage() + B_CENTER_P2; //$NON-NLS-1$</span>
<span class="nc" id="L746">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L747">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L748">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L749">          }</span>
        }
<span class="fc" id="L751">        DateTime dateTime = null;</span>
<span class="fc bfc" id="L752" title="All 2 branches covered.">        if (startdate != null) {</span>
<span class="fc" id="L753">          final DateTimeFormatter formatter =</span>
<span class="fc" id="L754">              DateTimeFormat.forPattern(&quot;yyyy/MM/dd HH:mm&quot;);</span>
          try {
<span class="fc" id="L756">            dateTime = formatter.parseDateTime(startdate);</span>
<span class="nc" id="L757">          } catch (final Exception e) {</span>
<span class="nc" id="L758">            errorText =</span>
<span class="nc" id="L759">                actionError + e.getMessage() + B_CENTER_P2; //$NON-NLS-1$</span>
<span class="nc" id="L760">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L761">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L762">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L763">          }</span>
        }
<span class="fc bfc" id="L765" title="All 2 branches covered.">        if (iaction == 1) {</span>
<span class="pc bpc" id="L766" title="1 of 2 branches missed.">          if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L767">            final Set&lt;Entry&lt;String, List&lt;String&gt;&gt;&gt; entries = params.entrySet();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">            for (final Entry&lt;String, List&lt;String&gt;&gt; entry : entries) {</span>
<span class="nc" id="L769">              String vals = &quot;&quot;;</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">              for (final String val : entry.getValue()) {</span>
<span class="nc" id="L771">                vals += val + &quot;;&quot;;</span>
<span class="nc" id="L772">              }</span>
<span class="nc" id="L773">              logger.debug(&quot;CREATE {} = {}&quot;, entry.getKey(), vals);</span>
<span class="nc" id="L774">            }</span>
          }
          // Create Runner
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">          if (ParametersChecker.isEmpty(host, rule, filename)) {</span>
<span class="nc" id="L778">            errorText = actionError; //$NON-NLS-1$</span>
<span class="nc" id="L779">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L780">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L781">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
          }
          try {
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">            if (followid != null) {</span>
<span class="fc" id="L785">              final Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L786">              map.put(FOLLOW_JSON_KEY, lfollowId);</span>
<span class="fc" id="L787">              transferinfo += &quot; &quot; + JsonHandler.writeAsStringEscaped(map);</span>
            }
<span class="fc" id="L789">            final R66Future future = new R66Future(true);</span>
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">            final SubmitTransfer submitTransfer =</span>
                new SubmitTransfer(future, host, filename, rule, transferinfo,
                                   true, iblocksize, DbConstantR66.ILLEGALVALUE,
                                   dateTime != null?
<span class="pc" id="L794">                                       new Timestamp(dateTime.getMillis()) :</span>
                                       null);
<span class="fc" id="L796">            submitTransfer.setNormalInfoAsWarn(false);</span>
<span class="fc" id="L797">            submitTransfer.run();</span>
<span class="fc" id="L798">            future.awaitOrInterruptible();</span>
<span class="fc" id="L799">            final OutputFormat outputFormat =</span>
<span class="fc" id="L800">                new OutputFormat(SubmitTransfer.class.getSimpleName(), null);</span>
<span class="fc" id="L801">            final DbTaskRunner runner = future.getResult().getRunner();</span>
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">            if (future.isSuccess()) {</span>
<span class="fc" id="L803">              SubmitTransfer.prepareSubmitOkOutputFormat(runner, outputFormat);</span>
            } else {
<span class="nc" id="L805">              SubmitTransfer.prepareSubmitKoOutputFormat(future, runner,</span>
                                                         outputFormat);
            }
<span class="fc" id="L808">            errorText = outputFormat.loggerOut();</span>
<span class="fc" id="L809">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="fc" id="L810">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L811">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L812">          } catch (final Exception e) {</span>
<span class="nc" id="L813">            logger.error(&quot;Create TaskRunner in error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L814">            errorText = actionError + e.getMessage()</span>
                        //$NON-NLS-1$
                        + B_CENTER_P2;
<span class="nc" id="L817">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L818">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L819">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
          }
<span class="pc bpc" id="L821" title="1 of 2 branches missed.">        } else if (iaction == 2) {</span>
<span class="pc bpc" id="L822" title="1 of 2 branches missed.">          if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L823">            final Set&lt;Entry&lt;String, List&lt;String&gt;&gt;&gt; entries = params.entrySet();</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">            for (final Entry&lt;String, List&lt;String&gt;&gt; entry : entries) {</span>
<span class="nc" id="L825">              String vals = &quot;&quot;;</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">              for (final String val : entry.getValue()) {</span>
<span class="nc" id="L827">                vals += val + &quot;;&quot;;</span>
<span class="nc" id="L828">              }</span>
<span class="nc" id="L829">              logger.debug(&quot;UPDATE {} = {}&quot;, entry.getKey(), vals);</span>
<span class="nc" id="L830">            }</span>
          }
<span class="fc" id="L832">          final String owner = getTrimValue(&quot;OWNERREQ&quot;);</span>
<span class="fc" id="L833">          final String requester = getTrimValue(&quot;REQUESTER&quot;);</span>
<span class="fc" id="L834">          final String requested = getTrimValue(&quot;REQUESTED&quot;);</span>
<span class="fc" id="L835">          final String specialId = getTrimValue(&quot;SPECIALID&quot;);</span>
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">          if (ParametersChecker.isEmpty(rule, filename, owner, requested,</span>
                                        requester, specialId)) {
<span class="nc" id="L838">            logger.debug(&quot;Some Fields are null: {} {} {} {} {} {}&quot;, rule,</span>
                         filename, owner, requested, requester, specialId);
<span class="nc" id="L840">            errorText = actionError + &quot; some arguments are empty&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L841">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L842">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L843">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
          }
          // Try to update
          try {
<span class="fc" id="L847">            final long lspecialId = Long.parseLong(specialId);</span>
<span class="fc" id="L848">            logger.debug(&quot;Search for: {} {} {} {}&quot;, lspecialId, owner,</span>
                         requester, requested);
<span class="fc" id="L850">            final DbTaskRunner runner =</span>
                new DbTaskRunner(lspecialId, requester, requested, owner);
<span class="pc bpc" id="L852" title="3 of 4 branches missed.">            if (ParametersChecker.isNotEmpty(host) &amp;&amp; !requested.equals(host)) {</span>
<span class="nc" id="L853">              errorText = actionError + &quot; Requested Host cannot be changed&quot;</span>
                          //$NON-NLS-1$
                          + B_CENTER_P2;
<span class="nc" id="L856">              head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L857">              return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L858">                         .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
            }
<span class="pc bpc" id="L860" title="1 of 2 branches missed.">            if (ParametersChecker.isNotEmpty(rule) &amp;&amp;</span>
<span class="pc bpc" id="L861" title="1 of 2 branches missed.">                !runner.getRuleId().equals(rule)) {</span>
<span class="nc" id="L862">              runner.setRuleId(rule);</span>
            }
<span class="pc bpc" id="L864" title="1 of 2 branches missed.">            if (ParametersChecker.isNotEmpty(filename) &amp;&amp;</span>
<span class="pc bpc" id="L865" title="1 of 2 branches missed.">                !runner.getFilename().equals(filename)) {</span>
<span class="nc" id="L866">              runner.setFilename(filename);</span>
<span class="nc" id="L867">              runner.setOriginalFilename(filename);</span>
            }
<span class="pc bpc" id="L869" title="1 of 2 branches missed.">            if (dateTime != null &amp;&amp;</span>
<span class="pc bpc" id="L870" title="1 of 2 branches missed.">                !dateTime.isEqual(runner.getStart().getTime())) {</span>
<span class="fc" id="L871">              runner.setStart(new Timestamp(dateTime.getMillis()));</span>
            }
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">            if (runner.getBlocksize() != iblocksize) {</span>
<span class="nc" id="L874">              runner.setBlocksize(iblocksize);</span>
            }
<span class="pc bpc" id="L876" title="1 of 2 branches missed.">            if (followid != null &amp;&amp;</span>
<span class="pc bpc" id="L877" title="1 of 2 branches missed.">                !followid.trim().equals(runner.getFollowId())) {</span>
<span class="fc" id="L878">              final Map&lt;String, Object&gt; map =</span>
<span class="fc" id="L879">                  DbTaskRunner.getMapFromString(transferinfo);</span>
<span class="fc" id="L880">              String outOfMap =</span>
<span class="fc" id="L881">                  DbTaskRunner.getOutOfMapFromString(transferinfo);</span>
<span class="fc" id="L882">              map.put(FOLLOW_JSON_KEY, lfollowId);</span>
<span class="fc" id="L883">              outOfMap += &quot; &quot; + JsonHandler.writeAsStringEscaped(map);</span>
<span class="fc" id="L884">              transferinfo = outOfMap;</span>
<span class="fc" id="L885">              runner.setFileInformation(transferinfo);</span>
<span class="fc" id="L886">              runner.setFollowId(lfollowId);</span>
<span class="fc" id="L887">            } else {</span>
<span class="nc" id="L888">              runner.setFileInformation(transferinfo);</span>
            }
<span class="fc" id="L890">            runner.changeUpdatedInfo(UpdatedInfo.TOSUBMIT);</span>
<span class="fc" id="L891">            runner.update();</span>
<span class="fc" id="L892">            final OutputFormat outputFormat =</span>
<span class="fc" id="L893">                new OutputFormat(SubmitTransfer.class.getSimpleName(), null);</span>
<span class="fc" id="L894">            SubmitTransfer.prepareSubmitOkOutputFormat(runner, outputFormat);</span>
<span class="fc" id="L895">            errorText = outputFormat.loggerOut();</span>
<span class="fc" id="L896">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="fc" id="L897">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L898">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L899">          } catch (final Exception e) {</span>
<span class="nc" id="L900">            errorText = actionError + e.getMessage()</span>
                        //$NON-NLS-1$
                        + B_CENTER_P2;
<span class="nc" id="L903">            logger.error(&quot;Update TaskRunner in error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L904">            head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L905">            return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L906">                       .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
          }
        }
      }
    }
<span class="nc" id="L911">    head = setCreateTransferJsonData(head, errorText);</span>
<span class="nc" id="L912">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String setDbHostAuthJsonData(final String head, String errorText,
                                       final String host, final String addr,
                                       final boolean ssl,
                                       final boolean isactive) {
<span class="fc" id="L919">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L921">      preparedStatement =</span>
<span class="fc" id="L922">          DbHostAuth.getFilterPrepareStament(dbSession, host, addr, ssl,</span>
                                             isactive);
<span class="fc" id="L924">      final String json = DbHostAuth.getJson(preparedStatement, getLimitRow());</span>
<span class="fc" id="L925">      return head.replace(XXXDATAJSONXXX, json);</span>
<span class="nc" id="L926">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L928">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L930">      logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L931">      errorText +=</span>
<span class="nc" id="L932">          Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() + &quot;&lt;BR/&gt;&quot;;</span>
    }
<span class="nc" id="L934">    return head.replace(XXXRESULTXXX, errorText);</span>
  }

  private String hosts() {
<span class="fc" id="L938">    getParamsResponsive();</span>
<span class="fc" id="L939">    String head = REQUEST.Hosts.read(this);</span>
<span class="fc" id="L940">    String errorText = &quot;&quot;;</span>
<span class="fc bfc" id="L941" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L942">      head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="fc" id="L943">      head = setDbHostAuthJsonData(head, errorText, null, null, false, true);</span>
<span class="fc" id="L944">      return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L945">                 .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
    }
<span class="fc" id="L947">    final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L949">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">      if (&quot;Create&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L951">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L952">        String addr = getTrimValue(&quot;address&quot;);</span>
<span class="fc" id="L953">        String port = getTrimValue(&quot;port&quot;);</span>
<span class="fc" id="L954">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        final boolean ssl;
        final boolean admin;
        boolean isclient;
        final boolean isactive;
        final boolean isproxified;
<span class="fc" id="L960">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L961">        admin = params.containsKey(&quot;admin&quot;);</span>
<span class="fc" id="L962">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="fc" id="L963">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="fc" id="L964">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="pc bpc" id="L965" title="1 of 2 branches missed.">        if (port == null) {</span>
<span class="nc" id="L966">          port = &quot;-1&quot;;</span>
        }
<span class="pc bpc" id="L968" title="1 of 2 branches missed.">        if (&quot;-1&quot;.equals(port)) {</span>
<span class="fc" id="L969">          isclient = true;</span>
        }
<span class="pc bpc" id="L971" title="2 of 4 branches missed.">        if (isclient &amp;&amp; addr == null) {</span>
<span class="nc" id="L972">          addr = &quot;0.0.0.0&quot;;</span>
        }
<span class="pc bpc" id="L974" title="3 of 6 branches missed.">        if (host == null || addr == null || key == null) {</span>
<span class="nc" id="L975">          errorText = Messages.getString(&quot;HttpSslHandler.13&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L976">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L977">          head = setDbHostAuthJsonData(head, errorText, null, null, ssl, true);</span>
<span class="nc" id="L978">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L979">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
<span class="fc" id="L981">        int iport = -1;</span>
        try {
<span class="fc" id="L983">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L984">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L985">          errorText =</span>
<span class="nc" id="L986">              Messages.getString(&quot;HttpSslHandler.14&quot;) + e1.getMessage() +</span>
              B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L988">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L989">          head = setDbHostAuthJsonData(head, errorText, null, null, ssl, true);</span>
<span class="nc" id="L990">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L991">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L992">        }</span>
        final DbHostAuth dbhost;
        try {
<span class="fc" id="L995">          dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="fc" id="L996">                                  key.getBytes(WaarpStringUtils.UTF8), admin,</span>
                                  isclient);
<span class="fc" id="L998">          dbhost.setActive(isactive);</span>
<span class="fc" id="L999">          dbhost.setProxified(isproxified);</span>
<span class="fc" id="L1000">          dbhost.insert();</span>
<span class="nc" id="L1001">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1002">          errorText = Messages.getString(&quot;HttpSslHandler.14&quot;) + e.getMessage()</span>
                      //$NON-NLS-1$
                      + B_CENTER_P2;
<span class="nc" id="L1005">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1006">          head = setDbHostAuthJsonData(head, errorText, null, null, ssl, true);</span>
<span class="nc" id="L1007">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1008">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L1009">        }</span>
<span class="fc" id="L1010">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="fc" id="L1011">        final String json = dbhost.getJsonAsString();</span>
<span class="fc" id="L1012">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="fc bfc" id="L1013" title="All 2 branches covered.">      } else if (FILTER2.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1014">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1015">        final String addr = getTrimValue(&quot;address&quot;);</span>
<span class="fc" id="L1016">        final boolean ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1017">        final boolean isactive = params.containsKey(&quot;active&quot;);</span>
<span class="pc bpc" id="L1018" title="2 of 4 branches missed.">        head = resetOptionHosts(head, host == null? &quot;&quot; : host,</span>
                                addr == null? &quot;&quot; : addr, ssl, isactive);
<span class="fc" id="L1020">        head =</span>
<span class="fc" id="L1021">            setDbHostAuthJsonData(head, errorText, host, addr, ssl, isactive);</span>
<span class="pc bpc" id="L1022" title="1 of 2 branches missed.">      } else if (&quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1023">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1024">        final String addr = getTrimValue(&quot;address&quot;);</span>
<span class="fc" id="L1025">        final String port = getTrimValue(&quot;port&quot;);</span>
<span class="fc" id="L1026">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        final boolean ssl;
        final boolean admin;
        final boolean isclient;
        final boolean isactive;
        final boolean isproxified;
<span class="fc" id="L1032">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1033">        admin = params.containsKey(&quot;admin&quot;);</span>
<span class="fc" id="L1034">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="fc" id="L1035">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="fc" id="L1036">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="pc bpc" id="L1037" title="4 of 8 branches missed.">        if (host == null || addr == null || port == null || key == null) {</span>
<span class="nc" id="L1038">          errorText = Messages.getString(&quot;HttpSslHandler.15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1039">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1040">          head =</span>
<span class="nc" id="L1041">              setDbHostAuthJsonData(head, errorText, host, addr, ssl, isactive);</span>
<span class="nc" id="L1042">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1043">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        final int iport;
        try {
<span class="fc" id="L1047">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L1048">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1049">          errorText =</span>
<span class="nc" id="L1050">              Messages.getString(&quot;HttpSslHandler.16&quot;) + e1.getMessage() +</span>
              B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1052">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1053">          head =</span>
<span class="nc" id="L1054">              setDbHostAuthJsonData(head, errorText, host, addr, ssl, isactive);</span>
<span class="nc" id="L1055">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1056">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L1057">        }</span>
        final DbHostAuth dbhost;
        try {
<span class="fc" id="L1060">          dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="fc" id="L1061">                                  key.getBytes(WaarpStringUtils.UTF8), admin,</span>
                                  isclient);
<span class="fc" id="L1063">          dbhost.setActive(isactive);</span>
<span class="fc" id="L1064">          dbhost.setProxified(isproxified);</span>
<span class="pc bpc" id="L1065" title="1 of 2 branches missed.">          if (dbhost.exist()) {</span>
<span class="fc" id="L1066">            dbhost.update();</span>
          } else {
<span class="nc" id="L1068">            dbhost.insert();</span>
          }
<span class="nc" id="L1070">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1071">          errorText = Messages.getString(&quot;HttpSslHandler.16&quot;) + e.getMessage() +</span>
                      B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1073">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1074">          head =</span>
<span class="nc" id="L1075">              setDbHostAuthJsonData(head, errorText, host, addr, ssl, isactive);</span>
<span class="nc" id="L1076">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1077">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L1078">        }</span>
<span class="fc" id="L1079">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="fc" id="L1080">        final String json = dbhost.getJsonAsString();</span>
<span class="fc" id="L1081">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="pc bnc" id="L1082" title="All 2 branches missed.">      } else if (&quot;TestConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1083">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">        if (ParametersChecker.isEmpty(host)) {</span>
<span class="nc" id="L1085">          errorText = Messages.getString(&quot;HttpSslHandler.17&quot;) + B_CENTER_P2;</span>
<span class="nc" id="L1086">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1087">          head =</span>
<span class="nc" id="L1088">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1089">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1090">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="nc" id="L1094">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1095">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1096">          errorText = Messages.getString(&quot;HttpSslHandler.17&quot;) + e.getMessage() +</span>
                      B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1098">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1099">          head =</span>
<span class="nc" id="L1100">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1101">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1102">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1103">        }</span>
<span class="nc" id="L1104">        final R66Future result = new R66Future(true);</span>
<span class="nc" id="L1105">        final TestPacket packet = new TestPacket(&quot;MSG&quot;, &quot;CheckConnection&quot;, 100);</span>
<span class="nc" id="L1106">        final Message transaction = new Message(</span>
<span class="nc" id="L1107">            Configuration.configuration.getInternalRunner()</span>
<span class="nc" id="L1108">                                       .getNetworkTransaction(), result, dbhost,</span>
            packet);
<span class="nc" id="L1110">        transaction.run();</span>
<span class="nc" id="L1111">        result.awaitOrInterruptible();</span>
<span class="nc" id="L1112">        head =</span>
<span class="nc" id="L1113">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc" id="L1114">        final String json = dbhost.getJsonAsString();</span>
<span class="nc" id="L1115">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (result.isSuccess()) {</span>
<span class="nc" id="L1117">          errorText = Messages.getString(&quot;HttpSslHandler.18&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1119">          errorText = Messages.getString(&quot;HttpSslHandler.19&quot;)</span>
                      //$NON-NLS-1$
<span class="nc" id="L1121">                      + result.getResult().getCode().getMesg() + B_CENTER_P2;</span>
        }
<span class="nc bnc" id="L1123" title="All 2 branches missed.">      } else if (&quot;CloseConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1124">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        if (ParametersChecker.isEmpty(host)) {</span>
<span class="nc" id="L1126">          errorText = Messages.getString(&quot;HttpSslHandler.17&quot;) + B_CENTER_P2;</span>
<span class="nc" id="L1127">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1128">          head =</span>
<span class="nc" id="L1129">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1130">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1131">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="nc" id="L1135">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1136">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1137">          errorText = Messages.getString(&quot;HttpSslHandler.17&quot;) + e.getMessage() +</span>
                      B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1139">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1140">          head =</span>
<span class="nc" id="L1141">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1142">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1143">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1144">        }</span>
<span class="nc" id="L1145">        final boolean resultShutDown =</span>
<span class="nc" id="L1146">            NetworkTransaction.shuttingdownNetworkChannelsPerHostID(</span>
<span class="nc" id="L1147">                dbhost.getHostid());</span>
<span class="nc" id="L1148">        head =</span>
<span class="nc" id="L1149">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc" id="L1150">        final String json = dbhost.getJsonAsString();</span>
<span class="nc" id="L1151">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">        if (resultShutDown) {</span>
<span class="nc" id="L1153">          errorText = Messages.getString(&quot;HttpSslHandler.21&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1155">          errorText = Messages.getString(&quot;HttpSslHandler.22&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1157" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1158">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">        if (ParametersChecker.isEmpty(host)) {</span>
<span class="nc" id="L1160">          errorText = Messages.getString(&quot;HttpSslHandler.23&quot;) + B_CENTER_P2;</span>
<span class="nc" id="L1161">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1162">          head =</span>
<span class="nc" id="L1163">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1164">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1165">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="nc" id="L1169">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1170">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1171">          errorText = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage() +</span>
                      B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1173">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1174">          head =</span>
<span class="nc" id="L1175">              setDbHostAuthJsonData(head, errorText, host, null, false, true);</span>
<span class="nc" id="L1176">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1177">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1178">        }</span>
        try {
<span class="nc" id="L1180">          dbhost.delete();</span>
<span class="nc" id="L1181">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1182">          errorText = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage() +</span>
                      B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1184">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1185">          head =</span>
<span class="nc" id="L1186">              setDbHostAuthJsonData(head, errorText, host, null, dbhost.isSsl(),</span>
<span class="nc" id="L1187">                                    dbhost.isActive());</span>
<span class="nc" id="L1188">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1189">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1190">        }</span>
<span class="nc" id="L1191">        final String json = dbhost.getJsonAsString();</span>
<span class="nc" id="L1192">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="nc" id="L1193">        errorText = Messages.getString(&quot;HttpSslHandler.25&quot;) + host +</span>
                    B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1195">        head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, dbhost.isActive());</span>
<span class="nc" id="L1196">        return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1197">                   .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
      }
    }
<span class="fc" id="L1200">    head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="fc" id="L1201">    head = setDbHostAuthJsonData(head, errorText, null, null, false, true);</span>
<span class="fc" id="L1202">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private void createExport(final HashMap&lt;String, String&gt; rules,
                            final String rule, final int mode,
                            final int limit) {
<span class="fc" id="L1208">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L1210">      preparedStatement = DbRule.getFilterPrepareStament(dbSession, rule, mode);</span>
<span class="fc" id="L1211">      preparedStatement.executeQuery();</span>
<span class="fc" id="L1212">      int i = 0;</span>
<span class="fc bfc" id="L1213" title="All 2 branches covered.">      while (preparedStatement.getNext()) {</span>
<span class="fc" id="L1214">        final DbRule dbrule = DbRule.getFromStatement(preparedStatement);</span>
<span class="fc" id="L1215">        rules.put(dbrule.getIdRule(), dbrule.getJsonAsString());</span>
<span class="fc" id="L1216">        i++;</span>
<span class="pc bpc" id="L1217" title="1 of 2 branches missed.">        if (i &gt; limit) {</span>
<span class="nc" id="L1218">          break;</span>
        }
<span class="fc" id="L1220">      }</span>
<span class="fc" id="L1221">      preparedStatement.realClose();</span>
<span class="nc" id="L1222">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L1224">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L1226">      logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="fc" id="L1227">    }</span>
<span class="fc" id="L1228">  }</span>

  private String createExport(final String head, String errorText,
                              final String rule) {
<span class="fc" id="L1232">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L1234">      preparedStatement = DbRule.getFilterPrepareStament(dbSession, rule, -1);</span>
<span class="fc" id="L1235">      final String json = DbRule.getJson(preparedStatement, getLimitRow());</span>
<span class="fc" id="L1236">      preparedStatement.realClose();</span>
<span class="fc" id="L1237">      return head.replace(XXXDATAJSONXXX, json);</span>
<span class="nc" id="L1238">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L1240">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L1242">      logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L1243">      errorText +=</span>
<span class="nc" id="L1244">          Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() + &quot;&lt;BR/&gt;&quot;;</span>
    }
<span class="nc" id="L1246">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String rules() {
<span class="fc" id="L1250">    getParamsResponsive();</span>
<span class="fc" id="L1251">    String head = REQUEST.Rules.read(this);</span>
<span class="fc" id="L1252">    final StringBuilder builderHead = new StringBuilder(head);</span>
<span class="fc" id="L1253">    fillHostIds(builderHead);</span>
<span class="fc" id="L1254">    head = builderHead.toString();</span>
<span class="fc" id="L1255">    String errorText = &quot;&quot;;</span>
<span class="fc bfc" id="L1256" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1257">      head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="fc" id="L1258">      head = createExport(head, errorText, null);</span>
<span class="fc" id="L1259">      return head.replace(XXXRESULTXXX, errorText)</span>
<span class="fc" id="L1260">                 .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
    }
<span class="fc" id="L1262">    final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="pc bpc" id="L1263" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L1264">      final String parm = parms.get(0);</span>
<span class="pc bpc" id="L1265" title="1 of 4 branches missed.">      if (&quot;Create&quot;.equalsIgnoreCase(parm) || &quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1266">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L1267">        final String hostids = getTrimValue(&quot;hostids&quot;);</span>
<span class="fc" id="L1268">        final String recvp = getTrimValue(&quot;recvp&quot;);</span>
<span class="fc" id="L1269">        final String sendp = getTrimValue(&quot;sendp&quot;);</span>
<span class="fc" id="L1270">        final String archp = getTrimValue(&quot;archp&quot;);</span>
<span class="fc" id="L1271">        final String workp = getTrimValue(&quot;workp&quot;);</span>
<span class="fc" id="L1272">        final String rpre = getTrimValue(&quot;rpre&quot;);</span>
<span class="fc" id="L1273">        final String rpost = getTrimValue(&quot;rpost&quot;);</span>
<span class="fc" id="L1274">        final String rerr = getTrimValue(&quot;rerr&quot;);</span>
<span class="fc" id="L1275">        final String spre = getTrimValue(&quot;spre&quot;);</span>
<span class="fc" id="L1276">        final String spost = getTrimValue(&quot;spost&quot;);</span>
<span class="fc" id="L1277">        final String serr = getTrimValue(&quot;serr&quot;);</span>
<span class="fc" id="L1278">        final String mode = getTrimValue(&quot;mode&quot;);</span>
<span class="pc bpc" id="L1279" title="2 of 4 branches missed.">        if (rule == null || mode == null) {</span>
<span class="nc" id="L1280">          errorText = Messages.getString(&quot;HttpSslHandler.26&quot;) + parm +</span>
<span class="nc" id="L1281">                      Messages.getString(</span>
                          &quot;HttpSslHandler.27&quot;); //$NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L1283">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1284">          head = createExport(head, errorText, null);</span>
<span class="nc" id="L1285">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1286">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
<span class="fc" id="L1288">        int gmode = 0;</span>

<span class="fc" id="L1290">        TRANSFERMODE tmode = null;</span>
<span class="pc bpc" id="L1291" title="1 of 2 branches missed.">        if (&quot;send&quot;.equals(mode)) {</span>
<span class="fc" id="L1292">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="fc" id="L1293">          gmode = -2;</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">        } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1295">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc" id="L1296">          gmode = -1;</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        } else if (&quot;sendmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1298">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="nc" id="L1299">          gmode = -2;</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">        } else if (&quot;recvmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1301">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc" id="L1302">          gmode = -1;</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">        } else if (&quot;sendth&quot;.equals(mode)) {</span>
<span class="nc" id="L1304">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc" id="L1305">          gmode = -2;</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">        } else if (&quot;recvth&quot;.equals(mode)) {</span>
<span class="nc" id="L1307">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc" id="L1308">          gmode = -1;</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        } else if (&quot;sendthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1310">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc" id="L1311">          gmode = -2;</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        } else if (&quot;recvthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1313">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc" id="L1314">          gmode = -1;</span>
        }
<span class="fc" id="L1316">        head = resetOptionRules(head, rule, tmode, gmode);</span>
<span class="pc bpc" id="L1317" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">          logger.debug(&quot;Recv UpdOrInsert: &quot; + rule + ':' + hostids + ':' +</span>
<span class="nc" id="L1319">                       (tmode != null? tmode.ordinal() : 0) + ':' + recvp +</span>
                       ':' + sendp + ':' + archp + ':' + workp + ':' + rpre +
                       ':' + rpost + ':' + rerr + ':' + spre + ':' + spost +
                       ':' + serr);
        }
        final DbRule dbrule;
        try {
<span class="pc bpc" id="L1326" title="1 of 2 branches missed.">          dbrule =</span>
<span class="pc" id="L1327">              new DbRule(rule, hostids, (tmode != null? tmode.ordinal() : 0),</span>
                         recvp, sendp, archp, workp, rpre, rpost, rerr, spre,
                         spost, serr);
<span class="pc bpc" id="L1330" title="1 of 2 branches missed.">          if (&quot;Create&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1331">            dbrule.insert();</span>
          } else {
<span class="pc bpc" id="L1333" title="1 of 2 branches missed.">            if (dbrule.exist()) {</span>
<span class="fc" id="L1334">              dbrule.update();</span>
            } else {
<span class="nc" id="L1336">              dbrule.insert();</span>
            }
          }
<span class="nc" id="L1339">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1340">          errorText = Messages.getString(&quot;HttpSslHandler.28&quot;) + e.getMessage()</span>
                      //$NON-NLS-1$
                      + B_CENTER_P2;
<span class="nc" id="L1343">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1344">          head = createExport(head, errorText, null);</span>
<span class="nc" id="L1345">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1346">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="fc" id="L1347">        }</span>
<span class="fc" id="L1348">        final String json = dbrule.getJsonAsString();</span>
<span class="fc" id="L1349">        head = head.replace(XXXDATAJSONXXX, '[' + json + ']');</span>
<span class="pc bpc" id="L1350" title="1 of 2 branches missed.">      } else if (FILTER2.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1351">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L1352">        final String mode = getTrimValue(&quot;mode&quot;);</span>
        TRANSFERMODE tmode;
<span class="fc" id="L1354">        int gmode = 0;</span>
<span class="pc bpc" id="L1355" title="1 of 2 branches missed.">        if (mode != null) {</span>
<span class="pc bpc" id="L1356" title="1 of 2 branches missed.">          if (&quot;all&quot;.equals(mode)) {</span>
<span class="fc" id="L1357">            gmode = -3;</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">          } else if (&quot;send&quot;.equals(mode)) {</span>
<span class="nc" id="L1359">            gmode = -2;</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">          } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1361">            gmode = -1;</span>
          }
        }
<span class="pc bpc" id="L1364" title="1 of 2 branches missed.">        head = resetOptionRules(head, rule == null? &quot;&quot; : rule, null, gmode);</span>
<span class="fc" id="L1365">        final HashMap&lt;String, String&gt; rules = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L1366">        boolean specific = false;</span>
<span class="pc bpc" id="L1367" title="1 of 2 branches missed.">        if (params.containsKey(&quot;send&quot;)) {</span>
<span class="nc" id="L1368">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1370">          specific = true;</span>
<span class="nc" id="L1371">          createExport(rules, rule,</span>
<span class="nc" id="L1372">                       RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1373">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1375" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recv&quot;)) {</span>
<span class="nc" id="L1376">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1378">          specific = true;</span>
<span class="nc" id="L1379">          createExport(rules, rule,</span>
<span class="nc" id="L1380">                       RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1381">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1383" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendmd5&quot;)) {</span>
<span class="nc" id="L1384">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="nc bnc" id="L1385" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1386">          specific = true;</span>
<span class="nc" id="L1387">          createExport(rules, rule,</span>
<span class="nc" id="L1388">                       RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1389">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1391" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvmd5&quot;)) {</span>
<span class="nc" id="L1392">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1394">          specific = true;</span>
<span class="nc" id="L1395">          createExport(rules, rule,</span>
<span class="nc" id="L1396">                       RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1397">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1399" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendth&quot;)) {</span>
<span class="nc" id="L1400">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1402">          specific = true;</span>
<span class="nc" id="L1403">          createExport(rules, rule,</span>
<span class="nc" id="L1404">                       RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1405">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1407" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvth&quot;)) {</span>
<span class="nc" id="L1408">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1410">          specific = true;</span>
<span class="nc" id="L1411">          createExport(rules, rule,</span>
<span class="nc" id="L1412">                       RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1413">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1415" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendthmd5&quot;)) {</span>
<span class="nc" id="L1416">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1417" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1418">          specific = true;</span>
<span class="nc" id="L1419">          createExport(rules, rule,</span>
<span class="nc" id="L1420">                       RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1421">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1423" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvthmd5&quot;)) {</span>
<span class="nc" id="L1424">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1426">          specific = true;</span>
<span class="nc" id="L1427">          createExport(rules, rule,</span>
<span class="nc" id="L1428">                       RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1429">                       getLimitRow() / 2);</span>
        }
<span class="pc bpc" id="L1431" title="1 of 2 branches missed.">        if (!specific) {</span>
<span class="pc bpc" id="L1432" title="1 of 2 branches missed.">          if (gmode == -1) {</span>
            // recv
<span class="nc" id="L1434">            createExport(rules, rule,</span>
<span class="nc" id="L1435">                         RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1436">                         getLimitRow() / 2);</span>
<span class="nc" id="L1437">            createExport(rules, rule,</span>
<span class="nc" id="L1438">                         RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1439">                         getLimitRow() / 2);</span>
<span class="nc" id="L1440">            createExport(rules, rule,</span>
<span class="nc" id="L1441">                         RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1442">                         getLimitRow() / 2);</span>
<span class="nc" id="L1443">            createExport(rules, rule,</span>
<span class="nc" id="L1444">                         RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1445">                         getLimitRow() / 2);</span>
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">          } else if (gmode == -2) {</span>
            // send
<span class="nc" id="L1448">            createExport(rules, rule,</span>
<span class="nc" id="L1449">                         RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1450">                         getLimitRow() / 2);</span>
<span class="nc" id="L1451">            createExport(rules, rule,</span>
<span class="nc" id="L1452">                         RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1453">                         getLimitRow() / 2);</span>
<span class="nc" id="L1454">            createExport(rules, rule,</span>
<span class="nc" id="L1455">                         RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1456">                         getLimitRow() / 2);</span>
<span class="nc" id="L1457">            createExport(rules, rule,</span>
<span class="nc" id="L1458">                         RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1459">                         getLimitRow() / 2);</span>
          } else {
            // all
<span class="fc" id="L1462">            createExport(rules, rule, -1, getLimitRow());</span>
          }
        }
<span class="fc" id="L1465">        final StringBuilder builder = new StringBuilder(&quot;[&quot;);</span>
<span class="pc bpc" id="L1466" title="1 of 2 branches missed.">        if (!rules.isEmpty()) {</span>
<span class="fc bfc" id="L1467" title="All 2 branches covered.">          for (final String string : rules.values()) {</span>
<span class="fc" id="L1468">            builder.append(string).append(',');</span>
<span class="fc" id="L1469">          }</span>
<span class="fc" id="L1470">          rules.clear();</span>
<span class="fc" id="L1471">          builder.setLength(builder.length() - 1);</span>
        }
<span class="fc" id="L1473">        builder.append(']');</span>
<span class="fc" id="L1474">        head = head.replace(XXXDATAJSONXXX, builder.toString());</span>
<span class="pc bnc" id="L1475" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1476">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">        if (ParametersChecker.isEmpty(rule)) {</span>
<span class="nc" id="L1478">          errorText = Messages.getString(&quot;HttpSslHandler.29&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1479">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1480">          head = createExport(head, errorText, null);</span>
<span class="nc" id="L1481">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1482">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
        }
        final DbRule dbrule;
        try {
<span class="nc" id="L1486">          dbrule = new DbRule(rule);</span>
<span class="nc" id="L1487">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1488">          errorText = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                      //$NON-NLS-1$
                      + B_CENTER_P2;
<span class="nc" id="L1491">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1492">          head = createExport(head, errorText, null);</span>
<span class="nc" id="L1493">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1494">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1495">        }</span>
        try {
<span class="nc" id="L1497">          dbrule.delete();</span>
<span class="nc" id="L1498">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1499">          errorText = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                      //$NON-NLS-1$
                      + B_CENTER_P2;
<span class="nc" id="L1502">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1503">          head = createExport(head, errorText, null);</span>
<span class="nc" id="L1504">          return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1505">                     .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
<span class="nc" id="L1506">        }</span>
<span class="nc" id="L1507">        errorText += Messages.getString(&quot;HttpSslHandler.31&quot;) + rule +</span>
                     B_CENTER_P2; //$NON-NLS-1$
<span class="nc" id="L1509">        head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1510">        head =</span>
<span class="nc" id="L1511">            head.replace(XXXDATAJSONXXX, '[' + dbrule.getJsonAsString() + ']');</span>
<span class="nc" id="L1512">        return head.replace(XXXRESULTXXX, errorText)</span>
<span class="nc" id="L1513">                   .replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
      }
    }
<span class="fc" id="L1516">    head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="fc" id="L1517">    head = createExport(head, errorText, null);</span>
<span class="fc" id="L1518">    return head.replace(XXXRESULTXXX, errorText).replace(XXXDATAJSONXXX, &quot;[]&quot;);</span>
  }

  private String spooled(final boolean detailed) {
    // XXXSPOOLEDXXX
<span class="pc bpc" id="L1523" title="1 of 2 branches missed.">    if (request.method() == HttpMethod.POST) {</span>
<span class="nc" id="L1524">      getParamsResponsive();</span>
    }
<span class="fc" id="L1526">    final String spooled = REQUEST.Spooled.read(this);</span>
    String uri;
<span class="pc bpc" id="L1528" title="1 of 2 branches missed.">    if (detailed) {</span>
<span class="nc" id="L1529">      uri = &quot;SpooledDetailed.html&quot;;</span>
    } else {
<span class="fc" id="L1531">      uri = &quot;Spooled.html&quot;;</span>
    }
<span class="fc" id="L1533">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L1534">        new QueryStringDecoder(request.uri());</span>
<span class="pc bpc" id="L1535" title="1 of 2 branches missed.">    if (params == null) {</span>
<span class="fc" id="L1536">      params = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
    }
<span class="fc" id="L1538">    params.putAll(queryStringDecoder.parameters());</span>
<span class="fc" id="L1539">    String name = null;</span>
<span class="pc bpc" id="L1540" title="1 of 2 branches missed.">    if (params.containsKey(&quot;name&quot;)) {</span>
<span class="nc" id="L1541">      name = getTrimValue(&quot;name&quot;);</span>
    }
<span class="fc" id="L1543">    int istatus = 0;</span>
<span class="pc bpc" id="L1544" title="1 of 2 branches missed.">    if (params.containsKey(&quot;status&quot;)) {</span>
<span class="nc" id="L1545">      final String status = getTrimValue(&quot;status&quot;);</span>
      try {
<span class="nc" id="L1547">        istatus = Integer.parseInt(status);</span>
<span class="nc" id="L1548">      } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1549">        istatus = 0;</span>
<span class="nc" id="L1550">      }</span>
    }
<span class="pc bpc" id="L1552" title="1 of 2 branches missed.">    if (spooled.contains(&quot;XXXSPOOLEDXXX&quot;)) {</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">      if (ParametersChecker.isNotEmpty(name)) {</span>
        // name is specified
<span class="nc" id="L1555">        uri = request.uri();</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (istatus != 0) {</span>
<span class="nc" id="L1557">          uri += &quot;&amp;status=&quot; + istatus;</span>
        }
<span class="nc" id="L1559">        final StringBuilder builder =</span>
<span class="nc" id="L1560">            SpooledInformTask.buildSpooledUniqueTable(uri, name);</span>
<span class="nc" id="L1561">        return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
      } else {
<span class="nc bnc" id="L1563" title="All 2 branches missed.">        if (istatus != 0) {</span>
<span class="nc" id="L1564">          uri += &quot;&amp;status=&quot; + istatus;</span>
        }
<span class="nc" id="L1566">        final StringBuilder builder =</span>
<span class="nc" id="L1567">            SpooledInformTask.buildSpooledTable(detailed, istatus, uri);</span>
<span class="nc" id="L1568">        return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
      }
    }
<span class="pc bpc" id="L1571" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(name)) {</span>
      // name is specified
<span class="nc" id="L1573">      uri = request.uri();</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1575">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="nc" id="L1577">      final String builder =</span>
<span class="nc" id="L1578">          SpooledInformTask.buildSpooledUniqueJson(uri, name);</span>
<span class="nc" id="L1579">      return spooled.replace(XXXDATAJSONXXX, builder);</span>
    } else {
<span class="pc bpc" id="L1581" title="1 of 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1582">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="fc" id="L1584">      final String builder =</span>
<span class="fc" id="L1585">          SpooledInformTask.buildSpooledJson(detailed, istatus, uri);</span>
<span class="fc" id="L1586">      return spooled.replace(XXXDATAJSONXXX, builder);</span>
    }
  }

  /**
   * Applied current lang to system page
   *
   * @param builder
   */
  @Override
  protected final void langHandle(final StringBuilder builder) {
    // i18n: add here any new languages
<span class="fc" id="L1598">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGENXXX.name(),</span>
<span class="fc bfc" id="L1599" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(lang)? &quot;checked&quot; : &quot;&quot;);</span>
<span class="fc" id="L1600">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1601" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(lang)? &quot;checked&quot; : &quot;&quot;);</span>
<span class="fc" id="L1602">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGENXXX.name(),</span>
<span class="fc bfc" id="L1603" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 &quot;checked&quot; : &quot;&quot;);
<span class="fc" id="L1605">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1606" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 &quot;checked&quot; : &quot;&quot;);
<span class="fc" id="L1608">  }</span>

  private void fillHostIds(final StringBuilder builder) {
<span class="fc" id="L1611">    final ArrayList&lt;String&gt; hostsList = new ArrayList&lt;String&gt;();</span>
    try {
<span class="fc" id="L1613">      final DbHostAuth[] hosts = DbHostAuth.getAllHosts();</span>
<span class="fc bfc" id="L1614" title="All 2 branches covered.">      for (final DbHostAuth dbHostAuth : hosts) {</span>
<span class="fc" id="L1615">        hostsList.add(dbHostAuth.getHostid());</span>
      }
<span class="nc" id="L1617">    } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
      // nothing
<span class="fc" id="L1619">    }</span>
<span class="fc" id="L1620">    final StringBuilder hostsBuilder = new StringBuilder();</span>
<span class="fc bfc" id="L1621" title="All 2 branches covered.">    for (final String string : hostsList) {</span>
<span class="fc bfc" id="L1622" title="All 2 branches covered.">      if (hostsBuilder.length() != 0) {</span>
<span class="fc" id="L1623">        hostsBuilder.append(',');</span>
      }
<span class="fc" id="L1625">      hostsBuilder.append('\'').append(string).append('\'');</span>
<span class="fc" id="L1626">    }</span>
<span class="fc" id="L1627">    final String hosts = &quot;[&quot; + hostsBuilder + ']';</span>
<span class="fc" id="L1628">    WaarpStringUtils.replace(builder, XXXHOSTSIDSXXX, hosts);</span>
<span class="fc" id="L1629">  }</span>

  private String system() {
<span class="fc" id="L1632">    getParamsResponsive();</span>
<span class="fc" id="L1633">    DbHostConfiguration config = null;</span>
    try {
<span class="fc" id="L1635">      config = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L1636">    } catch (final WaarpDatabaseException e2) {</span>
      try {
<span class="nc" id="L1638">        config =</span>
<span class="nc" id="L1639">            new DbHostConfiguration(Configuration.configuration.getHostId(), &quot;&quot;,</span>
                                    &quot;&quot;, &quot;&quot;, &quot;&quot;);
<span class="nc" id="L1641">        config.insert();</span>
<span class="nc" id="L1642">      } catch (final WaarpDatabaseException ignored) {</span>
        // nothing
<span class="nc" id="L1644">      }</span>
<span class="fc" id="L1645">    }</span>
<span class="fc bfc" id="L1646" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1647">      final String system = REQUEST.System.read(this);</span>
<span class="fc" id="L1648">      final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1649">      replaceStringSystem(config, builder);</span>
<span class="fc" id="L1650">      langHandle(builder);</span>
<span class="fc" id="L1651">      fillHostIds(builder);</span>
<span class="fc" id="L1652">      return builder.toString();</span>
    }
<span class="fc" id="L1654">    String extraInformation = null;</span>
<span class="pc bpc" id="L1655" title="1 of 2 branches missed.">    if (params.containsKey(ACTION2)) {</span>
<span class="fc" id="L1656">      final List&lt;String&gt; action = params.get(ACTION2);</span>
<span class="fc bfc" id="L1657" title="All 2 branches covered.">      for (final String act : action) {</span>
<span class="fc bfc" id="L1658" title="All 2 branches covered.">        if (&quot;Language&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1659">          lang = getTrimValue(&quot;change&quot;);</span>
<span class="fc" id="L1660">          final String sys = getTrimValue(&quot;changesys&quot;);</span>
<span class="fc" id="L1661">          Messages.init(new Locale(sys));</span>
<span class="fc" id="L1662">          extraInformation =</span>
<span class="fc" id="L1663">              Messages.getString(&quot;HttpSslHandler.LangIs&quot;) + &quot;Web: &quot; + lang +</span>
              &quot; OpenR66: &quot; //$NON-NLS-1$
<span class="fc" id="L1665">              + Messages.getSlocale();</span>
<span class="fc bfc" id="L1666" title="All 2 branches covered.">        } else if (&quot;Level&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1667">          final String loglevel = getTrimValue(&quot;loglevel&quot;);</span>
<span class="fc" id="L1668">          WaarpLogLevel level = WaarpLogLevel.WARN;</span>
<span class="fc bfc" id="L1669" title="All 2 branches covered.">          if (&quot;debug&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1670">            level = WaarpLogLevel.DEBUG;</span>
<span class="pc bpc" id="L1671" title="1 of 2 branches missed.">          } else if (&quot;info&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1672">            level = WaarpLogLevel.INFO;</span>
<span class="pc bpc" id="L1673" title="1 of 2 branches missed.">          } else if (&quot;warn&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1674">            level = WaarpLogLevel.WARN;</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">          } else if (&quot;error&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1676">            level = WaarpLogLevel.ERROR;</span>
          }
<span class="fc" id="L1678">          WaarpLoggerFactory.setLogLevel(level);</span>
<span class="fc" id="L1679">          extraInformation = Messages.getString(&quot;HttpSslHandler.LangIs&quot;) +</span>
<span class="fc" id="L1680">                             level.name(); //$NON-NLS-1$</span>
<span class="fc bfc" id="L1681" title="All 2 branches covered.">        } else if (&quot;ExportConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1682">          String base = Configuration.configuration.getBaseDirectory() +</span>
                        DirInterface.SEPARATOR;
<span class="fc" id="L1684">          final String directory =</span>
<span class="fc" id="L1685">              base + Configuration.configuration.getArchivePath();</span>
<span class="fc" id="L1686">          extraInformation = Messages.getString(&quot;HttpSslHandler.ExportDir&quot;)</span>
                             //$NON-NLS-1$
<span class="fc" id="L1688">                             + Configuration.configuration.getArchivePath() +</span>
                             &quot;&lt;br&gt;&quot;;
<span class="fc" id="L1690">          final String[] filenames =</span>
<span class="fc" id="L1691">              ServerActions.staticConfigExport(directory, true, true, true,</span>
                                               true, true);
          // hosts, rules, business, alias, roles
<span class="fc" id="L1694">          base = base.replace('\\', '/');</span>
<span class="pc bpc" id="L1695" title="1 of 2 branches missed.">          if (filenames[0] != null) {</span>
<span class="fc" id="L1696">            filenames[0] = filenames[0].replace('\\', '/').replace(base, &quot;&quot;);</span>
<span class="fc" id="L1697">            extraInformation +=</span>
                &quot;&lt;A href='&quot; + filenames[0] + &quot;' target='_blank'&gt;&quot; +
                filenames[0] + &quot;&lt;/A&gt; &quot; +
<span class="fc" id="L1700">                Messages.getString(&quot;HttpSslHandler.33&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1702" title="1 of 2 branches missed.">          if (filenames[1] != null) {</span>
<span class="fc" id="L1703">            filenames[1] = filenames[1].replace('\\', '/').replace(base, &quot;&quot;);</span>
<span class="fc" id="L1704">            extraInformation +=</span>
                &quot;&lt;A href='&quot; + filenames[1] + &quot;' target='_blank'&gt;&quot; +
                filenames[1] + &quot;&lt;/A&gt; &quot; +
<span class="fc" id="L1707">                Messages.getString(&quot;HttpSslHandler.32&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1709" title="1 of 2 branches missed.">          if (filenames[2] != null) {</span>
<span class="fc" id="L1710">            filenames[2] = filenames[2].replace('\\', '/').replace(base, &quot;&quot;);</span>
<span class="fc" id="L1711">            extraInformation +=</span>
                &quot;&lt;A href='&quot; + filenames[2] + &quot;' target='_blank'&gt;&quot; +
                filenames[2] + &quot;&lt;/A&gt; &quot; +
<span class="fc" id="L1714">                Messages.getString(&quot;HttpSslHandler.44&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1716" title="1 of 2 branches missed.">          if (filenames[3] != null) {</span>
<span class="fc" id="L1717">            filenames[3] = filenames[3].replace('\\', '/').replace(base, &quot;&quot;);</span>
<span class="fc" id="L1718">            extraInformation +=</span>
                &quot;&lt;A href='&quot; + filenames[3] + &quot;' target='_blank'&gt;&quot; +
                filenames[3] + &quot;&lt;/A&gt; &quot; +
<span class="fc" id="L1721">                Messages.getString(&quot;HttpSslHandler.45&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1723" title="1 of 2 branches missed.">          if (filenames[4] != null) {</span>
<span class="fc" id="L1724">            filenames[4] = filenames[4].replace('\\', '/').replace(base, &quot;&quot;);</span>
<span class="fc" id="L1725">            extraInformation +=</span>
                &quot;&lt;A href='&quot; + filenames[4] + &quot;' target='_blank'&gt;&quot; +
                filenames[4] + &quot;&lt;/A&gt; &quot; +
<span class="fc" id="L1728">                Messages.getString(&quot;HttpSslHandler.46&quot;); //$NON-NLS-1$</span>
          }
<span class="fc bfc" id="L1730" title="All 2 branches covered.">        } else if (&quot;Disconnect&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1731">          return logout();</span>
<span class="fc bfc" id="L1732" title="All 2 branches covered.">        } else if (&quot;Block&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1733">          final boolean block = params.containsKey(&quot;blocking&quot;);</span>
<span class="fc bfc" id="L1734" title="All 2 branches covered.">          if (block) {</span>
<span class="fc" id="L1735">            extraInformation =</span>
<span class="fc" id="L1736">                Messages.getString(&quot;HttpSslHandler.34&quot;); //$NON-NLS-1$</span>
          } else {
<span class="fc" id="L1738">            extraInformation =</span>
<span class="fc" id="L1739">                Messages.getString(&quot;HttpSslHandler.35&quot;); //$NON-NLS-1$</span>
          }
<span class="fc" id="L1741">          Configuration.configuration.setShutdown(block);</span>
<span class="fc bfc" id="L1742" title="All 2 branches covered.">        } else if (&quot;Shutdown&quot;.equalsIgnoreCase(act)) {</span>
          final String error;
<span class="pc bpc" id="L1744" title="1 of 2 branches missed.">          if (Configuration.configuration.getShutdownConfiguration().serviceFuture !=</span>
              null) {
<span class="nc" id="L1746">            error =</span>
<span class="nc" id="L1747">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="fc" id="L1749">            error =</span>
<span class="fc" id="L1750">                error(Messages.getString(&quot;HttpSslHandler.37&quot;)); //$NON-NLS-1$</span>
          }
<span class="fc" id="L1752">          WaarpShutdownHook.setRestart(false);</span>
<span class="fc" id="L1753">          newSession = true;</span>
<span class="fc" id="L1754">          clearSession();</span>
<span class="fc" id="L1755">          forceClose = true;</span>
<span class="fc" id="L1756">          shutdown = true;</span>
<span class="fc" id="L1757">          return error;</span>
<span class="pc bpc" id="L1758" title="1 of 2 branches missed.">        } else if (&quot;Restart&quot;.equalsIgnoreCase(act)) {</span>
          String error;
<span class="nc bnc" id="L1760" title="All 2 branches missed.">          if (Configuration.configuration.getShutdownConfiguration().serviceFuture !=</span>
              null) {
<span class="nc" id="L1762">            error =</span>
<span class="nc" id="L1763">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="nc" id="L1765">            error = error(Messages.getString(&quot;HttpSslHandler.39&quot;)</span>
                          //$NON-NLS-1$
<span class="nc" id="L1767">                          + Configuration.configuration.getTimeoutCon() * 2 /</span>
<span class="nc" id="L1768">                            1000 + Messages.getString(</span>
                &quot;HttpSslHandler.40&quot;)); //$NON-NLS-1$
          }
<span class="nc" id="L1771">          error = error.replace(&quot;XXXRELOADHTTPXXX&quot;,</span>
                                &quot;HTTP-EQUIV=\&quot;refresh\&quot; CONTENT=\&quot;&quot; +
<span class="nc" id="L1773">                                Configuration.configuration.getTimeoutCon() *</span>
                                2 / 1000 + '&quot;');
<span class="nc" id="L1775">          WaarpShutdownHook.setRestart(true);</span>
<span class="nc" id="L1776">          newSession = true;</span>
<span class="nc" id="L1777">          clearSession();</span>
<span class="nc" id="L1778">          forceClose = true;</span>
<span class="nc" id="L1779">          shutdown = true;</span>
<span class="nc" id="L1780">          return error;</span>
<span class="fc bfc" id="L1781" title="All 2 branches covered.">        } else if (&quot;Validate&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1782">          final String bsessionr = getTrimValue(&quot;BSESSR&quot;);</span>
<span class="fc" id="L1783">          long lsessionr =</span>
<span class="fc" id="L1784">              Configuration.configuration.getServerChannelReadLimit();</span>
          long lglobalr;
          long lsessionw;
          long lglobalw;
          long delay;
          try {
<span class="pc bpc" id="L1790" title="1 of 2 branches missed.">            if (bsessionr != null) {</span>
<span class="fc" id="L1791">              lsessionr = (Long.parseLong(bsessionr) / 10) * 10;</span>
            }
<span class="fc" id="L1793">            final String bglobalr = getTrimValue(&quot;BGLOBR&quot;);</span>
<span class="fc" id="L1794">            lglobalr = Configuration.configuration.getServerGlobalReadLimit();</span>
<span class="pc bpc" id="L1795" title="1 of 2 branches missed.">            if (bglobalr != null) {</span>
<span class="fc" id="L1796">              lglobalr = (Long.parseLong(bglobalr) / 10) * 10;</span>
            }
<span class="fc" id="L1798">            final String bsessionw = getTrimValue(&quot;BSESSW&quot;);</span>
<span class="fc" id="L1799">            lsessionw =</span>
<span class="fc" id="L1800">                Configuration.configuration.getServerChannelWriteLimit();</span>
<span class="pc bpc" id="L1801" title="1 of 2 branches missed.">            if (bsessionw != null) {</span>
<span class="fc" id="L1802">              lsessionw = (Long.parseLong(bsessionw) / 10) * 10;</span>
            }
<span class="fc" id="L1804">            final String bglobalw = getTrimValue(&quot;BGLOBW&quot;);</span>
<span class="fc" id="L1805">            lglobalw = Configuration.configuration.getServerGlobalWriteLimit();</span>
<span class="pc bpc" id="L1806" title="1 of 2 branches missed.">            if (bglobalw != null) {</span>
<span class="fc" id="L1807">              lglobalw = (Long.parseLong(bglobalw) / 10) * 10;</span>
            }
<span class="fc" id="L1809">            final String dtra = getTrimValue(&quot;DTRA&quot;);</span>
<span class="fc" id="L1810">            delay = Configuration.configuration.getDelayLimit();</span>
<span class="pc bpc" id="L1811" title="1 of 2 branches missed.">            if (dtra != null) {</span>
<span class="fc" id="L1812">              delay = (Long.parseLong(dtra) / 10) * 10;</span>
<span class="pc bpc" id="L1813" title="1 of 2 branches missed.">              if (delay &lt; 100) {</span>
<span class="nc" id="L1814">                delay = 100;</span>
              }
            }
<span class="fc" id="L1817">            Configuration.configuration.changeNetworkLimit(lglobalw, lglobalr,</span>
                                                           lsessionw, lsessionr,
                                                           delay);
<span class="fc" id="L1820">            final String dcomm = getTrimValue(&quot;DCOM&quot;);</span>
<span class="pc bpc" id="L1821" title="1 of 2 branches missed.">            if (dcomm != null) {</span>
<span class="fc" id="L1822">              Configuration.configuration.setDelayCommander(</span>
<span class="fc" id="L1823">                  Long.parseLong(dcomm));</span>
<span class="pc bpc" id="L1824" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayCommander() &lt;= 100) {</span>
<span class="nc" id="L1825">                Configuration.configuration.setDelayCommander(100);</span>
              }
<span class="fc" id="L1827">              Configuration.configuration.reloadCommanderDelay();</span>
            }
<span class="fc" id="L1829">            final String dret = getTrimValue(&quot;DRET&quot;);</span>
<span class="pc bpc" id="L1830" title="1 of 2 branches missed.">            if (dret != null) {</span>
<span class="fc" id="L1831">              Configuration.configuration.setDelayRetry(Long.parseLong(dret));</span>
<span class="pc bpc" id="L1832" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayRetry() &lt;= 1000) {</span>
<span class="fc" id="L1833">                Configuration.configuration.setDelayRetry(1000);</span>
              }
            }
<span class="fc" id="L1836">            extraInformation =</span>
<span class="fc" id="L1837">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1838">          } catch (final NumberFormatException e) {</span>
<span class="nc" id="L1839">            extraInformation =</span>
<span class="nc" id="L1840">                Messages.getString(&quot;HttpSslHandler.42&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L1841">          }</span>
<span class="pc bpc" id="L1842" title="1 of 2 branches missed.">        } else if (&quot;HostConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1843">          logger.debug(&quot;DbHC update&quot;);</span>
<span class="fc" id="L1844">          config.setBusiness(getTrimValue(&quot;BUSINESS&quot;));</span>
<span class="fc" id="L1845">          config.setRoles(getTrimValue(&quot;ROLES&quot;));</span>
<span class="fc" id="L1846">          config.setAliases(getTrimValue(&quot;ALIASES&quot;));</span>
<span class="fc" id="L1847">          config.setOthers(getTrimValue(&quot;OTHER&quot;));</span>
<span class="fc" id="L1848">          logger.debug(&quot;DbHC update {}&quot;, config.toJson());</span>
          try {
<span class="fc" id="L1850">            config.update();</span>
<span class="fc" id="L1851">            extraInformation =</span>
<span class="fc" id="L1852">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1853">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1854">            extraInformation =</span>
<span class="nc" id="L1855">                Messages.getString(&quot;HttpSslHandler.43&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L1856">          }</span>
        }
<span class="fc" id="L1858">      }</span>
    }
<span class="fc" id="L1860">    final String system = REQUEST.System.read(this);</span>
<span class="fc" id="L1861">    final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1862">    replaceStringSystem(config, builder);</span>
<span class="fc" id="L1863">    langHandle(builder);</span>
<span class="fc" id="L1864">    fillHostIds(builder);</span>
<span class="pc bpc" id="L1865" title="1 of 2 branches missed.">    if (extraInformation != null) {</span>
<span class="fc" id="L1866">      builder.append(extraInformation);</span>
    }
<span class="fc" id="L1868">    return builder.toString();</span>
  }

  private void getParamsResponsive() {
<span class="fc bfc" id="L1872" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L1873">      params = null;</span>
<span class="pc bpc" id="L1874" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L1875">      final Map&lt;String, List&lt;String&gt;&gt; paramsOld = params;</span>
<span class="fc" id="L1876">      final ByteBuf content = request.content();</span>
<span class="pc bpc" id="L1877" title="1 of 2 branches missed.">      if (content.isReadable()) {</span>
<span class="fc" id="L1878">        final String param = content.toString(WaarpStringUtils.UTF8);</span>
<span class="fc" id="L1879">        final QueryStringDecoder queryStringDecoder2 =</span>
            new QueryStringDecoder(&quot;/?&quot; + param);
<span class="fc" id="L1881">        params = queryStringDecoder2.parameters();</span>
<span class="fc" id="L1882">        boolean invalidEntry = false;</span>
<span class="fc bfc" id="L1883" title="All 2 branches covered.">        for (final Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params.entrySet()) {</span>
          try {
<span class="fc" id="L1885">            ParametersChecker.checkSanityString(paramCheck.getValue().toArray(</span>
                ParametersChecker.ZERO_ARRAY_STRING));
<span class="nc" id="L1887">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L1888">            logger.error(</span>
<span class="nc" id="L1889">                &quot;Arguments incompatible with Security: &quot; + paramCheck.getKey() +</span>
<span class="nc" id="L1890">                &quot;: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1891">            invalidEntry = true;</span>
<span class="fc" id="L1892">          }</span>
<span class="fc" id="L1893">        }</span>
<span class="pc bpc" id="L1894" title="1 of 2 branches missed.">        if (invalidEntry) {</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">          for (final Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params.entrySet()) {</span>
<span class="nc" id="L1896">            paramCheck.getValue().clear();</span>
<span class="nc" id="L1897">          }</span>
<span class="nc" id="L1898">          params.clear();</span>
<span class="nc" id="L1899">          params = null;</span>
<span class="nc" id="L1900">          logger.error(&quot;No parameter validated since security issue found&quot;);</span>
<span class="nc" id="L1901">          return;</span>
        }
<span class="pc bpc" id="L1903" title="1 of 2 branches missed.">        if (params.containsKey(REFRESH)) {</span>
<span class="nc" id="L1904">          final List&lt;String&gt; parms = params.get(ACTION2);</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">          if (parms != null) {</span>
<span class="nc" id="L1906">            final String parm = parms.get(0);</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">            if (&quot;Disabling&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1908">              setRefresh(0);</span>
            } else {
<span class="nc" id="L1910">              final String snb = getTrimValue(REFRESH);</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">              if (snb != null) {</span>
                try {
<span class="nc" id="L1913">                  final int old = getRefresh();</span>
<span class="nc" id="L1914">                  setRefresh(Integer.parseInt(snb) * 1000);</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                  if (getRefresh() &lt; 0) {</span>
<span class="nc" id="L1916">                    setRefresh(old);</span>
                  }
<span class="nc" id="L1918">                } catch (final Exception ignored) {</span>
                  // ignore
<span class="nc" id="L1920">                }</span>
              }
            }
          }
<span class="nc" id="L1924">          params = paramsOld;</span>
<span class="nc" id="L1925">          return;</span>
        }
<span class="fc bfc" id="L1927" title="All 2 branches covered.">        if (params.containsKey(LIMITROW1)) {</span>
<span class="fc" id="L1928">          final String snb = getTrimValue(LIMITROW1);</span>
<span class="pc bpc" id="L1929" title="1 of 2 branches missed.">          if (snb != null) {</span>
            try {
<span class="fc" id="L1931">              final int old = getLimitRow();</span>
<span class="fc" id="L1932">              setLimitRow(Integer.parseInt(snb));</span>
<span class="pc bpc" id="L1933" title="1 of 2 branches missed.">              if (getLimitRow() &lt; 5) {</span>
<span class="nc" id="L1934">                setLimitRow(old);</span>
              }
<span class="nc" id="L1936">            } catch (final Exception ignored) {</span>
              // ignore
<span class="fc" id="L1938">            }</span>
          }
        }
<span class="fc" id="L1941">      } else {</span>
<span class="nc" id="L1942">        params = null;</span>
      }
    }
<span class="fc" id="L1945">  }</span>

  private void checkAuthentResponsive(final ChannelHandlerContext ctx) {
<span class="fc" id="L1948">    newSession = true;</span>
<span class="fc bfc" id="L1949" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L1950">      String logon = logon();</span>
<span class="fc" id="L1951">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), &quot;&quot;);</span>
<span class="fc" id="L1952">      responseContent.append(logon);</span>
<span class="fc" id="L1953">      clearSession();</span>
<span class="fc" id="L1954">      writeResponse(ctx);</span>
<span class="fc" id="L1955">      return;</span>
<span class="pc bpc" id="L1956" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L1957">      getParamsResponsive();</span>
<span class="pc bpc" id="L1958" title="1 of 2 branches missed.">      if (params == null) {</span>
<span class="nc" id="L1959">        String logon = logon();</span>
<span class="nc" id="L1960">        logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="nc" id="L1961">                                 Messages.getString(</span>
                                     &quot;HttpSslHandler.EmptyLogin&quot;));
<span class="nc" id="L1963">        responseContent.append(logon);</span>
<span class="nc" id="L1964">        clearSession();</span>
<span class="nc" id="L1965">        writeResponse(ctx);</span>
<span class="nc" id="L1966">        return;</span>
      }
    } else {
<span class="nc" id="L1969">      sendError(ctx, HttpResponseStatus.METHOD_NOT_ALLOWED);</span>
<span class="nc" id="L1970">      return;</span>
    }
<span class="fc" id="L1972">    boolean getMenu = false;</span>
<span class="pc bpc" id="L1973" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;Logon&quot;)) {</span>
<span class="fc" id="L1974">      String name = null;</span>
<span class="fc" id="L1975">      String password = null;</span>
      List&lt;String&gt; values;
<span class="pc bpc" id="L1977" title="1 of 2 branches missed.">      if (!params.isEmpty()) {</span>
        // get values
<span class="pc bpc" id="L1979" title="1 of 2 branches missed.">        if (params.containsKey(&quot;name&quot;)) {</span>
<span class="fc" id="L1980">          values = params.get(&quot;name&quot;);</span>
<span class="pc bpc" id="L1981" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L1982">            name = values.get(0);</span>
<span class="pc bpc" id="L1983" title="1 of 2 branches missed.">            if (ParametersChecker.isEmpty(name)) {</span>
<span class="nc" id="L1984">              getMenu = true;</span>
            }
          }
        } else {
<span class="nc" id="L1988">          getMenu = true;</span>
        }
        // search the nb param
<span class="pc bpc" id="L1991" title="2 of 4 branches missed.">        if (!getMenu &amp;&amp; params.containsKey(&quot;passwd&quot;)) {</span>
<span class="fc" id="L1992">          values = params.get(&quot;passwd&quot;);</span>
<span class="pc bpc" id="L1993" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L1994">            password = values.get(0);</span>
<span class="fc" id="L1995">            getMenu = ParametersChecker.isEmpty(password);</span>
          } else {
<span class="nc" id="L1997">            getMenu = true;</span>
          }
        } else {
<span class="nc" id="L2000">          getMenu = true;</span>
        }
      } else {
<span class="nc" id="L2003">        getMenu = true;</span>
      }
<span class="pc bpc" id="L2005" title="2 of 4 branches missed.">      if (!getMenu &amp;&amp; name != null) {</span>
<span class="fc" id="L2006">        logger.debug(&quot;Name? {} Passwd? {}&quot;,</span>
<span class="fc" id="L2007">                     name.equals(Configuration.configuration.getAdminName()),</span>
<span class="fc" id="L2008">                     Arrays.equals(password.getBytes(WaarpStringUtils.UTF8),</span>
<span class="fc" id="L2009">                                   Configuration.configuration.getServerAdminKey()));</span>
<span class="fc bfc" id="L2010" title="All 2 branches covered.">        if (name.equals(Configuration.configuration.getAdminName()) &amp;&amp;</span>
<span class="pc bpc" id="L2011" title="1 of 2 branches missed.">            Arrays.equals(password.getBytes(WaarpStringUtils.UTF8),</span>
<span class="fc" id="L2012">                          Configuration.configuration.getServerAdminKey())) {</span>
<span class="fc" id="L2013">          authentHttp.getAuth().specialNoSessionAuth(true,</span>
<span class="fc" id="L2014">                                                     Configuration.configuration.getHostId());</span>
<span class="fc" id="L2015">          authentHttp.setStatus(70);</span>
        } else {
          try {
<span class="fc" id="L2018">            authentHttp.getAuth().connectionHttps(name,</span>
<span class="fc" id="L2019">                                                  FilesystemBasedDigest.passwdCrypt(</span>
<span class="fc" id="L2020">                                                      password.getBytes(</span>
                                                          WaarpStringUtils.UTF8)));
<span class="nc" id="L2022">          } catch (final Reply530Exception e1) {</span>
<span class="nc" id="L2023">            getMenu = true;</span>
<span class="nc" id="L2024">          } catch (final Reply421Exception e1) {</span>
<span class="nc" id="L2025">            getMenu = true;</span>
<span class="pc" id="L2026">          }</span>
        }
<span class="pc bpc" id="L2028" title="1 of 2 branches missed.">        if (!authentHttp.isAuthenticated()) {</span>
<span class="nc" id="L2029">          authentHttp.setStatus(71);</span>
<span class="nc" id="L2030">          logger.info(&quot;Still not authenticated: {}&quot;, authentHttp);</span>
<span class="nc" id="L2031">          getMenu = true;</span>
        }
<span class="fc" id="L2033">        logger.debug(&quot;Identified: {}:{}&quot;, authentHttp.getAuth().isIdentified(),</span>
<span class="fc" id="L2034">                     authentHttp.isAuthenticated());</span>
      }
<span class="fc" id="L2036">    } else {</span>
<span class="nc" id="L2037">      getMenu = true;</span>
    }
<span class="pc bpc" id="L2039" title="1 of 2 branches missed.">    if (getMenu) {</span>
<span class="nc" id="L2040">      String logon = logon();</span>
<span class="nc" id="L2041">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="nc" id="L2042">                               Messages.getString(&quot;HttpSslHandler.BadLogin&quot;));</span>
<span class="nc" id="L2043">      responseContent.append(logon);</span>
<span class="nc" id="L2044">      clearSession();</span>
<span class="nc" id="L2045">    } else {</span>
<span class="fc" id="L2046">      final String index = indexResponsive();</span>
<span class="fc" id="L2047">      responseContent.append(index);</span>
<span class="fc" id="L2048">      clearSession();</span>
<span class="fc" id="L2049">      admin = new DefaultCookie(</span>
<span class="fc" id="L2050">          R66SESSION + Configuration.configuration.getHostId(),</span>
<span class="fc" id="L2051">          Configuration.configuration.getHostId() +</span>
<span class="fc" id="L2052">          Long.toHexString(RANDOM.nextLong()));</span>
<span class="fc" id="L2053">      sessions.put(admin.value(), authentHttp);</span>
<span class="fc" id="L2054">      authentHttp.setStatus(72);</span>
<span class="fc" id="L2055">      logger.debug(&quot;CreateSession: {}:{}&quot;, uriRequest, admin);</span>
    }
<span class="fc" id="L2057">    writeResponse(ctx);</span>
<span class="fc" id="L2058">  }</span>

  @Override
  protected void channelRead0(final ChannelHandlerContext ctx,
                              final FullHttpRequest msg) {
<span class="fc" id="L2063">    final FullHttpRequest request = this.request = msg;</span>
<span class="fc" id="L2064">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L2065">        new QueryStringDecoder(request.uri());</span>
<span class="fc" id="L2066">    uriRequest = queryStringDecoder.path();</span>
<span class="fc" id="L2067">    logger.debug(&quot;Msg: {}&quot;, uriRequest);</span>
<span class="pc bpc" id="L2068" title="1 of 4 branches missed.">    if (uriRequest.contains(&quot;gre/&quot;) || uriRequest.contains(&quot;img/&quot;) ||</span>
<span class="fc bfc" id="L2069" title="All 4 branches covered.">        uriRequest.contains(&quot;app/&quot;) || uriRequest.contains(&quot;css/&quot;) ||</span>
<span class="fc bfc" id="L2070" title="All 4 branches covered.">        uriRequest.contains(&quot;js/&quot;) || uriRequest.contains(&quot;datatable/&quot;) ||</span>
<span class="fc bfc" id="L2071" title="All 4 branches covered.">        uriRequest.contains(&quot;res/&quot;) || uriRequest.contains(&quot;favicon.ico&quot;)) {</span>
<span class="fc" id="L2072">      HttpWriteCacheEnable.writeFile(request, ctx,</span>
<span class="fc" id="L2073">                                     Configuration.configuration.getHttpBasePath() +</span>
                                     uriRequest, R66SESSION +
<span class="fc" id="L2075">                                                 Configuration.configuration.getHostId());</span>
<span class="fc" id="L2076">      return;</span>
    }
<span class="pc bpc" id="L2078" title="1 of 2 branches missed.">    if (uriRequest.contains(Configuration.configuration.getArchivePath())) {</span>
<span class="nc" id="L2079">      HttpWriteCacheEnable.writeFile(request, ctx,</span>
<span class="nc" id="L2080">                                     Configuration.configuration.getBaseDirectory() +</span>
                                     uriRequest, R66SESSION +
<span class="nc" id="L2082">                                                 Configuration.configuration.getHostId());</span>
<span class="nc" id="L2083">      return;</span>
    }
<span class="fc" id="L2085">    checkSession(ctx.channel());</span>
    try {
<span class="fc bfc" id="L2087" title="All 2 branches covered.">      if (!authentHttp.isAuthenticated()) {</span>
<span class="fc" id="L2088">        logger.debug(&quot;Not Authent: {}:{}&quot;, uriRequest, authentHttp);</span>
<span class="fc" id="L2089">        checkAuthentResponsive(ctx);</span>
<span class="fc" id="L2090">        return;</span>
      }
<span class="fc" id="L2092">      String find = uriRequest;</span>
<span class="pc bpc" id="L2093" title="1 of 2 branches missed.">      if (uriRequest.charAt(0) == '/') {</span>
<span class="fc" id="L2094">        find = uriRequest.substring(1);</span>
      }
<span class="fc" id="L2096">      REQUEST req = REQUEST.index;</span>
<span class="fc bfc" id="L2097" title="All 2 branches covered.">      if (find.length() != 0) {</span>
<span class="fc" id="L2098">        find = find.substring(0, find.indexOf('.'));</span>
        try {
<span class="fc" id="L2100">          req = REQUEST.valueOf(find);</span>
<span class="fc" id="L2101">        } catch (final IllegalArgumentException e1) {</span>
<span class="fc" id="L2102">          req = REQUEST.index;</span>
<span class="fc" id="L2103">          logger.info(&quot;NotFound: {}:{}&quot;, find, uriRequest);</span>
<span class="fc" id="L2104">        }</span>
      }
<span class="pc bpc" id="L2106" title="2 of 12 branches missed.">      switch (req) {</span>
        case CancelRestart:
<span class="pc bpc" id="L2108" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.TRANSFER)) {</span>
<span class="fc" id="L2109">            responseContent.append(cancelRestart());</span>
          } else {
<span class="nc" id="L2111">            responseContent.append(unallowedResponsive(</span>
<span class="nc" id="L2112">                Messages.getString(&quot;HttpSslHandler.CancelRestartUnallowed&quot;)));</span>
          }
<span class="nc" id="L2114">          break;</span>
        case Export:
<span class="pc bpc" id="L2116" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2117">            responseContent.append(export());</span>
          } else {
<span class="nc" id="L2119">            responseContent.append(unallowedResponsive(</span>
<span class="nc" id="L2120">                Messages.getString(&quot;HttpSslHandler.ExportUnallowed&quot;)));</span>
          }
<span class="nc" id="L2122">          break;</span>
        case Hosts:
<span class="fc bfc" id="L2124" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.HOST)) {</span>
<span class="fc" id="L2125">            responseContent.append(hosts());</span>
          } else {
<span class="fc" id="L2127">            responseContent.append(unallowedResponsive(</span>
<span class="fc" id="L2128">                Messages.getString(&quot;HttpSslHandler.HostUnallowed&quot;)));</span>
          }
<span class="fc" id="L2130">          break;</span>
        case ListingReload:
<span class="nc" id="L2132">          responseContent.append(listingReload());</span>
<span class="nc" id="L2133">          break;</span>
        case Listing:
<span class="fc" id="L2135">          responseContent.append(listing());</span>
<span class="fc" id="L2136">          break;</span>
        case Logout:
<span class="fc" id="L2138">          responseContent.append(logout());</span>
<span class="fc" id="L2139">          break;</span>
        case Rules:
<span class="fc bfc" id="L2141" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.RULE)) {</span>
<span class="fc" id="L2142">            responseContent.append(rules());</span>
          } else {
<span class="fc" id="L2144">            responseContent.append(unallowedResponsive(</span>
<span class="fc" id="L2145">                Messages.getString(&quot;HttpSslHandler.RulesUnallowed&quot;)));</span>
          }
<span class="fc" id="L2147">          break;</span>
        case System:
<span class="fc bfc" id="L2149" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2150">            responseContent.append(system());</span>
          } else {
<span class="fc" id="L2152">            responseContent.append(systemLimited());</span>
          }
<span class="fc" id="L2154">          break;</span>
        case Spooled:
<span class="fc" id="L2156">          responseContent.append(spooled(false));</span>
<span class="fc" id="L2157">          break;</span>
        case SpooledDetailed:
<span class="nc" id="L2159">          responseContent.append(spooled(true));</span>
<span class="nc" id="L2160">          break;</span>
        case CreateTransfer:
<span class="pc bpc" id="L2162" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.TRANSFER)) {</span>
<span class="fc" id="L2163">            responseContent.append(createTransfer());</span>
          } else {
<span class="nc" id="L2165">            responseContent.append(unallowedResponsive(</span>
<span class="nc" id="L2166">                Messages.getString(&quot;HttpSslHandler.CreateTransferNotAllowed&quot;)));</span>
          }
<span class="nc" id="L2168">          break;</span>
        default:
<span class="fc" id="L2170">          responseContent.append(indexResponsive());</span>
          break;
      }
<span class="fc" id="L2173">      writeResponse(ctx);</span>
    } finally {
<span class="fc" id="L2175">      closeConnection();</span>
    }
<span class="fc" id="L2177">  }</span>

  private class RestartOrStopAll {
    private final String seeAll;
    private final String parm;
    private String head;
    private String errorText;

    public RestartOrStopAll(final String head, final String errorText,
<span class="fc" id="L2186">                            final String seeAll, final String parm) {</span>
<span class="fc" id="L2187">      this.head = head;</span>
<span class="fc" id="L2188">      this.errorText = errorText;</span>
<span class="fc" id="L2189">      this.seeAll = seeAll;</span>
<span class="fc" id="L2190">      this.parm = parm;</span>
<span class="fc" id="L2191">    }</span>

    public String getHead() {
<span class="fc" id="L2194">      return head;</span>
    }

    public String getErrorText() {
<span class="fc" id="L2198">      return errorText;</span>
    }

    public RestartOrStopAll invoke() {
<span class="fc bfc" id="L2202" title="All 2 branches covered.">      final boolean stopcommand = &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="pc bpc" id="L2203" title="1 of 2 branches missed.">                                  &quot;StopCleanAll&quot;.equalsIgnoreCase(parm);</span>
<span class="fc" id="L2204">      final String startid = getTrimValue(&quot;startid&quot;);</span>
<span class="fc" id="L2205">      final String stopid = getTrimValue(&quot;stopid&quot;);</span>
<span class="fc" id="L2206">      String start = getValue(&quot;start&quot;);</span>
<span class="fc" id="L2207">      String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L2208">      final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L2209">      final String req = getTrimValue(&quot;req&quot;);</span>
      boolean pending;
      boolean transfer;
      boolean error;
      boolean all;
<span class="fc" id="L2214">      pending = params.containsKey(&quot;pending&quot;);</span>
<span class="fc" id="L2215">      transfer = params.containsKey(&quot;transfer&quot;);</span>
<span class="fc" id="L2216">      error = params.containsKey(&quot;error&quot;);</span>
<span class="fc" id="L2217">      all = false;</span>
<span class="pc bpc" id="L2218" title="2 of 6 branches missed.">      if (!(pending || transfer || error)) {</span>
<span class="fc" id="L2219">        all = true;</span>
<span class="fc" id="L2220">        pending = true;</span>
<span class="fc" id="L2221">        transfer = true;</span>
<span class="fc" id="L2222">        error = true;</span>
      }
<span class="fc" id="L2224">      final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L2225" title="1 of 2 branches missed.">      if (tstart != null) {</span>
<span class="nc" id="L2226">        start = tstart.toString();</span>
      }
<span class="fc" id="L2228">      final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L2229" title="1 of 2 branches missed.">      if (tstop != null) {</span>
<span class="nc" id="L2230">        stop = tstop.toString();</span>
      }
<span class="pc bpc" id="L2232" title="4 of 8 branches missed.">      head = resetOptionTransfer(head, startid == null? &quot;&quot; : startid,</span>
                                 stopid == null? &quot;&quot; : stopid, start, stop,
                                 rule == null? &quot;&quot; : rule, req == null? &quot;&quot; : req,
                                 pending, transfer, error, false, all);
<span class="fc" id="L2236">      final HashMap&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc bfc" id="L2237" title="All 2 branches covered.">      if (stopcommand) {</span>
<span class="pc bpc" id="L2238" title="1 of 2 branches missed.">        if (&quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L2239">          TransferUtils.cleanSelectedTransfers(dbSession, 0, map, authentHttp,</span>
                                               head, startid, stopid, tstart,
                                               tstop, rule, req, pending,
                                               transfer, error, seeAll);
        } else {
<span class="fc" id="L2244">          TransferUtils.stopSelectedTransfers(dbSession, 0, map, authentHttp,</span>
                                              head, startid, stopid, tstart,
                                              tstop, rule, req, pending,
                                              transfer, error, seeAll);
        }
      } else {
<span class="fc" id="L2250">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L2252">          preparedStatement =</span>
<span class="fc" id="L2253">              DbTaskRunner.getFilterPrepareStatement(dbSession, 0, false,</span>
                                                     startid, stopid, tstart,
                                                     tstop, rule, req, pending,
                                                     transfer, error, false,
                                                     all, seeAll);
<span class="fc" id="L2258">          preparedStatement.executeQuery();</span>
<span class="pc bpc" id="L2259" title="1 of 2 branches missed.">          while (preparedStatement.getNext()) {</span>
            try {
<span class="nc" id="L2261">              final DbTaskRunner taskRunner =</span>
<span class="nc" id="L2262">                  DbTaskRunner.getFromStatement(preparedStatement);</span>
<span class="nc" id="L2263">              final LocalChannelReference lcr =</span>
<span class="nc" id="L2264">                  Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L2265">                                             .getFromRequest(</span>
<span class="nc" id="L2266">                                                 taskRunner.getKey());</span>
<span class="nc" id="L2267">              final R66Result finalResult =</span>
<span class="nc" id="L2268">                  TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L2269">              final ErrorCode result = finalResult.getCode();</span>
<span class="nc" id="L2270">              final ErrorCode last = taskRunner.getErrorInfo();</span>
<span class="nc" id="L2271">              taskRunner.setErrorExecutionStatus(result);</span>
<span class="nc" id="L2272">              map.put(taskRunner.getKey(), taskRunner.getJsonAsString());</span>
<span class="nc" id="L2273">              taskRunner.setErrorExecutionStatus(last);</span>
<span class="nc" id="L2274">            } catch (final WaarpDatabaseException e) {</span>
              // try to continue if possible
<span class="nc" id="L2276">              logger.warn(&quot;An error occurs while accessing a Runner: {}&quot;,</span>
<span class="nc" id="L2277">                          e.getMessage());</span>
<span class="nc" id="L2278">            }</span>
          }
<span class="fc" id="L2280">          preparedStatement.realClose();</span>
<span class="nc" id="L2281">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L2283">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L2285">          logger.warn(OPEN_R66_WEB_ERROR2, e.getMessage());</span>
<span class="nc" id="L2286">          errorText +=</span>
<span class="nc" id="L2287">              Messages.getString(&quot;ErrorCode.17&quot;) + &quot;: &quot; + e.getMessage() +</span>
              &quot;&lt;BR/&gt;&quot;;
<span class="fc" id="L2289">        }</span>
      }
<span class="fc" id="L2291">      final StringBuilder builder = new StringBuilder(&quot;[&quot;);</span>
<span class="pc bpc" id="L2292" title="1 of 2 branches missed.">      if (!map.isEmpty()) {</span>
<span class="nc bnc" id="L2293" title="All 2 branches missed.">        for (final String string : map.values()) {</span>
<span class="nc" id="L2294">          builder.append(string).append(',');</span>
<span class="nc" id="L2295">        }</span>
<span class="nc" id="L2296">        map.clear();</span>
<span class="nc" id="L2297">        builder.setLength(builder.length() - 1);</span>
      }
<span class="fc" id="L2299">      builder.append(']');</span>
<span class="fc" id="L2300">      head = head.replace(XXXDATAJSONXXX, builder.toString());</span>
<span class="fc" id="L2301">      return this;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>