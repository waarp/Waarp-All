<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/apt/index.apt at 2022-07-11

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>Waarp Password &#x2013; Waarp Http Module</title>
    <link rel="stylesheet" href="./css/maven-base.css" />
    <link rel="stylesheet" href="./css/maven-theme.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="http://www.waarp.fr" id="bannerLeft"><img src="images/waarp.jpg"  alt="Waarp Project"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2022-07-11</span>
           | <span id="projectVersion">Version: 3.6.2-jre8</span>
      </div>
      <div class="xright"><a href="http://www.waarp.fr/" class="externalLink" title="Waarp">Waarp</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Waarp Http Module</h5>
    <ul>
     <li class="none"><strong>Overview of Waarp Http Module</strong></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="https://www.waarp.fr/" title="Waarp" class="poweredBy">
        <img class="poweredBy"  alt="Waarp" src="https://www.waarp.fr/i/logo.png"     />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<section>
<h2><a name="a1.29_Presentation"></a>1) Presentation</h2>
<p>Waarp Http is a module of Waarp which allows to upload/download files from a browser for an end User, while those files are going to/coming from a Waarp server.</p>
<p>This module is not usable as is, some integration must be done to fit several points (see integration focus).</p><section>
<h3><a name="a1.1.29_For_Upload"></a>1.1) For Upload</h3>
<p>The browser allows the user to select a local file (drag and drop or select through a window).</p>
<p>Once the file is selected, the javascript embedded computes the Hash (SHA-256) of this local file and then sends this one by chunk (1MB by default) to the Waarp Web Server.</p><section>
<h4><a name="The_client_perspective"></a>The client perspective</h4>
<p>The sending follows the Waarp rules of transfers:</p>
<ul>
<li>a local unique identifier is assigned to the transfer</li>
<li>a hash (SHA-256) is computed locally</li>
<li>a rule of transfer is selected (in Send mode)</li>
<li>an identifier of the user is selected</li>
<li>the local name of the file</li>
<li>the size of the chunk (default being 1MB)</li></ul><section>
<h5><a name="Visual_comportment"></a>Visual comportment</h5>
<p>When the file is currently uploaded (a progression bar is visible for the user), the user can stop and restart the transfer or cancel the transfer .</p>
<p>A user can select multiple files, but they will be transferred one by one however.</p></section><section>
<h5><a name="Functional_Comportment"></a>Functional Comportment</h5>
<p>For each chunk (block of binary content), the browser test if this block was already sent before to the Waarp Web Server. If so, the chunk is ignored, else it is sent.</p>
<p>This allows to have &quot;resumable&quot; compliant transfers, including when lost of carrier.</p></section></section><section>
<h4><a name="Waarp_Web_Server_perspective"></a>Waarp Web Server perspective</h4>
<p>From Waarp Web Server perspective, this transfer is as a &quot;usual&quot; transfer, using the standard database of Waarp product. </p><section>
<h5><a name="Functional_Comportment"></a>Functional Comportment</h5>
<p>The unique identifier is given by the client. </p>
<p>The hash is compared with the one given by the client.</p>
<p>The rule is given by the client. The Waarp Web Server will apply all pre and post tasks, according to the rule used, and also the error tasks if any.</p>
<p>Therefore, it allows to use this transfer to reroute it to another Waarp server (using other Waarp protocols), or to execute a task that will manage the content of this file for another application, potentially also embedded by the same Web Application server.</p></section></section></section><section>
<h3><a name="a1.2.29_For_Download"></a>1.2) For Download</h3>
<p>This part is partially developed, since the availability of files to be downloaded is part of the integration process. Therefore the HTML part and some of the javascript are given but it is straightforward to adapt it to specific download scenario.</p>
<p>Once the file is selected, the javascript download all the file and then compares the received file with the received Hash (SHA-256) from the Waarp Web Server.</p><section>
<h4><a name="The_client_perspective"></a>The client perspective</h4>
<p>The download follows the Waarp rules of transfers:</p>
<ul>
<li>a local unique identifier is assigned to the transfer</li>
<li>a rule of transfer is selected (in Recv mode)</li>
<li>an identifier of the user is selected</li>
<li>the name of the file to download</li></ul><section>
<h5><a name="Visual_comportment"></a>Visual comportment</h5>
<p>The file download is the usual download from the web browser, except, through integration, the check of the hash computed by the Waarp Web Server to check within the client's browser. Currently, there is a demo feature where you click on the button once downloaded the file, select the file downloaded and it checks the hash according to the very last item downloaded from the Waarp Web Server.</p>
<p>Therefore, there is no resumable download yet, since javascript is not able to write directly to a local file (security reasons). However a javascript can check the downloaded file once it is done.</p></section></section><section>
<h4><a name="Waarp_Web_Server_perspective"></a>Waarp Web Server perspective</h4>
<p>From Waarp Web Server perspective, this transfer is as a &quot;usual&quot; transfer, using the standard database of Waarp product. </p><section>
<h5><a name="Functional_Comportment"></a>Functional Comportment</h5>
<p>The unique identifier is given by the client. </p>
<p>The hash is computed by the server and sent to the client, which allows the client to check against it.</p>
<p>The rule is given by the client. The Waarp Web Server will apply all pre and post tasks, according to the rule used, and also the error tasks if any.</p>
<p>Therefore, it allows to use this transfer to execute a task that will manage the content of this file from another application, potentially also embedded by the same Web Application server.</p></section></section></section></section><section>
<h2><a name="a2.29_Integration_focus"></a>2) Integration focus</h2><section>
<h3><a name="a2.1.29_Web_Integration"></a>2.1) Web Integration</h3>
<p>You can use any Servlet server accepting 3.1 servlet versions (such as Jetty, Tomcat).</p>
<ul>
<li>Install the `WaarpHttp-X.Y.Z-jar-with-dependencies.jar` (containing all dependencies) within an application directory of a web server, such as Tomcat or Jetty.</li>
<li>Create a `webapp` directory for WaarpHttp, containing the files and subdirectories as in `WaarpHttp/src/main/webapp`</li>
<li>In the WEB-INF directory, define the necessary entries in the `web.xml`, such as the one in example in `WaarpHttp/src/main/webapp/WEB-INF/web.xml`
<p>For instance, for Jetty, the following configuration can be used:</p></li>
<li>Path: `/WaarpHttp`</li>
<li>WebApp directory: `/WaarpHttp/src/main/webapp`</li>
<li>WebApp Class directory: where you put the `WaarpHttp-X.Y.Z-jar-with-dependencies.jar`</li>
<li>Extra argument for Jetty: `-Dlogback.configurationFile=/WaarpHttp/test/resources/logback.xml`
<p>Therefore the url of the two servlet will be:</p></li>
<li>`http://server:port/WaarpHttp/resumable` (upload)</li>
<li>`http://server:port/WaarpHttp/download` (download)</li></ul></section><section>
<h3><a name="a2.2.29_Missing_integration"></a>2.2) Missing integration</h3><section>
<h4><a name="Authentication"></a>Authentication</h4>
<p>In the prototype, even if the authentication relies on Waarp repository, it is currently hard coded in the javascript of the web page. So you should obviously use the authentication of your company and integrates it within the code by specifying the right class to use for authentication (see `authentClassName` in `web.xml`).</p></section><section>
<h4><a name="Selection_of_rule_to_apply"></a>Selection of rule to apply</h4>
<p>In the prototype, even if the authentication relies on Waarp repository, it is currently hard coded in the javascript of the web page. So you should obviously either change it to a specific fixed value or propose a way for the final user to select a correct value, according to his/her rights.</p></section><section>
<h4><a name="Selection_of_file_to_download_.28Download.29"></a>Selection of file to download (Download)</h4>
<p>The prototype is very simple with fixed files. One should take care to create the file before running the Jetty server (`test.txt` and `test2.bin` in `/tmp/R66/out` directory). Take a look at the Junit tests (`DownloadServletTest`) to see what to send and what is returned. But obviously you should provide a way to propose various files for the end user according to his/her rights.</p></section><section>
<h4><a name="Initialization_of_the_database"></a>Initialization of the database</h4>
<p>To run the prototype, you should initialize the database. To do it simply, you can use the test named `InitDatabase` by commenting the `@Ignore` specification. </p></section><section>
<h4><a name="Extra_elements"></a>Extra elements</h4>
<p>One could integrate also some extra features such as:</p>
<ul>
<li>testing if a file was already sent before (Hash based comparison)</li>
<li>allowing to see historic of transfers</li>
<li>... </li></ul></section></section><section>
<h3><a name="a2.3.29_Web_integration_for_Upload"></a>2.3) Web integration for Upload</h3><section>
<h4><a name="Specific_file_configurations"></a>Specific file configurations</h4><section>
<h5><a name="Content_of_.60web.xml.60"></a>Content of `web.xml`</h5>
<ul>
<li>`servlet-class` points to the Java Servlet, here `org.waarp.http.protocol.servlet.UploadServlet`
<ul>
<li>One could write another servlet implementation, inspiring from this default servlet</li></ul></li>
<li>`init-param` contains the parameter `r66config` which has to point to the xml R66 configuration file * `init-param` contains the parameter `authentClassName` which has to point to the Java implementation for the authentication, here simple one is `org.waarp.http.protocol.servlet.HttpAuthentDefault`
<ul>
<li>One could write another authentication implementation, inspiring from this default servlet</li></ul></li>
<li>`servlet-mapping` points to the Java Servlet name, here `UploadServlet` and its `url-pattern`
<ul>
<li>Note this has to be different than Download, and remember that the configuration of the Application server could prepend an extra url
<div class="source">
<pre>        &lt;servlet&gt;
            &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
            &lt;servlet-class&gt;org.waarp.http.protocol.servlet.UploadServlet&lt;/servlet-class&gt;
            &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
            &lt;init-param&gt;
                &lt;param-name&gt;r66config&lt;/param-name&gt;
                &lt;param-value&gt;/tmp/R66/conf/config-serverA-minimal.xml&lt;/param-value&gt;
            &lt;/init-param&gt;
            &lt;init-param&gt;
                &lt;param-name&gt;authentClassName&lt;/param-name&gt;
                &lt;param-value&gt;org.waarp.http.protocol.servlet.HttpAuthentDefault&lt;/param-value&gt;
            &lt;/init-param&gt;
        &lt;/servlet&gt;
        &lt;servlet-mapping&gt;
            &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
            &lt;url-pattern&gt;/resumable&lt;/url-pattern&gt;
        &lt;/servlet-mapping&gt;</pre></div></li></ul></li></ul></section><section>
<h5><a name="Content_of_.60index.html.60"></a>Content of `index.html`</h5>
<p>A prototype file is given. As this is only an example, the user authentication and rule selection is fixed in the javascript part as:</p>
<div class="source">
<pre>      &lt;script&gt;
      // Configuration to adapt with real authentication and selection of rule (send) to apply
            var user = &quot;test&quot;;
            var key = &quot;ef99dfce1fdaa787cef4701368f79cfb&quot;;
            var rulename = &quot;rule3&quot;;
            var comment = &quot;Web Upload&quot;;
            setIdHiddenHash(&quot;finalhash&quot;); // Used by compute-hash.js to store the result
      &lt;/script&gt;</pre></div>
<p>`finalhash` is the id of an hidden input field, such as:</p>
<div class="source">
<pre>      &lt;input type=&quot;hidden&quot; name=&quot;finalhash&quot; id=&quot;finalhash&quot; value=&quot;&quot;&gt;</pre></div>
<p>Therefore, one should adapt this page or service to add a specific authentication system and a way to select a rule accordingly, as to provide a specific comment if any.</p>
<p>The methods used are:</p>
<div class="source">
<pre>    GET/POST http(s)://server-url/base-url/resumable
      body or url arguments:
        &quot;user&quot;: username/servername from Waarp repository
        &quot;key&quot;: associated key for this user
        &quot;rulename&quot;: rulename from Waarp repository
        &quot;comment&quot;: actual comment to set for this transfer
        // Below parameters are set by the external javascript
        &quot;resumableChunkNumber&quot;: the current chunk
        &quot;resumableChunkSize&quot;: the size of this chunk
        &quot;resumableTotalSize&quot;: the total size of the file
        &quot;resumableIdentifier&quot;: unique identifier, set using Javascript function uuidv4()
        &quot;resumableFilename&quot;: the filename for the upload
        &quot;resumableRelativePath&quot;: relative path of the file
    Answer:
        GET: 404 Transfer or Chunk not found, 200 Transfer chunk found
        POST: 201 First chunk ok (creation of the transfer), 200 All chunks received
        Both: 500 Internal error such as wrong authentication or arguments (prevents DDOS)</pre></div>
<p>One could also change some general options of Resumable.js javascript module:</p>
<div class="source">
<pre>    var r = new Resumable({
         target:'/WaarpHttp/resumable', // Target for Waarp servlet according to Application Web server
         forceChunkSize: true, // Recommended
         chunkSize:1*1024*1024, // Might be less but not less than 1024
         simultaneousUploads:1, // Mandatory
         testChunks: true, // Not mandatory, one could skip existence of previous chunks
         throttleProgressCallbacks:1,
         method: &quot;multipart&quot;, // &quot;octet&quot; for url args + chunk in body, &quot;multipart&quot; for standard UPLOAD
         generateUniqueIdentifier: uuidv4, // Recommended
         preprocessFile: initSha256, // Recommended
         query: queryArgs // Recommended
       }); </pre></div></section></section></section><section>
<h3><a name="a2.4.29_Web_integration_for_the_Download"></a>2.4) Web integration for the Download</h3><section>
<h4><a name="Specific_file_configurations"></a>Specific file configurations</h4><section>
<h5><a name="Content_of_.60web.xml.60"></a>Content of `web.xml`</h5>
<ul>
<li>`servlet-class` points to the Java Servlet, here `org.waarp.http.protocol.servlet.DownloadServlet`
<ul>
<li>One could write another servlet implementation, inspiring from this default servlet</li></ul></li>
<li>`init-param` contains the parameter `r66config` which has to point to the xml R66 configuration file</li>
<li>`init-param` contains the parameter `authentClassName` which has to point to the Java implementation for the authentication, here simple one is `org.waarp.http.protocol.servlet.HttpAuthentDefault`
<ul>
<li>One could write another authentication implementation, inspiring from this default servlet</li></ul></li>
<li>`servlet-mapping` points to the Java Servlet name, here `DownloadServlet` and its `url-pattern`
<ul>
<li>Note this has to be different than Upload, and remember that the configuration of the Application server could prepend an extra url
<div class="source">
<pre>        &lt;servlet&gt;
            &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
            &lt;servlet-class&gt;org.waarp.http.protocol.servlet.DownloadServlet&lt;/servlet-class&gt;
            &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
            &lt;init-param&gt;
                &lt;param-name&gt;r66config&lt;/param-name&gt;
                &lt;param-value&gt;/tmp/R66/conf/config-serverA-minimal.xml&lt;/param-value&gt;
            &lt;/init-param&gt;
            &lt;init-param&gt;
                &lt;param-name&gt;authentClassName&lt;/param-name&gt;
                &lt;param-value&gt;org.waarp.http.protocol.servlet.HttpAuthentDefault&lt;/param-value&gt;
            &lt;/init-param&gt;
        &lt;/servlet&gt;
        &lt;servlet-mapping&gt;
            &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
            &lt;url-pattern&gt;/download&lt;/url-pattern&gt;
        &lt;/servlet-mapping&gt;</pre></div></li></ul></li></ul></section><section>
<h5><a name="Content_of_.60index.html.60"></a>Content of `index.html`</h5>
<p>This file is not written for Download, since the listing of the available files is out of the responsibility of this module. But mainly, the code is to apply a call such as:</p>
<div class="source">
<pre>    GET/POST http(s)://server-url/base-url/download
      body or url arguments:
        &quot;user&quot;: username/servername from Waarp repository
        &quot;key&quot;: associated key for this user
        &quot;rulename&quot;: rulename from Waarp repository
        &quot;comment&quot;: actual comment to set for this transfer
        &quot;identifier&quot;: unique identifier, preferably using Javascript function uuidv4()
        &quot;filename&quot;: filename to download (according to rule)
    Answer:
       header: 
        &quot;X-Hash-Sha-256&quot;: HEX representation of SHA-256 of downloaded file
       body:
        the file
     
    HEAD http(s)://server-url/base-url/download
          body or url arguments:
            &quot;user&quot;: username/servername from Waarp repository
            &quot;key&quot;: associated key for this user
            &quot;rulename&quot;: rulename from Waarp repository
            &quot;comment&quot;: actual comment to set for this transfer
            &quot;identifier&quot;: unique identifier, preferably using Javascript function uuidv4()
            &quot;filename&quot;: filename to download (according to rule)
        Answer: 404 if not found, 202 if still on going, 200 if done
           header: 
            &quot;X-Hash-Sha-256&quot;: HEX representation of SHA-256 of downloaded file if status 200</pre></div></section></section></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2019&#x2013;2022<a href="http://www.waarp.fr">Waarp</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
