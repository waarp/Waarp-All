<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractBusinessRequest.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Administrator</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.client</a> &gt; <span class="el_source">AbstractBusinessRequest.java</span></div><h1>AbstractBusinessRequest.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.client;

import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.logging.WaarpSlf4JLoggerFactory;
import org.waarp.common.utility.DetectionUtils;
import org.waarp.openr66.client.utils.OutputFormat;
import org.waarp.openr66.configuration.FileBasedConfiguration;
import org.waarp.openr66.context.ErrorCode;
import org.waarp.openr66.context.R66FiniteDualStates;
import org.waarp.openr66.context.authentication.R66Auth;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolNoConnectionException;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolPacketException;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.packet.BusinessRequestPacket;
import org.waarp.openr66.protocol.networkhandler.NetworkTransaction;
import org.waarp.openr66.protocol.utils.ChannelUtils;
import org.waarp.openr66.protocol.utils.R66Future;

import java.net.SocketAddress;

import static org.waarp.openr66.database.DbConstantR66.*;

/**
 * Abstract class for internal Business Request
 */
public abstract class AbstractBusinessRequest implements Runnable {
  /**
   * Internal Logger
   */
  protected static volatile WaarpLogger logger;

<span class="nc" id="L55">  protected static final String _INFO_ARGS =</span>
<span class="nc" id="L56">      Messages.getString(&quot;AbstractBusinessRequest.0&quot;) //$NON-NLS-1$</span>
<span class="nc" id="L57">      + Messages.getString(&quot;Message.OutputFormat&quot;);</span>

  protected final R66Future future;

  protected final String remoteHost;

  protected final NetworkTransaction networkTransaction;

  private final BusinessRequestPacket businessPacket;

  private LocalChannelReference localChannelReference;

  protected AbstractBusinessRequest(Class&lt;?&gt; clasz, R66Future future,
                                    String remoteHost,
                                    NetworkTransaction networkTransaction,
<span class="nc" id="L72">                                    BusinessRequestPacket packet) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if (logger == null) {</span>
<span class="nc" id="L74">      logger = WaarpLoggerFactory.getLogger(clasz);</span>
    }
<span class="nc" id="L76">    this.future = future;</span>
<span class="nc" id="L77">    this.remoteHost = remoteHost;</span>
<span class="nc" id="L78">    this.networkTransaction = networkTransaction;</span>
<span class="nc" id="L79">    businessPacket = packet;</span>
<span class="nc" id="L80">  }</span>

  @Override
  public void run() {
    try {
<span class="nc" id="L85">      initRequest();</span>
<span class="nc" id="L86">      sendRequest();</span>
<span class="nc" id="L87">    } catch (final OpenR66ProtocolNoConnectionException ignored) {</span>
      // notning
<span class="nc" id="L89">    }</span>
<span class="nc" id="L90">  }</span>

  public void initRequest() throws OpenR66ProtocolNoConnectionException {
<span class="nc" id="L93">    final DbHostAuth host = R66Auth.getServerAuth(remoteHost);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">    if (host == null) {</span>
<span class="nc" id="L95">      future.setResult(null);</span>
<span class="nc" id="L96">      final OpenR66ProtocolNoConnectionException e2 =</span>
          new OpenR66ProtocolNoConnectionException(
<span class="nc" id="L98">              Messages.getString(&quot;AdminR66OperationsGui.188&quot;) +</span>
              remoteHost); //$NON-NLS-1$
<span class="nc" id="L100">      future.setFailure(e2);</span>
<span class="nc" id="L101">      throw e2;</span>
    }
    final SocketAddress socketServerAddress;
    try {
<span class="nc" id="L105">      socketServerAddress = host.getSocketAddress();</span>
<span class="nc" id="L106">    } catch (final IllegalArgumentException e) {</span>
<span class="nc" id="L107">      future.setResult(null);</span>
<span class="nc" id="L108">      final OpenR66ProtocolNoConnectionException e2 =</span>
          new OpenR66ProtocolNoConnectionException(
<span class="nc" id="L110">              Messages.getString(&quot;AdminR66OperationsGui.188&quot;) +</span>
              host); //$NON-NLS-1$
<span class="nc" id="L112">      future.setFailure(e2);</span>
<span class="nc" id="L113">      throw e2;</span>
<span class="nc" id="L114">    }</span>
<span class="nc" id="L115">    final boolean isSSL = host.isSsl();</span>
<span class="nc" id="L116">    localChannelReference = networkTransaction</span>
<span class="nc" id="L117">        .createConnectionWithRetry(socketServerAddress, isSSL, future);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (localChannelReference == null) {</span>
<span class="nc" id="L119">      future.setResult(null);</span>
<span class="nc" id="L120">      final OpenR66ProtocolNoConnectionException e =</span>
          new OpenR66ProtocolNoConnectionException(
<span class="nc" id="L122">              Messages.getString(&quot;AdminR66OperationsGui.188&quot;) +</span>
              host); //$NON-NLS-1$
<span class="nc" id="L124">      future.setFailure(e);</span>
<span class="nc" id="L125">      throw e;</span>
    }
<span class="nc" id="L127">    localChannelReference.sessionNewState(R66FiniteDualStates.BUSINESSR);</span>
<span class="nc" id="L128">  }</span>

  public void sendRequest() {
    try {
<span class="nc" id="L132">      ChannelUtils</span>
<span class="nc" id="L133">          .writeAbstractLocalPacket(localChannelReference, businessPacket,</span>
                                    false);
<span class="nc" id="L135">    } catch (final OpenR66ProtocolPacketException e) {</span>
<span class="nc" id="L136">      future.setResult(null);</span>
<span class="nc" id="L137">      future.setFailure(e);</span>
<span class="nc" id="L138">      localChannelReference.close();</span>
<span class="nc" id="L139">    }</span>

<span class="nc" id="L141">  }</span>

  /**
   * Dummy Main method
   *
   * @param args
   */
  public static void main(String[] args) {
<span class="nc" id="L149">    WaarpLoggerFactory.setDefaultFactory(new WaarpSlf4JLoggerFactory(null));</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">    if (logger == null) {</span>
<span class="nc" id="L151">      logger = WaarpLoggerFactory.getLogger(AbstractBusinessRequest.class);</span>
    }
<span class="nc bnc" id="L153" title="All 2 branches missed.">    if (!getParams(args)) {</span>
<span class="nc" id="L154">      logger.error(&quot;Wrong initialization&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">      if (admin != null) {</span>
<span class="nc" id="L156">        admin.close();</span>
      }
<span class="nc bnc" id="L158" title="All 2 branches missed.">      if (DetectionUtils.isJunit()) {</span>
<span class="nc" id="L159">        return;</span>
      }
<span class="nc" id="L161">      ChannelUtils.stopLogger();</span>
<span class="nc" id="L162">      System.exit(2);//NOSONAR</span>
    }

<span class="nc" id="L165">    Configuration.configuration.pipelineInit();</span>
<span class="nc" id="L166">    final NetworkTransaction networkTransaction = new NetworkTransaction();</span>
<span class="nc" id="L167">    final R66Future future = new R66Future(true);</span>

<span class="nc" id="L169">    logger.info(&quot;Start Test of Transaction&quot;);</span>
<span class="nc" id="L170">    final long time1 = System.currentTimeMillis();</span>

<span class="nc" id="L172">    new BusinessRequestPacket(classname + ' ' + classarg, 0);</span>
    // XXX FIXME this has to be adapted
    /*
     * AbstractBusinessRequest transaction = new AbstractBusinessRequest( AbstractBusinessRequest.class, future,
     * rhost, networkTransaction, packet); transaction.run(); future.awaitUninterruptibly()
     */
<span class="nc" id="L178">    final long time2 = System.currentTimeMillis();</span>
<span class="nc" id="L179">    logger.debug(&quot;Finish Business Request: &quot; + future.isSuccess());</span>
<span class="nc" id="L180">    final long delay = time2 - time1;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">    if (future.isSuccess()) {</span>
<span class="nc" id="L182">      logger.info(</span>
          &quot;Business Request in status: SUCCESS&quot; + &quot;    &lt;REMOTE&gt;&quot; + rhost +
          &quot;&lt;/REMOTE&gt;&quot; + &quot;    delay: &quot; + delay);
    } else {
<span class="nc" id="L186">      logger.info(</span>
          &quot;Business Request in status: FAILURE&quot; + &quot;    &lt;REMOTE&gt;&quot; + rhost +
<span class="nc" id="L188">          &quot;&lt;/REMOTE&gt;&quot; + &quot;    &lt;ERROR&gt;&quot; + future.getCause() + &quot;&lt;/ERROR&gt;&quot; +</span>
          &quot;    delay: &quot; + delay);
<span class="nc bnc" id="L190" title="All 2 branches missed.">      if (DetectionUtils.isJunit()) {</span>
<span class="nc" id="L191">        return;</span>
      }
<span class="nc" id="L193">      networkTransaction.closeAll();</span>
<span class="nc" id="L194">      System.exit(ErrorCode.Unknown.ordinal());//NOSONAR</span>
    }
<span class="nc" id="L196">    networkTransaction.closeAll();</span>
<span class="nc" id="L197">  }</span>

  protected static String rhost;
  protected static String classname;
  protected static String classarg;
  protected static boolean nolog;

  /**
   * Parse the parameter and set current values
   *
   * @param args
   *
   * @return True if all parameters were found and correct
   */
  protected static boolean getParams(String[] args) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">    if (args.length &lt; 3) {</span>
<span class="nc" id="L213">      logger.error(_INFO_ARGS);</span>
<span class="nc" id="L214">      return false;</span>
    }
<span class="nc" id="L216">    if (!FileBasedConfiguration</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        .setClientConfigurationFromXml(Configuration.configuration, args[0])) {</span>
<span class="nc" id="L218">      logger.error(</span>
<span class="nc" id="L219">          Messages.getString(&quot;Configuration.NeedCorrectConfig&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L220">      return false;</span>
    }
    // Now set default values from configuration
<span class="nc bnc" id="L223" title="All 2 branches missed.">    for (int i = 1; i &lt; args.length; i++) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">      if (&quot;-to&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L225">        i++;</span>
<span class="nc" id="L226">        rhost = args[i];</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (Configuration.configuration.getAliases().containsKey(rhost)) {</span>
<span class="nc" id="L228">          rhost = Configuration.configuration.getAliases().get(rhost);</span>
        }
<span class="nc bnc" id="L230" title="All 2 branches missed.">      } else if (&quot;-class&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L231">        i++;</span>
<span class="nc" id="L232">        classname = args[i];</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">      } else if (&quot;-arg&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L234">        i++;</span>
<span class="nc" id="L235">        classarg = args[i];</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">      } else if (&quot;-nolog&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L237">        nolog = true;</span>
<span class="nc" id="L238">        i++;</span>
      }
    }
<span class="nc" id="L241">    OutputFormat.getParams(args);</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">    if (rhost != null &amp;&amp; classname != null) {</span>
<span class="nc" id="L243">      return true;</span>
    }
<span class="nc" id="L245">    logger.error(Messages.getString(&quot;AbstractBusinessRequest.NeedMoreArgs&quot;,</span>
                                    &quot;(-to -class)&quot;) + _INFO_ARGS); //$NON-NLS-1$
<span class="nc" id="L247">    return false;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>