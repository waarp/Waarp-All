<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SystemPropertyUtil.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Ftp</a> &gt; <a href="../index.html" class="el_bundle">WaarpCommon</a> &gt; <a href="index.source.html" class="el_package">org.waarp.common.utility</a> &gt; <span class="el_source">SystemPropertyUtil.java</span></div><h1>SystemPropertyUtil.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.common.utility;

import org.waarp.common.exception.InvalidArgumentException;
import org.waarp.common.logging.SysErrLogger;

import java.io.PrintStream;
import java.lang.reflect.Field;
import java.nio.charset.Charset;
import java.util.Properties;

import static org.waarp.common.digest.WaarpBC.*;

/**
 * A collection of utility methods to retrieve and parse the values of the Java
 * system properties.
 */
public final class SystemPropertyUtil {
  // Since logger could be not available yet, one must not declare there a Logger

  private static final String USING_THE_DEFAULT_VALUE2 =
      &quot;using the default value: &quot;;
  private static final String FIND_0_9 = &quot;-?[0-9]+&quot;;
  private static final String USING_THE_DEFAULT_VALUE =
      USING_THE_DEFAULT_VALUE2;
  public static final String FILE_ENCODING = &quot;file.encoding&quot;;
  /**
   * Maximum Connections to the Database. Waarp will manage by default up
   * to 10 connections, except if this is set. The minimum value is 2.
   */
  public static final String WAARP_DATABASE_CONNECTION_MAX =
      &quot;waarp.database.connection.max&quot;;
  private static final String IO_NETTY_ALLOCATOR_TYPE =
      &quot;io.netty.allocator.type&quot;;
  private static final String IO_POOLED = &quot;pooled&quot;;
  private static final String IO_NETTY_NOPREFERDIRECT =
      &quot;io.netty.noPreferDirect&quot;;
  /**
   * Recommended value is 0. Giving too small valud (&gt;0) coud cause issues.
   * Value of -1 is default behavior of Netty.
   * Value of 0 allows Netty to allocate more memory but still
   * stable.
   * If &lt;0, means Netty use twice Direct memory from JDK and don't use cleaner.
   * If 0, means Netty use the max JDK Direct ram and use Cleaner (recommended).
   * If &gt;0, means Netty use this max Direct, not related to max of JDK, and
   * don't use cleaner.
   */
  private static final String IO_NETTY_MAXDIRECTMEMORY =
      &quot;io.netty.maxDirectMemory&quot;;

<span class="fc" id="L69">  private static final Properties PROPS = new Properties();</span>
  private static final String INVALID_PROPERTY = &quot;Invalid property &quot;;
  public static final String JAVAX_XML_TRANSFORM_TRANSFORMER_FACTORY =
      &quot;javax.xml.transform.TransformerFactory&quot;;
  public static final String NET_SF_SAXON_TRANSFORMER_FACTORY_IMPL =
      &quot;net.sf.saxon.TransformerFactoryImpl&quot;;
  private static Platform mOs;

  // Retrieve all system properties at once so that there's no need to deal with
  // security exceptions from next time. Otherwise, we might end up with logging every
  // security exceptions on every system property access or introducing more complexity
  // just because of less verbose logging.
  static {
<span class="fc" id="L82">    refresh();</span>
<span class="fc" id="L83">    initializedTlsContext();</span>
<span class="fc" id="L84">  }</span>

  /**
   * Re-retrieves all system properties so that any post-launch properties
   * updates are retrieved.
   */
  public static void refresh() {
    Properties newProps;
    try {
<span class="fc" id="L93">      newProps = System.getProperties();</span>
<span class="nc" id="L94">    } catch (final SecurityException e) {</span>
<span class="nc" id="L95">      SysErrLogger.FAKE_LOGGER.ignoreLog(e);</span>
<span class="nc" id="L96">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;Unable to retrieve the system properties; default values will be used: &quot; +
<span class="nc" id="L98">          e.getMessage());</span>
<span class="nc" id="L99">      newProps = new Properties();</span>
<span class="fc" id="L100">    }</span>

<span class="fc" id="L102">    synchronized (PROPS) {</span>
<span class="fc" id="L103">      PROPS.clear();</span>
<span class="fc" id="L104">      PROPS.putAll(newProps);</span>
<span class="fc" id="L105">    }</span>
    // Ensure Pooled allocator except if something different set
<span class="fc bfc" id="L107" title="All 2 branches covered.">    if (!contains(IO_NETTY_ALLOCATOR_TYPE) ||</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        ParametersChecker.isEmpty(get(IO_NETTY_ALLOCATOR_TYPE))) {</span>
      try {
<span class="fc" id="L110">        System.setProperty(IO_NETTY_ALLOCATOR_TYPE, IO_POOLED);</span>
<span class="fc" id="L111">        synchronized (PROPS) {</span>
<span class="fc" id="L112">          PROPS.clear();</span>
<span class="fc" id="L113">          PROPS.putAll(newProps);</span>
<span class="fc" id="L114">        }</span>
<span class="fc" id="L115">        SysErrLogger.FAKE_LOGGER.sysout(IO_NETTY_ALLOCATOR_TYPE + &quot;:&quot; +</span>
<span class="fc" id="L116">                                        io.netty.util.internal.SystemPropertyUtil.get(</span>
                                            IO_NETTY_ALLOCATOR_TYPE));
<span class="nc" id="L118">      } catch (final Throwable ignored) {//NOSONAR</span>
<span class="nc" id="L119">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="fc" id="L120">      }</span>
    }
    // Ensure minimize DIRECT except if something different set
<span class="fc bfc" id="L123" title="All 2 branches covered.">    if (!contains(IO_NETTY_NOPREFERDIRECT) ||</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        ParametersChecker.isEmpty(get(IO_NETTY_NOPREFERDIRECT))) {</span>
      try {
<span class="fc" id="L126">        System.setProperty(IO_NETTY_NOPREFERDIRECT, &quot;true&quot;);</span>
<span class="fc" id="L127">        synchronized (PROPS) {</span>
<span class="fc" id="L128">          PROPS.clear();</span>
<span class="fc" id="L129">          PROPS.putAll(newProps);</span>
<span class="fc" id="L130">        }</span>
<span class="fc" id="L131">        SysErrLogger.FAKE_LOGGER.sysout(IO_NETTY_NOPREFERDIRECT + &quot;:&quot; +</span>
<span class="fc" id="L132">                                        io.netty.util.internal.SystemPropertyUtil.get(</span>
                                            IO_NETTY_NOPREFERDIRECT));
<span class="nc" id="L134">      } catch (final Throwable ignored) {//NOSONAR</span>
<span class="nc" id="L135">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="fc" id="L136">      }</span>
    }
    // Ensure minimize Direct except if something different set
<span class="fc bfc" id="L139" title="All 2 branches covered.">    if (!contains(IO_NETTY_MAXDIRECTMEMORY) ||</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        ParametersChecker.isEmpty(get(IO_NETTY_MAXDIRECTMEMORY))) {</span>
      try {
<span class="fc" id="L142">        System.setProperty(IO_NETTY_MAXDIRECTMEMORY, &quot;0&quot;);</span>
<span class="fc" id="L143">        synchronized (PROPS) {</span>
<span class="fc" id="L144">          PROPS.clear();</span>
<span class="fc" id="L145">          PROPS.putAll(newProps);</span>
<span class="fc" id="L146">        }</span>
<span class="fc" id="L147">        SysErrLogger.FAKE_LOGGER.sysout(IO_NETTY_MAXDIRECTMEMORY + &quot;:&quot; +</span>
<span class="fc" id="L148">                                        io.netty.util.internal.SystemPropertyUtil.get(</span>
                                            IO_NETTY_MAXDIRECTMEMORY));
<span class="nc" id="L150">      } catch (final Throwable ignored) {//NOSONAR</span>
<span class="nc" id="L151">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="fc" id="L152">      }</span>
    }
<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (!contains(JAVAX_XML_TRANSFORM_TRANSFORMER_FACTORY) ||</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        ParametersChecker.isEmpty(</span>
<span class="fc" id="L156">            get(JAVAX_XML_TRANSFORM_TRANSFORMER_FACTORY))) {</span>
      try {
<span class="fc" id="L158">        System.setProperty(JAVAX_XML_TRANSFORM_TRANSFORMER_FACTORY,</span>
                           NET_SF_SAXON_TRANSFORMER_FACTORY_IMPL);
<span class="fc" id="L160">        synchronized (PROPS) {</span>
<span class="fc" id="L161">          PROPS.clear();</span>
<span class="fc" id="L162">          PROPS.putAll(newProps);</span>
<span class="fc" id="L163">        }</span>
<span class="nc" id="L164">      } catch (final Throwable ignored) {//NOSONAR</span>
<span class="nc" id="L165">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="fc" id="L166">      }</span>
    }
<span class="fc bfc" id="L168" title="All 2 branches covered.">    if (!contains(FILE_ENCODING) ||</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        !WaarpStringUtils.UTF_8.equalsIgnoreCase(get(FILE_ENCODING))) {</span>
      try {
<span class="fc" id="L171">        System.setProperty(FILE_ENCODING, WaarpStringUtils.UTF_8);</span>
        try {
<span class="fc" id="L173">          final Field charset =</span>
<span class="fc" id="L174">              Charset.class.getDeclaredField(&quot;defaultCharset&quot;);</span>
<span class="fc" id="L175">          charset.setAccessible(true); //NOSONAR</span>
<span class="fc" id="L176">          charset.set(null, null); //NOSONAR</span>
<span class="nc" id="L177">        } catch (final Throwable e) {//NOSONAR</span>
<span class="nc" id="L178">          SysErrLogger.FAKE_LOGGER.ignoreLog(e);</span>
<span class="fc" id="L179">        }</span>
<span class="fc" id="L180">        synchronized (PROPS) {</span>
<span class="fc" id="L181">          PROPS.clear();</span>
<span class="fc" id="L182">          PROPS.putAll(newProps);</span>
<span class="fc" id="L183">        }</span>
<span class="nc" id="L184">      } catch (final Throwable e1) {//NOSONAR</span>
        // ignore since it is a security issue and -Dfile.encoding=UTF-8 should be used
<span class="nc" id="L186">        SysErrLogger.FAKE_LOGGER.ignoreLog(e1);</span>
<span class="nc" id="L187">        SysErrLogger.FAKE_LOGGER.syserr(</span>
            &quot;Issue while trying to set UTF-8 as default file encoding: use -Dfile.encoding=UTF-8 as java command argument: &quot; +
<span class="nc" id="L189">            e1.getMessage());</span>
<span class="nc" id="L190">        SysErrLogger.FAKE_LOGGER.syserr(</span>
<span class="nc" id="L191">            &quot;Currently file.encoding is: &quot; + get(FILE_ENCODING));</span>
<span class="fc" id="L192">      }</span>
    }
<span class="fc" id="L194">  }</span>

  /**
   * @return True if Encoding is Correct
   */
  public static boolean isFileEncodingCorrect() {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">    return contains(FILE_ENCODING) &amp;&amp;</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">           WaarpStringUtils.UTF_8.equalsIgnoreCase(get(FILE_ENCODING));</span>
  }

  /**
   * Returns {@code true} if and only if the system property with the
   * specified
   * {@code key} exists.
   */
  public static boolean contains(final String key) {
<span class="fc" id="L210">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L211">    return PROPS.containsKey(key);</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to
   * {@code null} if the property access fails.
   *
   * @return the property value or {@code null}
   */
  public static String get(final String key) {
<span class="fc" id="L222">    return get(key, null);</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static String get(final String key, final String def) {
<span class="fc" id="L240">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L241">    String value = PROPS.getProperty(key);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L243">      return def;</span>
    }

    try {
<span class="fc" id="L247">      value = ParametersChecker.checkSanityString(value);</span>
<span class="nc" id="L248">    } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L249">      SysErrLogger.FAKE_LOGGER.syserr(INVALID_PROPERTY + key, e);</span>
<span class="nc" id="L250">      return def;</span>
<span class="fc" id="L251">    }</span>

<span class="fc" id="L253">    return value;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static boolean get(final String key, final boolean def) {
<span class="fc" id="L271">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L272">    String value = PROPS.getProperty(key);</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L274">      return def;</span>
    }

<span class="fc" id="L277">    value = value.trim().toLowerCase();</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">    if (value.isEmpty()) {</span>
<span class="fc" id="L279">      return true;</span>
    }

<span class="fc bfc" id="L282" title="All 6 branches covered.">    if (&quot;true&quot;.equals(value) || &quot;yes&quot;.equals(value) || &quot;1&quot;.equals(value)) {</span>
<span class="fc" id="L283">      return true;</span>
    }

<span class="pc bpc" id="L286" title="2 of 6 branches missed.">    if (&quot;false&quot;.equals(value) || &quot;no&quot;.equals(value) || &quot;0&quot;.equals(value)) {</span>
<span class="fc" id="L287">      return false;</span>
    }
    try {
<span class="fc" id="L290">      ParametersChecker.checkSanityString(value);</span>
<span class="nc" id="L291">    } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L292">      SysErrLogger.FAKE_LOGGER.syserr(INVALID_PROPERTY + key, e);</span>
<span class="nc" id="L293">      return def;</span>
<span class="fc" id="L294">    }</span>
<span class="fc" id="L295">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the boolean system property '&quot; + key + &quot;':&quot; + value +
        &quot; - &quot; + USING_THE_DEFAULT_VALUE + def);

<span class="fc" id="L299">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key the system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static int get(final String key, final int def) {
<span class="fc" id="L317">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L318">    String value = PROPS.getProperty(key);</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L320">      return def;</span>
    }

<span class="fc" id="L323">    value = value.trim().toLowerCase();</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">    if (value.matches(FIND_0_9)) {</span>
      try {
<span class="fc" id="L326">        return Integer.parseInt(value);</span>
<span class="nc" id="L327">      } catch (final Exception ignored) {</span>
        // Since logger could be not available yet
        // Ignore
<span class="nc" id="L330">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
      }
    }
    try {
<span class="fc" id="L334">      ParametersChecker.checkSanityString(value);</span>
<span class="nc" id="L335">    } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L336">      SysErrLogger.FAKE_LOGGER.syserr(INVALID_PROPERTY + key, e);</span>
<span class="nc" id="L337">      return def;</span>
<span class="fc" id="L338">    }</span>
<span class="fc" id="L339">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the integer system property '&quot; + key + &quot;':&quot; + value +
        &quot; - &quot; + USING_THE_DEFAULT_VALUE + def);

<span class="fc" id="L343">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static long get(final String key, final long def) {
<span class="fc" id="L361">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L362">    String value = PROPS.getProperty(key);</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L364">      return def;</span>
    }

<span class="fc" id="L367">    value = value.trim().toLowerCase();</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">    if (value.matches(FIND_0_9)) {</span>
      try {
<span class="fc" id="L370">        return Long.parseLong(value);</span>
<span class="nc" id="L371">      } catch (final Exception ignored) {</span>
        // Since logger could be not available yet
        // Ignore
<span class="nc" id="L374">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
      }
    }
    try {
<span class="fc" id="L378">      ParametersChecker.checkSanityString(value);</span>
<span class="nc" id="L379">    } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L380">      SysErrLogger.FAKE_LOGGER.syserr(INVALID_PROPERTY + key, e);</span>
<span class="nc" id="L381">      return def;</span>
<span class="fc" id="L382">    }</span>

<span class="fc" id="L384">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the long integer system property '&quot; + key + &quot;':&quot; +
        value + &quot; - &quot; + USING_THE_DEFAULT_VALUE + def);

<span class="fc" id="L388">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the
   * specified default value if the property access fails.
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified
   *     property is not allowed.
   */
  public static boolean getBoolean(final String key, final boolean def) {
<span class="nc" id="L401">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>

<span class="nc" id="L403">    String value = PROPS.getProperty(key);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L405">      return def;</span>
    }

<span class="nc" id="L408">    value = value.trim().toLowerCase();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">    if (value.isEmpty()) {</span>
<span class="nc" id="L410">      return true;</span>
    }

<span class="nc bnc" id="L413" title="All 6 branches missed.">    if (&quot;true&quot;.equals(value) || &quot;yes&quot;.equals(value) || &quot;1&quot;.equals(value)) {</span>
<span class="nc" id="L414">      return true;</span>
    }

<span class="nc bnc" id="L417" title="All 6 branches missed.">    if (&quot;false&quot;.equals(value) || &quot;no&quot;.equals(value) || &quot;0&quot;.equals(value)) {</span>
<span class="nc" id="L418">      return false;</span>
    }

<span class="nc" id="L421">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the boolean system property '&quot; + key + &quot;':&quot; + value +
        &quot; - &quot; + USING_THE_DEFAULT_VALUE2 + def);

<span class="nc" id="L425">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the
   * specified default value if the property access fails.
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified
   *     property is not allowed.
   */
  public static int getInt(final String key, final int def) {
<span class="nc" id="L438">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>

<span class="nc" id="L440">    String value = PROPS.getProperty(key);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L442">      return def;</span>
    }

<span class="nc" id="L445">    value = value.trim().toLowerCase();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">    if (value.matches(FIND_0_9)) {</span>
      try {
<span class="nc" id="L448">        return Integer.parseInt(value);</span>
<span class="nc" id="L449">      } catch (final Exception e) {</span>
        // Ignore
      }
    }

<span class="nc" id="L454">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the integer system property '&quot; + key + &quot;':&quot; + value +
        &quot; - &quot; + USING_THE_DEFAULT_VALUE2 + def);

<span class="nc" id="L458">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the
   * specified default value if the property access fails.
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified
   *     property is not allowed.
   */
  public static long getLong(final String key, final long def) {
<span class="nc" id="L471">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>

<span class="nc" id="L473">    String value = PROPS.getProperty(key);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L475">      return def;</span>
    }

<span class="nc" id="L478">    value = value.trim().toLowerCase();</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">    if (value.matches(FIND_0_9)) {</span>
      try {
<span class="nc" id="L481">        return Long.parseLong(value);</span>
<span class="nc" id="L482">      } catch (final Exception e) {</span>
        // Ignore
      }
    }

<span class="nc" id="L487">    SysErrLogger.FAKE_LOGGER.syserr(</span>
        &quot;Unable to parse the long integer system property '&quot; + key + &quot;':&quot; +
        value + &quot; - &quot; + USING_THE_DEFAULT_VALUE2 + def);

<span class="nc" id="L491">    return def;</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key or def null
   */
  public static String getAndSet(final String key, final String def) {
<span class="fc" id="L509">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">    if (def == null) {</span>
<span class="nc" id="L511">      throw new IllegalArgumentException(&quot;Def cannot be null&quot;);</span>
    }
<span class="fc bfc" id="L513" title="All 2 branches covered.">    if (!PROPS.containsKey(key)) {</span>
<span class="fc" id="L514">      System.setProperty(key, def);</span>
<span class="fc" id="L515">      refresh();</span>
<span class="fc" id="L516">      return def;</span>
    }
<span class="fc" id="L518">    return PROPS.getProperty(key);</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static boolean getAndSet(final String key, final boolean def) {
<span class="fc" id="L536">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">    if (!PROPS.containsKey(key)) {</span>
<span class="fc" id="L538">      System.setProperty(key, Boolean.toString(def));</span>
<span class="fc" id="L539">      refresh();</span>
<span class="fc" id="L540">      return def;</span>
    }
<span class="fc" id="L542">    return get(key, def);</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static int getAndSet(final String key, final int def) {
<span class="fc" id="L560">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc bfc" id="L561" title="All 2 branches covered.">    if (!PROPS.containsKey(key)) {</span>
<span class="fc" id="L562">      System.setProperty(key, Integer.toString(def));</span>
<span class="fc" id="L563">      refresh();</span>
<span class="fc" id="L564">      return def;</span>
    }
<span class="fc" id="L566">    return get(key, def);</span>
  }

  /**
   * Returns the value of the Java system property with the specified {@code
   * key}, while falling back to the specified
   * default value if the property access fails.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the property value. {@code def} if there's no such property or if
   *     an access to the specified property is
   *     not allowed.
   *
   * @throws IllegalArgumentException key null
   */
  public static long getAndSet(final String key, final long def) {
<span class="fc" id="L584">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc bfc" id="L585" title="All 2 branches covered.">    if (!PROPS.containsKey(key)) {</span>
<span class="fc" id="L586">      System.setProperty(key, Long.toString(def));</span>
<span class="fc" id="L587">      refresh();</span>
<span class="fc" id="L588">      return def;</span>
    }
<span class="fc" id="L590">    return get(key, def);</span>
  }

  /**
   * Set the value of the Java system property with the specified {@code key}
   * to the specified default value.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the ancient value.
   *
   * @throws IllegalArgumentException key or def null
   */
  public static String set(final String key, final String def) {
<span class="fc" id="L605">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">    if (def == null) {</span>
<span class="nc" id="L607">      throw new IllegalArgumentException(&quot;Def cannot be null&quot;);</span>
    }
<span class="fc" id="L609">    String old = null;</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">    if (PROPS.containsKey(key)) {</span>
<span class="fc" id="L611">      old = PROPS.getProperty(key);</span>
    }
<span class="fc" id="L613">    System.setProperty(key, def);</span>
<span class="fc" id="L614">    refresh();</span>
<span class="fc" id="L615">    return old;</span>
  }

  /**
   * Set the value of the Java system property with the specified {@code key}
   * to the specified default value.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the ancient value.
   *
   * @throws IllegalArgumentException key null
   */
  public static boolean set(final String key, final boolean def) {
<span class="fc" id="L630">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L631">    boolean old = false;</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">    if (PROPS.containsKey(key)) {</span>
<span class="fc" id="L633">      old = get(key, def);</span>
    }
<span class="fc" id="L635">    System.setProperty(key, Boolean.toString(def));</span>
<span class="fc" id="L636">    refresh();</span>
<span class="fc" id="L637">    return old;</span>
  }

  /**
   * Set the value of the Java system property with the specified {@code key}
   * to the specified default value.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the ancient value.
   *
   * @throws IllegalArgumentException key null
   */
  public static int set(final String key, final int def) {
<span class="fc" id="L652">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L653">    int old = 0;</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">    if (PROPS.containsKey(key)) {</span>
<span class="fc" id="L655">      old = get(key, def);</span>
    }
<span class="fc" id="L657">    System.setProperty(key, Integer.toString(def));</span>
<span class="fc" id="L658">    refresh();</span>
<span class="fc" id="L659">    return old;</span>
  }

  /**
   * Set the value of the Java system property with the specified {@code key}
   * to the specified default value.
   *
   * @param key of system property
   * @param def the default value
   *
   * @return the ancient value.
   *
   * @throws IllegalArgumentException key null
   */
  public static long set(final String key, final long def) {
<span class="fc" id="L674">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L675">    long old = 0;</span>
<span class="fc bfc" id="L676" title="All 2 branches covered.">    if (PROPS.containsKey(key)) {</span>
<span class="fc" id="L677">      old = get(key, def);</span>
    }
<span class="fc" id="L679">    System.setProperty(key, Long.toString(def));</span>
<span class="fc" id="L680">    refresh();</span>
<span class="fc" id="L681">    return old;</span>
  }

  /**
   * Remove the key of the Java system property with the specified {@code
   * key}.
   *
   * @param key of system property
   *
   * @throws IllegalArgumentException key null
   */
  public static void clear(final String key) {
<span class="fc" id="L693">    ParametersChecker.checkParameter(&quot;Key&quot;, key);</span>
<span class="fc" id="L694">    PROPS.remove(key);</span>
<span class="fc" id="L695">    System.clearProperty(key);</span>
<span class="fc" id="L696">    refresh();</span>
<span class="fc" id="L697">  }</span>

  /**
   * Print to System.out the content of the properties
   *
   * @param out the output stream to be used
   *
   * @throws IllegalArgumentException out null
   */
  public static void debug(final PrintStream out) {
<span class="fc" id="L707">    ParametersChecker.checkParameter(&quot;Out&quot;, out);</span>
<span class="fc" id="L708">    PROPS.list(out);</span>
<span class="fc" id="L709">  }</span>

  /**
   * Inspired from http://commons.apache.org/lang/api-2.4/org/apache/commons/lang/
   * SystemUtils.html
   */
<span class="fc" id="L715">  public enum Platform {</span>
    /**
     * Windows
     */
<span class="fc" id="L719">    WINDOWS,</span>
    /**
     * Mac
     */
<span class="fc" id="L723">    MAC,</span>
    /**
     * Unix
     */
<span class="fc" id="L727">    UNIX,</span>
    /**
     * Solaris
     */
<span class="fc" id="L731">    SOLARIS,</span>
    /**
     * Unsupported
     */
<span class="fc" id="L735">    UNSUPPORTED</span>
  }

  /**
   * @return the Platform
   */
  public static Platform getOS() {
<span class="fc bfc" id="L742" title="All 2 branches covered.">    if (mOs == null) {</span>
<span class="fc" id="L743">      mOs = Platform.UNSUPPORTED;</span>
<span class="fc" id="L744">      String os = &quot;&quot;;</span>
      try {
<span class="fc" id="L746">        os = System.getProperty(&quot;os.name&quot;).toLowerCase();</span>
<span class="nc" id="L747">      } catch (final Exception ignored) {</span>
        // ignore
<span class="nc" id="L749">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="fc" id="L750">      }</span>
<span class="pc bpc" id="L751" title="1 of 2 branches missed.">      if (os.contains(&quot;win&quot;)) {</span>
<span class="nc" id="L752">        mOs = Platform.WINDOWS;</span>
        // Windows
      }
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">      if (os.contains(&quot;mac&quot;)) {</span>
<span class="nc" id="L756">        mOs = Platform.MAC;</span>
        // Mac
      }
<span class="pc bpc" id="L759" title="1 of 2 branches missed.">      if (os.contains(&quot;nux&quot;)) {</span>
<span class="fc" id="L760">        mOs = Platform.UNIX;</span>
        // Linux
      }
<span class="pc bpc" id="L763" title="1 of 2 branches missed.">      if (os.contains(&quot;nix&quot;)) {</span>
<span class="nc" id="L764">        mOs = Platform.UNIX;</span>
        // Unix
      }
<span class="pc bpc" id="L767" title="1 of 2 branches missed.">      if (os.contains(&quot;sunos&quot;)) {</span>
<span class="nc" id="L768">        mOs = Platform.SOLARIS;</span>
        // Solaris
      }
    }
<span class="fc" id="L772">    return mOs;</span>
  }

  /**
   * @return True if Windows
   */
  public static boolean isWindows() {
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">    return getOS() == Platform.WINDOWS;</span>
  }

  /**
   * @return True if Mac
   */
  public static boolean isMac() {
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">    return getOS() == Platform.MAC;</span>
  }

  /**
   * @return True if Unix
   */
  public static boolean isUnix() {
<span class="pc bpc" id="L793" title="1 of 2 branches missed.">    return getOS() == Platform.UNIX;</span>
  }

  /**
   * @return True if Solaris
   */
  public static boolean isSolaris() {
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">    return getOS() == Platform.SOLARIS;</span>
  }

  public static void debug() {
<span class="nc" id="L804">    PROPS.list(System.out);//NOSONAR</span>
<span class="nc" id="L805">  }</span>

  private SystemPropertyUtil() {
    // Unused
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>