<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WaarpFtpClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp Ftp R66 client</a> &gt; <a href="index.source.html" class="el_package">org.waarp.ftp.client</a> &gt; <span class="el_source">WaarpFtpClient.java</span></div><h1>WaarpFtpClient.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.ftp.client;

import org.apache.commons.net.PrintCommandListener;
import org.apache.commons.net.ftp.FTP;
import org.apache.commons.net.ftp.FTPClient;
import org.apache.commons.net.ftp.FTPFile;
import org.apache.commons.net.ftp.FTPReply;
import org.apache.commons.net.ftp.FTPSClient;
import org.apache.commons.net.util.TrustManagerUtils;
import org.waarp.common.file.FileUtils;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.SocketException;

/**
 * FTP Client using Apache Commons net FTP client (not working using FTPS or
 * FTPSE)
 */
public class WaarpFtpClient {
  private static final String LOGIN_IN_ERROR = &quot;Login in error&quot;;

  /**
   * Internal Logger
   */
<span class="fc" id="L51">  private static final WaarpLogger logger =</span>
<span class="fc" id="L52">      WaarpLoggerFactory.getLogger(WaarpFtpClient.class);</span>

  final String server;
<span class="fc" id="L55">  int port = 21;</span>
  final String user;
  final String pwd;
  final String acct;
  int timeout;
  boolean isPassive;
  final int ssl; // -1 native, 1 auth
  protected final FTPClient ftpClient;
  protected String result;

  /**
   * WARNING: SSL mode (FTPS and FTPSE) are not working due to a bug in Apache
   * Commons-Net
   *
   * @param server
   * @param port
   * @param user
   * @param pwd
   * @param acct
   * @param isPassive
   * @param ssl
   * @param timeout
   */
  public WaarpFtpClient(final String server, final int port, final String user,
                        final String pwd, final String acct,
                        final boolean isPassive, final int ssl,
<span class="fc" id="L81">                        final int controlTimeout, final int timeout) {</span>
<span class="fc" id="L82">    this.server = server;</span>
<span class="fc" id="L83">    this.port = port;</span>
<span class="fc" id="L84">    this.user = user;</span>
<span class="fc" id="L85">    this.pwd = pwd;</span>
<span class="fc" id="L86">    this.acct = acct;</span>
<span class="fc" id="L87">    this.isPassive = isPassive;</span>
<span class="fc" id="L88">    this.ssl = ssl;</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">    if (this.ssl != 0) {</span>
      // implicit or explicit
<span class="nc bnc" id="L91" title="All 2 branches missed.">      ftpClient = new FTPSClient(this.ssl == -1);</span>
<span class="nc" id="L92">      ((FTPSClient) ftpClient)</span>
<span class="nc" id="L93">          .setTrustManager(TrustManagerUtils.getAcceptAllTrustManager());</span>
    } else {
<span class="fc" id="L95">      ftpClient = new FTPClient();</span>
    }
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">    if (controlTimeout &gt; 0) {</span>
<span class="nc" id="L98">      ftpClient.setControlKeepAliveTimeout(controlTimeout / 1000);</span>
<span class="nc" id="L99">      ftpClient.setControlKeepAliveReplyTimeout(controlTimeout);</span>
    }
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (timeout &gt; 0) {</span>
<span class="fc" id="L102">      ftpClient.setDataTimeout(timeout);</span>
    }
<span class="fc" id="L104">    ftpClient.addProtocolCommandListener(</span>
        new PrintCommandListener(new PrintWriter(System.out), true));
<span class="fc" id="L106">  }</span>

  /**
   * Try to connect to the server and goes with the authentication
   *
   * @return True if connected and authenticated, else False
   */
  public boolean connect() {
<span class="fc" id="L114">    result = null;</span>
<span class="fc" id="L115">    boolean isActive = false;</span>
    try {
      try {
<span class="fc" id="L118">        ftpClient.connect(server, port);</span>
<span class="nc" id="L119">      } catch (final SocketException e) {</span>
<span class="nc" id="L120">        result = &quot;Connection in error&quot;;</span>
<span class="nc" id="L121">        logger.error(result, e);</span>
<span class="nc" id="L122">        return false;</span>
<span class="nc" id="L123">      } catch (final IOException e) {</span>
<span class="nc" id="L124">        result = &quot;Connection in error&quot;;</span>
<span class="nc" id="L125">        logger.error(result, e);</span>
<span class="nc" id="L126">        return false;</span>
<span class="fc" id="L127">      }</span>
<span class="fc" id="L128">      final int reply = ftpClient.getReplyCode();</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">      if (!FTPReply.isPositiveCompletion(reply)) {</span>
<span class="nc" id="L130">        disconnect();</span>
<span class="nc" id="L131">        result = &quot;Connection in error: &quot; + reply;</span>
<span class="nc" id="L132">        logger.error(result);</span>
<span class="nc" id="L133">        return false;</span>
      }
      try {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (acct == null) {</span>
          // no account
<span class="nc bnc" id="L138" title="All 2 branches missed.">          if (!ftpClient.login(user, pwd)) {</span>
<span class="nc" id="L139">            logout();</span>
<span class="nc" id="L140">            result = LOGIN_IN_ERROR;</span>
<span class="nc" id="L141">            logger.error(result);</span>
<span class="nc" id="L142">            return false;</span>
          }
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        } else if (!ftpClient.login(user, pwd, acct)) {</span>
<span class="nc" id="L145">          logout();</span>
<span class="nc" id="L146">          result = LOGIN_IN_ERROR;</span>
<span class="nc" id="L147">          logger.error(result);</span>
<span class="nc" id="L148">          return false;</span>
        }
<span class="nc" id="L150">      } catch (final IOException e) {</span>
<span class="nc" id="L151">        result = LOGIN_IN_ERROR;</span>
<span class="nc" id="L152">        logger.error(result, e);</span>
<span class="nc" id="L153">        return false;</span>
<span class="fc" id="L154">      }</span>
      try {
<span class="fc" id="L156">        ftpClient.setFileType(FTP.BINARY_FILE_TYPE);</span>
<span class="nc" id="L157">      } catch (final IOException e1) {</span>
<span class="nc" id="L158">        result = &quot;Set BINARY in error&quot;;</span>
<span class="nc" id="L159">        logger.error(result, e1);</span>
<span class="nc" id="L160">        return false;</span>
<span class="fc" id="L161">      }</span>
<span class="fc" id="L162">      changeMode(isPassive);</span>
<span class="fc" id="L163">      ftpClient.setUseEPSVwithIPv4(false);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">      if (ssl == 1) {</span>
        // now send request for PROT (AUTH already sent)
        try {
<span class="nc" id="L167">          ((FTPSClient) ftpClient).execPBSZ(0);</span>
<span class="nc" id="L168">          logger.debug(&quot;PBSZ 0&quot;);</span>
<span class="nc" id="L169">          ((FTPSClient) ftpClient).execPROT(&quot;P&quot;);</span>
<span class="nc" id="L170">          logger.debug(</span>
<span class="nc" id="L171">              &quot;Info: &quot; + ((FTPSClient) ftpClient).getEnableSessionCreation());</span>
<span class="nc" id="L172">        } catch (final IOException e) {</span>
<span class="nc" id="L173">          logout();</span>
<span class="nc" id="L174">          result = &quot;Explicit SSL in error&quot;;</span>
<span class="nc" id="L175">          logger.error(result, e);</span>
<span class="nc" id="L176">          return false;</span>
<span class="nc" id="L177">        }</span>
      }
<span class="fc" id="L179">      isActive = true;</span>
<span class="fc" id="L180">      return true;</span>
    } finally {
<span class="pc bpc" id="L182" title="3 of 4 branches missed.">      if (!isActive &amp;&amp; ftpClient.getDataConnectionMode() ==</span>
                       FTPClient.ACTIVE_LOCAL_DATA_CONNECTION_MODE) {
<span class="nc" id="L184">        disconnect();</span>
      }
    }
  }

  /**
   * Logout from the Control connection
   */
  public void logout() {
    try {
<span class="fc" id="L194">      ftpClient.logout();</span>
<span class="nc" id="L195">    } catch (final IOException e) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">      if (ftpClient.getDataConnectionMode() ==</span>
          FTPClient.ACTIVE_LOCAL_DATA_CONNECTION_MODE) {
        try {
<span class="nc" id="L199">          ftpClient.disconnect();</span>
<span class="nc" id="L200">        } catch (final IOException f) {</span>
          // do nothing
<span class="nc" id="L202">        }</span>
      }
<span class="fc" id="L204">    }</span>
<span class="fc" id="L205">  }</span>

  /**
   * Disconnect the Ftp Client
   */
  public void disconnect() {
    try {
<span class="fc" id="L212">      ftpClient.disconnect();</span>
<span class="nc" id="L213">    } catch (final IOException e) {</span>
<span class="nc" id="L214">      logger.debug(&quot;Disconnection in error&quot;, e);</span>
<span class="fc" id="L215">    }</span>
<span class="fc" id="L216">  }</span>

  /**
   * Create a new directory
   *
   * @param newDir
   *
   * @return True if created
   */
  public boolean makeDir(final String newDir) {
<span class="fc" id="L226">    result = null;</span>
    try {
<span class="fc" id="L228">      return ftpClient.makeDirectory(newDir);</span>
<span class="nc" id="L229">    } catch (final IOException e) {</span>
<span class="nc" id="L230">      result = &quot;MKDIR in error&quot;;</span>
<span class="nc" id="L231">      logger.info(result, e);</span>
<span class="nc" id="L232">      return false;</span>
    }
  }

  /**
   * Change remote directory
   *
   * @param newDir
   *
   * @return True if the change is OK
   */
  public boolean changeDir(final String newDir) {
<span class="fc" id="L244">    result = null;</span>
    try {
<span class="fc" id="L246">      return ftpClient.changeWorkingDirectory(newDir);</span>
<span class="nc" id="L247">    } catch (final IOException e) {</span>
<span class="nc" id="L248">      result = &quot;CHDIR in error&quot;;</span>
<span class="nc" id="L249">      logger.info(result, e);</span>
<span class="nc" id="L250">      return false;</span>
    }
  }

  /**
   * Change the FileType of Transfer (Binary true, ASCII false)
   *
   * @param binaryTransfer
   *
   * @return True if the change is OK
   */
  public boolean changeFileType(final boolean binaryTransfer) {
<span class="fc" id="L262">    result = null;</span>
    try {
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">      if (binaryTransfer) {</span>
<span class="fc" id="L265">        return ftpClient.setFileType(FTP.BINARY_FILE_TYPE);</span>
      } else {
<span class="nc" id="L267">        return ftpClient.setFileType(FTP.ASCII_FILE_TYPE);</span>
      }
<span class="nc" id="L269">    } catch (final IOException e) {</span>
<span class="nc" id="L270">      result = &quot;FileType in error&quot;;</span>
<span class="nc" id="L271">      logger.warn(result, e);</span>
<span class="nc" id="L272">      return false;</span>
    }
  }

  /**
   * Change to passive (true) or active (false) mode
   *
   * @param passive
   */
  public void changeMode(final boolean passive) {
<span class="fc" id="L282">    isPassive = passive;</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">    if (isPassive) {</span>
<span class="fc" id="L284">      ftpClient.enterLocalPassiveMode();</span>
    } else {
<span class="fc" id="L286">      ftpClient.enterLocalActiveMode();</span>
    }
<span class="fc" id="L288">  }</span>

  /**
   * Ask to transfer a file
   *
   * @param local local filepath (limited to path if get, else full
   *     path)
   * @param remote filename
   * @param getStoreOrAppend -1 = get, 1 = store, 2 = append
   *
   * @return True if the file is correctly transfered
   */
  public boolean transferFile(final String local, final String remote,
                              final int getStoreOrAppend) {
<span class="fc" id="L302">    result = null;</span>
    final boolean status;
<span class="fc" id="L304">    FileOutputStream output = null;</span>
<span class="fc" id="L305">    FileInputStream fileInputStream = null;</span>
    try {
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">      if (getStoreOrAppend &gt; 0) {</span>
<span class="fc" id="L308">        fileInputStream = new FileInputStream(local);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        if (getStoreOrAppend == 1) {</span>
<span class="fc" id="L310">          status = ftpClient.storeFile(remote, fileInputStream);</span>
        } else {
          // append
<span class="nc" id="L313">          status = ftpClient.appendFile(remote, fileInputStream);</span>
        }
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        if (!status) {</span>
<span class="nc" id="L316">          result = &quot;Cannot finalize store like operation&quot;;</span>
<span class="nc" id="L317">          logger.error(result);</span>
<span class="nc" id="L318">          return false;</span>
        }
      } else {
<span class="nc" id="L321">        output = new FileOutputStream(new File(local, remote));</span>
<span class="nc" id="L322">        status = ftpClient.retrieveFile(remote, output);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (!status) {</span>
<span class="nc" id="L324">          result = &quot;Cannot finalize retrieve like operation&quot;;</span>
<span class="nc" id="L325">          logger.error(result);</span>
<span class="nc" id="L326">          return false;</span>
        }
      }
<span class="fc" id="L329">      return true;</span>
<span class="nc" id="L330">    } catch (final IOException e) {</span>
<span class="nc" id="L331">      result = &quot;Cannot finalize operation&quot;;</span>
<span class="nc" id="L332">      logger.error(result, e);</span>
<span class="nc" id="L333">      return false;</span>
    } finally {
<span class="fc" id="L335">      FileUtils.close(output);</span>
<span class="fc" id="L336">      FileUtils.close(fileInputStream);</span>
    }
  }

  /**
   * @return the list of files as returned by the FTP command
   */
  public String[] listFiles() {
    try {
<span class="fc" id="L345">      final FTPFile[] list = ftpClient.listFiles();</span>
<span class="fc" id="L346">      final String[] results = new String[list.length];</span>
<span class="fc" id="L347">      int i = 0;</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">      for (final FTPFile file : list) {</span>
<span class="fc" id="L349">        results[i] = file.toFormattedString();</span>
<span class="fc" id="L350">        i++;</span>
      }
<span class="fc" id="L352">      return results;</span>
<span class="nc" id="L353">    } catch (final IOException e) {</span>
<span class="nc" id="L354">      result = &quot;Cannot finalize transfer operation&quot;;</span>
<span class="nc" id="L355">      logger.error(result, e);</span>
<span class="nc" id="L356">      return null;</span>
    }
  }

  /**
   * @param feature
   *
   * @return True if the feature is listed
   */
  public boolean featureEnabled(final String feature) {
    try {
<span class="fc" id="L367">      SysErrLogger.FAKE_LOGGER.sysout(ftpClient.features());</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">      if (ftpClient.featureValue(feature) == null) {</span>
<span class="fc" id="L369">        final String resultNew = ftpClient.getReplyString();</span>
<span class="fc" id="L370">        return resultNew.contains(feature.toUpperCase());</span>
      }
<span class="nc" id="L372">      return true;</span>
<span class="nc" id="L373">    } catch (final IOException e) {</span>
<span class="nc" id="L374">      result = &quot;Cannot execute operation Feature&quot;;</span>
<span class="nc" id="L375">      logger.error(result, e);</span>
<span class="nc" id="L376">      return false;</span>
    }
  }

  /**
   * @param params
   *
   * @return the string lines returned by the command params
   */
  public String[] executeCommand(final String params) {
<span class="nc" id="L386">    result = null;</span>
    try {
<span class="nc" id="L388">      SysErrLogger.FAKE_LOGGER.sysout(params);</span>
<span class="nc" id="L389">      final int pos = params.indexOf(' ');</span>
<span class="nc" id="L390">      String command = params;</span>
<span class="nc" id="L391">      String args = null;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">      if (pos &gt; 0) {</span>
<span class="nc" id="L393">        command = params.substring(0, pos);</span>
<span class="nc" id="L394">        args = params.substring(pos + 1);</span>
      }
<span class="nc" id="L396">      String[] results = ftpClient.doCommandAsStrings(command, args);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">      if (results == null) {</span>
<span class="nc" id="L398">        results = new String[1];</span>
<span class="nc" id="L399">        results[0] = ftpClient.getReplyString();</span>
      }
<span class="nc" id="L401">      return results;</span>
<span class="nc" id="L402">    } catch (final IOException e) {</span>
<span class="nc" id="L403">      result = &quot;Cannot execute operation Site&quot;;</span>
<span class="nc" id="L404">      logger.error(result, e);</span>
<span class="nc" id="L405">      return null;</span>
    }
  }

  /**
   * @param params
   *
   * @return the string lines returned by the SITE command params
   */
  public String[] executeSiteCommand(final String params) {
<span class="fc" id="L415">    result = null;</span>
    try {
<span class="fc" id="L417">      SysErrLogger.FAKE_LOGGER.sysout(&quot;SITE &quot; + params);</span>
<span class="fc" id="L418">      String[] results = ftpClient.doCommandAsStrings(&quot;SITE&quot;, params);</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">      if (results == null) {</span>
<span class="nc" id="L420">        results = new String[1];</span>
<span class="nc" id="L421">        results[0] = ftpClient.getReplyString();</span>
      }
<span class="fc" id="L423">      return results;</span>
<span class="nc" id="L424">    } catch (final IOException e) {</span>
<span class="nc" id="L425">      result = &quot;Cannot execute operation Site&quot;;</span>
<span class="nc" id="L426">      logger.error(result, e);</span>
<span class="nc" id="L427">      return null;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>