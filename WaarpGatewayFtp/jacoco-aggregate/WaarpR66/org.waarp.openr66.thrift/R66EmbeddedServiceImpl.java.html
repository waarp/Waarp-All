<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>R66EmbeddedServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Gateway Ftp</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.thrift</a> &gt; <span class="el_source">R66EmbeddedServiceImpl.java</span></div><h1>R66EmbeddedServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.thrift;

import org.apache.thrift.TException;
import org.waarp.common.command.exception.CommandAbstractException;
import org.waarp.common.database.data.AbstractDbData;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.openr66.client.AbstractTransfer;
import org.waarp.openr66.commander.ClientRunner;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.context.filesystem.R66File;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.PartnerConfiguration;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.LocalServerHandler;
import org.waarp.openr66.protocol.localhandler.packet.ErrorPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;
import org.waarp.openr66.protocol.utils.TransferUtils;
import org.waarp.thrift.r66.Action;
import org.waarp.thrift.r66.ErrorCode;
import org.waarp.thrift.r66.R66Request;
import org.waarp.thrift.r66.R66Result;
import org.waarp.thrift.r66.R66Service;
import org.waarp.thrift.r66.RequestMode;

import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import static org.waarp.common.database.DbConstant.*;

/**
 * Embedded service attached with the Thrift service
 */
<span class="fc" id="L61">public class R66EmbeddedServiceImpl implements R66Service.Iface {</span>
  /**
   * Internal Logger
   */
<span class="fc" id="L65">  private static final WaarpLogger logger =</span>
<span class="fc" id="L66">      WaarpLoggerFactory.getLogger(R66EmbeddedServiceImpl.class);</span>

  private DbTaskRunner initRequest(final R66Request request) {
<span class="fc" id="L69">    Timestamp ttimestart = null;</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">    if (request.isSetStart()) {</span>
      final Date date;
      try {
<span class="nc" id="L73">        final SimpleDateFormat dateFormat =</span>
            new SimpleDateFormat(AbstractTransfer.TIMESTAMP_FORMAT);
<span class="nc" id="L75">        date = dateFormat.parse(request.getStart());</span>
<span class="nc" id="L76">        ttimestart = new Timestamp(date.getTime());</span>
<span class="nc" id="L77">      } catch (final ParseException ignored) {</span>
        // nothing
<span class="nc" id="L79">      }</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">    } else if (request.isSetDelay()) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">      if (request.getDelay().charAt(0) == '+') {</span>
<span class="nc" id="L82">        ttimestart = new Timestamp(System.currentTimeMillis() + Long.parseLong(</span>
<span class="nc" id="L83">            request.getDelay().substring(1)));</span>
      } else {
<span class="nc" id="L85">        ttimestart = new Timestamp(Long.parseLong(request.getDelay()));</span>
      }
    }
    final DbRule rule;
    try {
<span class="fc" id="L90">      rule = new DbRule(request.getRule());</span>
<span class="nc" id="L91">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L92">      logger.warn(&quot;Cannot get Rule: &quot; + request.getRule(), e);</span>
<span class="nc" id="L93">      return null;</span>
<span class="fc" id="L94">    }</span>
<span class="fc" id="L95">    int mode = rule.getMode();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">    if (request.isMd5()) {</span>
<span class="nc" id="L97">      mode = RequestPacket.getModeMD5(mode);</span>
    }
    final DbTaskRunner taskRunner;
<span class="fc" id="L100">    long tid = ILLEGALVALUE;</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (request.isSetTid()) {</span>
<span class="nc" id="L102">      tid = request.getTid();</span>
    }
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">    if (tid != ILLEGALVALUE) {</span>
      try {
<span class="nc" id="L106">        taskRunner = new DbTaskRunner(tid, request.getDestuid());</span>
        // requested
<span class="nc" id="L108">        taskRunner.setSenderByRequestToValidate(true);</span>
<span class="nc" id="L109">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L110">        logger.warn(&quot;Cannot get task&quot;, e);</span>
<span class="nc" id="L111">        return null;</span>
<span class="nc" id="L112">      }</span>
    } else {
<span class="fc" id="L114">      final String sep =</span>
<span class="fc" id="L115">          PartnerConfiguration.getSeparator(request.getDestuid());</span>
<span class="fc" id="L116">      final RequestPacket requestPacket =</span>
<span class="fc" id="L117">          new RequestPacket(request.getRule(), mode, request.getFile(),</span>
<span class="fc" id="L118">                            request.getBlocksize(), 0, tid, request.getInfo(),</span>
                            -1, sep);
      // Not isRecv since it is the requester, so send =&gt; isRetrieve is true
<span class="fc" id="L121">      final boolean isRetrieve =</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">          !RequestPacket.isRecvMode(requestPacket.getMode());</span>
      try {
<span class="fc" id="L124">        taskRunner = new DbTaskRunner(rule, isRetrieve, requestPacket,</span>
<span class="fc" id="L125">                                      request.getDestuid(), ttimestart);</span>
<span class="nc" id="L126">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L127">        logger.warn(&quot;Cannot get task&quot;, e);</span>
<span class="nc" id="L128">        return null;</span>
<span class="fc" id="L129">      }</span>
    }
<span class="fc" id="L131">    return taskRunner;</span>
  }

  @Override
  public R66Result transferRequestQuery(final R66Request request)
      throws TException {
<span class="fc" id="L137">    final DbTaskRunner runner = initRequest(request);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">    if (runner != null) {</span>
<span class="fc" id="L139">      runner.changeUpdatedInfo(AbstractDbData.UpdatedInfo.TOSUBMIT);</span>
<span class="fc" id="L140">      final boolean isSender = runner.isSender();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">      if (!runner.forceSaveStatus()) {</span>
<span class="nc" id="L142">        logger.warn(&quot;Cannot prepare task&quot;);</span>
<span class="nc" id="L143">        return new R66Result(request.getMode(), ErrorCode.CommandNotFound,</span>
                             &quot;ERROR: Cannot prepare transfer&quot;);
      }
<span class="fc" id="L146">      final R66Result result =</span>
<span class="fc" id="L147">          new R66Result(request.getMode(), ErrorCode.InitOk,</span>
                        &quot;Transfer Scheduled&quot;);
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">      if (request.getMode() == RequestMode.SYNCTRANSFER) {</span>
        // now need to wait but first, reload the runner
        try {
<span class="nc" id="L152">          runner.select();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">          while (!runner.isFinished()) {</span>
            try {
<span class="nc" id="L155">              Thread.sleep(1000);</span>
<span class="nc" id="L156">              runner.select();</span>
<span class="nc" id="L157">            } catch (final InterruptedException e) {//NOSONAR</span>
<span class="nc" id="L158">              SysErrLogger.FAKE_LOGGER.ignoreLog(e);</span>
<span class="nc" id="L159">              break;</span>
<span class="nc" id="L160">            }</span>
          }
<span class="nc" id="L162">          runner.setSender(isSender);</span>
<span class="nc" id="L163">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L165">        }</span>
<span class="nc" id="L166">        setResultFromRunner(runner, result);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (runner.isAllDone()) {</span>
<span class="nc" id="L168">          result.setCode(ErrorCode.CompleteOk);</span>
<span class="nc" id="L169">          result.setResultinfo(&quot;Transfer Done&quot;);</span>
        } else {
<span class="nc" id="L171">          result.setCode(ErrorCode.valueOf(runner.getErrorInfo().name()));</span>
<span class="nc" id="L172">          result.setResultinfo(runner.getErrorInfo().getMesg());</span>
        }
      } else {
        try {
<span class="fc" id="L176">          runner.select();</span>
<span class="nc" id="L177">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="fc" id="L179">        }</span>
<span class="fc" id="L180">        runner.setSender(isSender);</span>
<span class="fc" id="L181">        setResultFromRunner(runner, result);</span>
      }
<span class="fc" id="L183">      return result;</span>
    } else {
<span class="nc" id="L185">      logger.warn(&quot;ERROR: Transfer NOT scheduled&quot;);</span>
<span class="nc" id="L186">      return new R66Result(request.getMode(), ErrorCode.Internal,</span>
                           &quot;ERROR: Transfer NOT scheduled&quot;);
    }
  }

  private void setResultFromRunner(final DbTaskRunner runner,
                                   final R66Result result) {
<span class="fc" id="L193">    result.setDestuid(runner.getRequested());</span>
<span class="fc" id="L194">    result.setFromuid(runner.getRequester());</span>
<span class="fc" id="L195">    result.setTid(runner.getSpecialId());</span>
<span class="fc" id="L196">    result.setRule(runner.getRuleId());</span>
<span class="fc" id="L197">    result.setBlocksize(runner.getBlocksize());</span>
<span class="fc" id="L198">    result.setFile(runner.getFilename());</span>
<span class="fc" id="L199">    result.setOriginalfilename(runner.getOriginalFilename());</span>
<span class="fc" id="L200">    result.setIsmoved(runner.isFileMoved());</span>
<span class="fc" id="L201">    result.setModetransfer(runner.getMode());</span>
<span class="fc" id="L202">    result.setRetrievemode(runner.isSender());</span>
<span class="fc" id="L203">    result.setStep(runner.getStep());</span>
<span class="fc" id="L204">    result.setGloballaststep(runner.getGloballaststep());</span>
<span class="fc" id="L205">    result.setRank(runner.getRank());</span>
<span class="fc" id="L206">    result.setStart(runner.getStart().toString());</span>
<span class="fc" id="L207">    result.setStop(runner.getStop().toString());</span>
<span class="fc" id="L208">    result.setResultinfo(runner.getFileInformation());</span>
<span class="fc" id="L209">  }</span>

  private void setResultFromLCR(final LocalChannelReference lcr,
                                final R66Result result) {
<span class="nc" id="L213">    final R66Session session = lcr.getSession();</span>
<span class="nc" id="L214">    DbTaskRunner runner = null;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    if (session != null) {</span>
<span class="nc" id="L216">      runner = session.getRunner();</span>
    } else {
<span class="nc" id="L218">      final ClientRunner run = lcr.getClientRunner();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (run != null) {</span>
<span class="nc" id="L220">        runner = run.getTaskRunner();</span>
      }
    }
<span class="nc bnc" id="L223" title="All 2 branches missed.">    if (runner != null) {</span>
<span class="nc" id="L224">      setResultFromRunner(runner, result);</span>
    }
<span class="nc" id="L226">  }</span>

  private int stopOrCancelRunner(final long id, final String reqd,
                                 final String reqr,
                                 final org.waarp.openr66.context.ErrorCode code) {
    try {
<span class="nc" id="L232">      final DbTaskRunner taskRunner =</span>
          new DbTaskRunner(null, null, id, reqr, reqd);
<span class="nc bnc" id="L234" title="All 2 branches missed.">      return taskRunner.stopOrCancelRunner(code)? 1 : 0;</span>
<span class="nc" id="L235">    } catch (final WaarpDatabaseException ignored) {</span>
      // nothing
    }
<span class="nc" id="L238">    logger</span>
<span class="nc" id="L239">        .warn(&quot;Cannot accomplished action on task: &quot; + id + ' ' + code.name());</span>
<span class="nc" id="L240">    return -1;</span>
  }

  private R66Result stopOrCancel(final R66Request request,
                                 final LocalChannelReference lcr,
                                 final org.waarp.openr66.context.ErrorCode r66code) {
    // stop the current transfer
    final R66Result resulttest;
<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (lcr != null) {</span>
<span class="nc" id="L249">      int rank = 0;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">      if (r66code == org.waarp.openr66.context.ErrorCode.StoppedTransfer &amp;&amp;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">          lcr.getSession() != null) {</span>
<span class="nc" id="L252">        final DbTaskRunner taskRunner = lcr.getSession().getRunner();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (taskRunner != null) {</span>
<span class="nc" id="L254">          rank = taskRunner.getRank();</span>
        }
      }
<span class="nc" id="L257">      final ErrorPacket error =</span>
<span class="nc" id="L258">          new ErrorPacket(r66code.name() + ' ' + rank, r66code.getCode(),</span>
                          ErrorPacket.FORWARDCLOSECODE);
      try {
        // inform local instead of remote
<span class="nc" id="L262">        LocalServerHandler.channelRead0(lcr, error);</span>
<span class="nc" id="L263">      } catch (final Exception ignored) {</span>
        // nothing
<span class="nc" id="L265">      }</span>
<span class="nc" id="L266">      resulttest = new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
<span class="nc" id="L267">                                 r66code.name());</span>
<span class="nc" id="L268">      setResultFromLCR(lcr, resulttest);</span>
<span class="nc" id="L269">    } else {</span>
      // Transfer is not running
      // but maybe need action on database
<span class="nc" id="L272">      final int test =</span>
<span class="nc" id="L273">          stopOrCancelRunner(request.getTid(), request.getDestuid(),</span>
<span class="nc" id="L274">                             request.getFromuid(), r66code);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">      if (test &gt; 0) {</span>
<span class="nc" id="L276">        resulttest = new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
<span class="nc" id="L277">                                   r66code.name());</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">      } else if (test == 0) {</span>
<span class="nc" id="L279">        resulttest = new R66Result(request.getMode(), ErrorCode.TransferOk,</span>
<span class="nc" id="L280">                                   r66code.name());</span>
      } else {
<span class="nc" id="L282">        resulttest = new R66Result(request.getMode(), ErrorCode.CommandNotFound,</span>
                                   &quot;Error: cannot accomplished task on transfer&quot;);
      }
    }
<span class="nc" id="L286">    return resulttest;</span>
  }

  private R66Result restart(final R66Request request,
                            final LocalChannelReference lcr) {
    // Try to validate a restarting transfer
    // validLimit on requested side
<span class="nc" id="L293">    if (Configuration.configuration.getConstraintLimitHandler()</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                                   .checkConstraints()) {</span>
<span class="nc" id="L295">      logger</span>
<span class="nc" id="L296">          .warn(&quot;Limit exceeded {} while asking to relaunch a task &quot; + request,</span>
                Configuration.configuration
<span class="nc" id="L298">                    .getConstraintLimitHandler().lastAlert);</span>
<span class="nc" id="L299">      return new R66Result(request.getMode(), ErrorCode.ServerOverloaded,</span>
                           &quot;Limit exceeded while asking to relaunch a task&quot;);
    }
    // Try to validate a restarting transfer
    // header = ?; middle = requested+blank+requester+blank+specialId
    final DbTaskRunner taskRunner;
    try {
<span class="nc" id="L306">      taskRunner =</span>
<span class="nc" id="L307">          new DbTaskRunner(null, null, request.getTid(), request.getFromuid(),</span>
<span class="nc" id="L308">                           request.getDestuid());</span>
<span class="nc" id="L309">      final org.waarp.openr66.context.R66Result resulttest =</span>
<span class="nc" id="L310">          TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L311">      return new R66Result(request.getMode(),</span>
<span class="nc" id="L312">                           ErrorCode.valueOf(resulttest.getCode().name()),</span>
<span class="nc" id="L313">                           resulttest.getMessage());</span>
<span class="nc" id="L314">    } catch (final WaarpDatabaseException e1) {</span>
<span class="nc" id="L315">      logger.warn(&quot;Exception while trying to restart transfer&quot;, e1);</span>
<span class="nc" id="L316">      return new R66Result(request.getMode(), ErrorCode.Internal,</span>
                           &quot;Exception while trying to restart transfer&quot;);
    }
  }

  @Override
  public R66Result infoTransferQuery(final R66Request request)
      throws TException {
<span class="fc" id="L324">    final RequestMode mode = request.getMode();</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">    if (mode != RequestMode.INFOREQUEST) {</span>
      // error
<span class="nc" id="L327">      logger.warn(&quot;Mode is uncompatible with infoTransferQuery&quot;);</span>
<span class="nc" id="L328">      return new R66Result(request.getMode(), ErrorCode.Unimplemented,</span>
                           &quot;Mode is uncompatible with infoTransferQuery&quot;);
    }
    // now check if enough arguments are provided
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">    if (!request.isSetTid() ||</span>
<span class="pc bpc" id="L333" title="3 of 4 branches missed.">        !request.isSetDestuid() &amp;&amp; !request.isSetFromuid() ||</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">        !request.isSetAction()) {</span>
      // error
<span class="nc" id="L336">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L337">      return new R66Result(request.getMode(), ErrorCode.RemoteError,</span>
                           &quot;Not enough arguments&quot;);
    }
    // requested+blank+requester+blank+specialId
<span class="fc" id="L341">    final LocalChannelReference lcr =</span>
<span class="fc" id="L342">        Configuration.configuration.getLocalTransaction().getFromRequest(</span>
<span class="fc" id="L343">            request.getDestuid() + ' ' + request.getFromuid() + ' ' +</span>
<span class="fc" id="L344">            request.getTid());</span>
    final org.waarp.openr66.context.ErrorCode r66code;
<span class="pc bpc" id="L346" title="4 of 5 branches missed.">    switch (request.getAction()) {</span>
      case Detail: {
<span class="fc" id="L348">        final R66Result result =</span>
<span class="fc" id="L349">            new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
                          &quot;Existence test OK&quot;);
<span class="fc" id="L351">        result.setAction(Action.Exist);</span>
<span class="fc" id="L352">        result.setDestuid(request.getDestuid());</span>
<span class="fc" id="L353">        result.setFromuid(request.getFromuid());</span>
<span class="fc" id="L354">        result.setTid(request.getTid());</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">        if (lcr != null) {</span>
<span class="nc" id="L356">          setResultFromLCR(lcr, result);</span>
        } else {
          try {
<span class="fc" id="L359">            final DbTaskRunner runner =</span>
<span class="fc" id="L360">                new DbTaskRunner(null, null, request.getTid(),</span>
<span class="fc" id="L361">                                 request.getFromuid(), request.getDestuid());</span>
<span class="fc" id="L362">            setResultFromRunner(runner, result);</span>
<span class="nc" id="L363">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L364">            result.setCode(ErrorCode.FileNotFound);</span>
<span class="fc" id="L365">          }</span>
        }
<span class="fc" id="L367">        return result;</span>
      }
      case Restart:
<span class="nc" id="L370">        return restart(request, lcr);</span>
      case Cancel:
<span class="nc" id="L372">        r66code = org.waarp.openr66.context.ErrorCode.CanceledTransfer;</span>
<span class="nc" id="L373">        return stopOrCancel(request, lcr, r66code);</span>
      case Stop:
<span class="nc" id="L375">        r66code = org.waarp.openr66.context.ErrorCode.StoppedTransfer;</span>
<span class="nc" id="L376">        return stopOrCancel(request, lcr, r66code);</span>
      default:
<span class="nc" id="L378">        logger.warn(&quot;Uncompatible with &quot; + request.getAction().name());</span>
<span class="nc" id="L379">        return new R66Result(request.getMode(), ErrorCode.Unimplemented,</span>
<span class="nc" id="L380">                             &quot;Uncompatible with &quot; + request.getAction().name());</span>
    }
  }

  @Override
  public boolean isStillRunning(final String fromuid, final String touid,
                                final long tid) throws TException {
    // now check if enough arguments are provided
<span class="pc bpc" id="L388" title="3 of 6 branches missed.">    if (fromuid == null || touid == null || tid == ILLEGALVALUE) {</span>
      // error
<span class="nc" id="L390">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L391">      return false;</span>
    }
    // header = ?; middle = requested+blank+requester+blank+specialId
<span class="fc" id="L394">    final LocalChannelReference lcr =</span>
<span class="fc" id="L395">        Configuration.configuration.getLocalTransaction().getFromRequest(</span>
            touid + ' ' + fromuid + ' ' + tid);
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">    return lcr != null;</span>
  }

  @Override
  public List&lt;String&gt; infoListQuery(final R66Request request)
      throws TException {
<span class="fc" id="L403">    List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L404">    final RequestMode mode = request.getMode();</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">    if (mode != RequestMode.INFOFILE) {</span>
      // error
<span class="nc" id="L407">      logger.warn(&quot;Not correct mode for infoListQuery&quot;);</span>
<span class="nc" id="L408">      list.add(&quot;Not correct mode for infoListQuery&quot;);</span>
<span class="nc" id="L409">      return list;</span>
    }
    // now check if enough arguments are provided
<span class="pc bpc" id="L412" title="1 of 4 branches missed.">    if (!request.isSetRule() || !request.isSetAction()) {</span>
      // error
<span class="fc" id="L414">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="fc" id="L415">      list.add(&quot;Not enough arguments&quot;);</span>
<span class="fc" id="L416">      return list;</span>
    }
<span class="fc" id="L418">    final R66Session session = new R66Session();</span>
<span class="fc" id="L419">    session.getAuth().specialNoSessionAuth(false, Configuration.configuration</span>
<span class="fc" id="L420">        .getHostId());</span>
    final DbRule rule;
    try {
<span class="fc" id="L423">      rule = new DbRule(request.getRule());</span>
<span class="nc" id="L424">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L425">      logger.warn(&quot;Rule is unknown: &quot; + request.getRule());</span>
<span class="nc" id="L426">      list.add(&quot;Rule is unknown: &quot; + request.getRule());</span>
<span class="nc" id="L427">      return list;</span>
<span class="fc" id="L428">    }</span>
    try {
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">      if (RequestPacket.isRecvMode(rule.getMode())) {</span>
<span class="nc" id="L431">        session.getDir().changeDirectory(rule.getWorkPath());</span>
      } else {
<span class="fc" id="L433">        session.getDir().changeDirectory(rule.getSendPath());</span>
      }

<span class="fc bfc" id="L436" title="All 2 branches covered.">      if (request.getAction() == Action.List ||</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">          request.getAction() == Action.Mlsx) {</span>
        // ls or mls from current directory
<span class="fc bfc" id="L439" title="All 2 branches covered.">        if (request.getAction() == Action.List) {</span>
<span class="fc" id="L440">          list = session.getDir().list(request.getFile());</span>
        } else {
<span class="fc" id="L442">          list = session.getDir().listFull(request.getFile(), false);</span>
        }
      } else {
        // ls pr mls from current directory and filename
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (!request.isSetFile()) {</span>
<span class="nc" id="L447">          logger.warn(&quot;File missing&quot;);</span>
<span class="nc" id="L448">          list.add(&quot;File missing&quot;);</span>
<span class="nc" id="L449">          return list;</span>
        }
<span class="nc" id="L451">        final R66File file =</span>
<span class="nc" id="L452">            (R66File) session.getDir().setFile(request.getFile(), false);</span>
        String sresult;
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (request.getAction() == Action.Exist) {</span>
<span class="nc" id="L455">          sresult = String.valueOf(file.exists());</span>
<span class="nc" id="L456">          list.add(sresult);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">        } else if (request.getAction() == Action.Detail) {</span>
<span class="nc" id="L458">          sresult = session.getDir().fileFull(request.getFile(), false);</span>
<span class="nc" id="L459">          final String[] slist = sresult.split(&quot;\n&quot;);</span>
<span class="nc" id="L460">          sresult = slist[1];</span>
<span class="nc" id="L461">          list.add(sresult);</span>
        }
      }
<span class="fc" id="L464">      return list;</span>
<span class="nc" id="L465">    } catch (final CommandAbstractException e) {</span>
<span class="nc" id="L466">      logger.warn(&quot;Error occurs during: &quot; + request, e);</span>
<span class="nc" id="L467">      list.add(&quot;Error occurs during: &quot; + request);</span>
<span class="nc" id="L468">      return list;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>