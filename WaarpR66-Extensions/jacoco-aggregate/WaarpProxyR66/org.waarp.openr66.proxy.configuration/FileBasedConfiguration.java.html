<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FileBasedConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Extensions for JRE 8 and greater</a> &gt; <a href="../index.html" class="el_bundle">WaarpProxyR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.proxy.configuration</a> &gt; <span class="el_source">FileBasedConfiguration.java</span></div><h1>FileBasedConfiguration.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.proxy.configuration;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.waarp.common.database.DbAdmin;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.xml.XmlDecl;
import org.waarp.common.xml.XmlHash;
import org.waarp.common.xml.XmlRootHash;
import org.waarp.common.xml.XmlType;
import org.waarp.common.xml.XmlUtil;
import org.waarp.common.xml.XmlValue;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolSystemException;
import org.waarp.openr66.proxy.network.ProxyEntry;

import java.net.InetSocketAddress;

import static org.waarp.common.database.DbConstant.*;
import static org.waarp.openr66.configuration.FileBasedConfiguration.*;
import static org.waarp.openr66.configuration.FileBasedElements.*;

/**
 * File Based ConfigurationProxyR66
 */
public class FileBasedConfiguration {
  /**
   * Internal Logger
   */
<span class="fc" id="L50">  private static final WaarpLogger logger =</span>
<span class="fc" id="L51">      WaarpLoggerFactory.getLogger(FileBasedConfiguration.class);</span>

  /**
   * SERVER Association entry
   */
  private static final String XML_SERVER_PROXY = &quot;serverproxy&quot;;
  /**
   * SERVER Listening address
   */
  private static final String XML_SERVER_LISTENADDR = &quot;serverlistenaddr&quot;;
  /**
   * SERVER Listening port
   */
  private static final String XML_SERVER_LISTENPORT = &quot;serverlistenport&quot;;
  /**
   * SERVER Listening ssl mode
   */
  private static final String XML_SERVER_LISTENSSL = &quot;serverlistenssl&quot;;
  /**
   * SERVER Remote address
   */
  private static final String XML_SERVER_REMOTEADDR = &quot;serverremoteaddr&quot;;
  /**
   * SERVER Remote PORT
   */
  private static final String XML_SERVER_REMOTEPORT = &quot;serverremoteport&quot;;
  /**
   * SERVER Remote ssl mode
   */
  private static final String XML_SERVER_REMOTESSL = &quot;serverremotessl&quot;;

  /**
   * Structure of the ConfigurationProxyR66 file
   */
<span class="fc" id="L85">  private static final XmlDecl[] configServerParamDecls = {</span>
      // server
      new XmlDecl(XmlType.BOOLEAN, XML_USESSL),
      new XmlDecl(XmlType.BOOLEAN, XML_USENOSSL),
      new XmlDecl(XmlType.BOOLEAN, XML_USEHTTPCOMP),
      new XmlDecl(XmlType.STRING, XML_SERVER_ADMIN),
      new XmlDecl(XmlType.STRING, XML_SERVER_PASSWD),
      new XmlDecl(XmlType.STRING, XML_SERVER_PASSWD_FILE),
      new XmlDecl(XmlType.STRING, XML_HTTPADMINPATH),
      new XmlDecl(XmlType.STRING, XML_PATH_ADMIN_KEYPATH),
      new XmlDecl(XmlType.STRING, XML_PATH_ADMIN_KEYSTOREPASS),
      new XmlDecl(XmlType.STRING, XML_PATH_ADMIN_KEYPASS),
      new XmlDecl(XmlType.LONG, XML_MONITOR_PASTLIMIT),
      new XmlDecl(XmlType.LONG, XML_MONITOR_MINIMALDELAY),
      new XmlDecl(XmlType.STRING, XML_MONITOR_SNMP_CONFIG)
  };
  /**
   * Structure of the ConfigurationProxyR66 file
   */
<span class="fc" id="L104">  private static final XmlDecl[] configNetworkProxyDecls = {</span>
      // proxy
      new XmlDecl(XmlType.STRING, XML_SERVER_LISTENADDR),
      new XmlDecl(XmlType.INTEGER, XML_SERVER_LISTENPORT),
      new XmlDecl(XmlType.BOOLEAN, XML_SERVER_LISTENSSL),
      new XmlDecl(XmlType.STRING, XML_SERVER_REMOTEADDR),
      new XmlDecl(XmlType.INTEGER, XML_SERVER_REMOTEPORT),
      new XmlDecl(XmlType.BOOLEAN, XML_SERVER_REMOTESSL)
  };
  /**
   * Structure of the ConfigurationProxyR66 file
   */
<span class="fc" id="L116">  private static final XmlDecl[] configNetworkServerDecls = {</span>
      // network
      new XmlDecl(XML_SERVER_PROXY, XmlType.XVAL, XML_SERVER_PROXY,
                  configNetworkProxyDecls, true),
      new XmlDecl(XmlType.INTEGER, XML_SERVER_HTTPPORT),
      new XmlDecl(XmlType.INTEGER, XML_SERVER_HTTPSPORT)
  };

  /**
   * Structure of the ConfigurationProxyR66 file
   */
<span class="fc" id="L127">  private static final XmlDecl[] configDirectoryDecls = {</span>
      // directory
      new XmlDecl(XmlType.STRING, XML_SERVER_HOME),
      new XmlDecl(XmlType.STRING, XML_ARCHIVEPATH),
      new XmlDecl(XmlType.STRING, XML_CONFIGPATH)
  };

  /**
   * Structure of the ConfigurationProxyR66 file
   */
<span class="fc" id="L137">  private static final XmlDecl[] configLimitDecls = {</span>
      // limit
      new XmlDecl(XmlType.LONG, XML_LIMITSESSION),
      new XmlDecl(XmlType.LONG, XML_LIMITGLOBAL),
      new XmlDecl(XmlType.LONG, XML_LIMITDELAY),
      new XmlDecl(XmlType.LONG, XML_DELAYRETRY),
      new XmlDecl(XmlType.INTEGER, XML_SERVER_THREAD),
      new XmlDecl(XmlType.INTEGER, XML_CLIENT_THREAD),
      new XmlDecl(XmlType.LONG, XML_MEMORY_LIMIT),
      new XmlDecl(XmlType.BOOLEAN, XML_CSTRT_USECPULIMIT),
      new XmlDecl(XmlType.BOOLEAN, XML_CSTRT_USECPUJDKLIMIT),
      new XmlDecl(XmlType.DOUBLE, XML_CSTRT_CPULIMIT),
      new XmlDecl(XmlType.INTEGER, XML_CSTRT_CONNLIMIT),
      new XmlDecl(XmlType.DOUBLE, XML_CSTRT_LOWCPULIMIT),
      new XmlDecl(XmlType.DOUBLE, XML_CSTRT_HIGHCPULIMIT),
      new XmlDecl(XmlType.DOUBLE, XML_CSTRT_PERCENTDECREASE),
      new XmlDecl(XmlType.LONG, XML_CSTRT_LIMITLOWBANDWIDTH),
      new XmlDecl(XmlType.LONG, XML_CSTRT_DELAYTHROTTLE),
      new XmlDecl(XmlType.LONG, XML_TIMEOUTCON),
      new XmlDecl(XmlType.BOOLEAN, XML_CHECKVERSION)
  };

  /**
   * Global Structure for Server ConfigurationProxyR66
   */
<span class="fc" id="L162">  private static final XmlDecl[] configServer = {</span>
      new XmlDecl(XML_IDENTITY, XmlType.XVAL, XML_ROOT + XML_IDENTITY,
                  configIdentityDecls, false),
      new XmlDecl(XML_SERVER, XmlType.XVAL, XML_ROOT + XML_SERVER,
                  configServerParamDecls, false),
      new XmlDecl(XML_NETWORK, XmlType.XVAL, XML_ROOT + XML_NETWORK,
                  configNetworkServerDecls, false),
      new XmlDecl(XML_SSL, XmlType.XVAL, XML_ROOT + XML_SSL, configSslDecls,
                  false),
      new XmlDecl(XML_DIRECTORY, XmlType.XVAL, XML_ROOT + XML_DIRECTORY,
                  configDirectoryDecls, false),
      new XmlDecl(XML_LIMIT, XmlType.XVAL, XML_ROOT + XML_LIMIT,
                  configLimitDecls, false)
  };

  private static XmlHash hashConfig;

  private FileBasedConfiguration() {
  }

  private static boolean loadServerParam(final Configuration config) {
<span class="fc" id="L183">    XmlHash hashConfigSub = new XmlHash(hashConfig.get(XML_SERVER));</span>
    try {
<span class="fc" id="L185">      return org.waarp.openr66.configuration.FileBasedConfiguration.loadServerConfig(</span>
          config, hashConfigSub);
    } finally {
<span class="fc" id="L188">      hashConfigSub.clear();</span>
<span class="fc" id="L189">      hashConfigSub = null;</span>
    }
  }

  private static boolean loadDirectory(final Configuration config) {
<span class="fc" id="L194">    XmlHash hashConfigSub = new XmlHash(hashConfig.get(XML_DIRECTORY));</span>
    try {
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">      if (loadMinimalDirectory(config, hashConfigSub)) {</span>
<span class="nc" id="L197">        return false;</span>
      }
    } finally {
<span class="fc" id="L200">      hashConfigSub.clear();</span>
<span class="fc" id="L201">      hashConfigSub = null;</span>
    }
<span class="fc" id="L203">    return true;</span>
  }

  private static boolean alreadySetLimit;

  private static void loadLimit(final Configuration config,
                                final boolean updateLimit) {
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">    if (alreadySetLimit) {</span>
<span class="nc" id="L211">      return;</span>
    }
<span class="fc" id="L213">    final XmlHash hashConfigSub = new XmlHash(hashConfig.get(XML_LIMIT));</span>
    try {
<span class="fc" id="L215">      loadCommonLimit(config, hashConfigSub, updateLimit);</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">      if (config.getRunnerThread() &lt; 10) {</span>
<span class="nc" id="L217">        config.setRunnerThread(10);</span>
      }
<span class="fc" id="L219">      logger.info(&quot;Limit of Runner: {}&quot;, config.getRunnerThread());</span>
<span class="fc" id="L220">      alreadySetLimit = true;</span>
    } finally {
<span class="fc" id="L222">      hashConfigSub.clear();</span>
    }
<span class="fc" id="L224">  }</span>

  @SuppressWarnings(&quot;unchecked&quot;)
  private static boolean loadNetworkServer(final Configuration config) {
<span class="fc" id="L228">    config.setServerPort(0);</span>
<span class="fc" id="L229">    config.setServerSslPort(0);</span>
<span class="fc" id="L230">    XmlValue value = hashConfig.get(XML_SERVER_HTTPPORT);</span>
<span class="fc" id="L231">    int httpport = 8066;</span>
<span class="pc bpc" id="L232" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L233">      httpport = value.getInteger();</span>
    }
<span class="fc" id="L235">    config.setServerHttpport(httpport);</span>
<span class="fc" id="L236">    value = hashConfig.get(XML_SERVER_HTTPSPORT);</span>
<span class="fc" id="L237">    int httpsport = 8067;</span>
<span class="pc bpc" id="L238" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L239">      httpsport = value.getInteger();</span>
    }
<span class="fc" id="L241">    config.setServerHttpsPort(httpsport);</span>
    // XXX FIXME to change to accept multiple port according to relation local-proxy
<span class="fc" id="L243">    value = hashConfig.get(XML_SERVER_PROXY);</span>
<span class="pc bpc" id="L244" title="2 of 4 branches missed.">    if (value != null &amp;&amp; value.getList() != null) {</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">      for (final XmlValue[] xml : (Iterable&lt;XmlValue[]&gt;) value.getList()) {</span>
<span class="fc" id="L246">        final XmlHash subHash = new XmlHash(xml);</span>
<span class="fc" id="L247">        value = subHash.get(XML_SERVER_LISTENADDR);</span>
<span class="pc bpc" id="L248" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L249">          continue;</span>
        }
<span class="fc" id="L251">        final String listenaddr = value.getString();</span>
<span class="fc" id="L252">        value = subHash.get(XML_SERVER_LISTENPORT);</span>
<span class="pc bpc" id="L253" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L254">          continue;</span>
        }
<span class="fc" id="L256">        final int listenport = value.getInteger();</span>
<span class="fc" id="L257">        value = subHash.get(XML_SERVER_LISTENSSL);</span>
<span class="pc bpc" id="L258" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L259">          continue;</span>
        }
<span class="fc" id="L261">        final boolean listenssl = value.getBoolean();</span>
<span class="fc" id="L262">        value = subHash.get(XML_SERVER_REMOTEADDR);</span>
<span class="pc bpc" id="L263" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L264">          continue;</span>
        }
<span class="fc" id="L266">        final String remoteaddr = value.getString();</span>
<span class="fc" id="L267">        value = subHash.get(XML_SERVER_REMOTEPORT);</span>
<span class="pc bpc" id="L268" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L269">          continue;</span>
        }
<span class="fc" id="L271">        final int remoteport = value.getInteger();</span>
<span class="fc" id="L272">        value = subHash.get(XML_SERVER_REMOTESSL);</span>
<span class="pc bpc" id="L273" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L274">          continue;</span>
        }
<span class="fc" id="L276">        final boolean remotessl = value.getBoolean();</span>
<span class="fc" id="L277">        final InetSocketAddress local =</span>
            new InetSocketAddress(listenaddr, listenport);
<span class="fc" id="L279">        final InetSocketAddress remote =</span>
            new InetSocketAddress(remoteaddr, remoteport);
        try {
<span class="fc" id="L282">          ProxyEntry.add(local, listenssl, remote, remotessl);</span>
<span class="nc" id="L283">        } catch (final OpenR66ProtocolSystemException e) {</span>
<span class="nc" id="L284">          logger.error(&quot;Issue on configuration: {}&quot;, e.getMessage());</span>
<span class="nc" id="L285">          return false;</span>
<span class="fc" id="L286">        }</span>
<span class="fc" id="L287">      }</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">      if (ProxyEntry.proxyEntries.isEmpty()) {</span>
<span class="nc" id="L289">        logger.error(&quot;No proxy configuration found&quot;);</span>
<span class="nc" id="L290">        return false;</span>
      }
    } else {
<span class="nc" id="L293">      logger.error(&quot;No proxy configuration found&quot;);</span>
<span class="nc" id="L294">      return false;</span>
    }
<span class="fc" id="L296">    return true;</span>
  }

  /**
   * Load database parameter
   *
   * @param config
   *
   * @return True if OK
   */
  private static boolean loadDatabase(final Configuration config) {
<span class="fc" id="L307">    logger.info(&quot;No DBDriver in Config file for Proxy&quot;);</span>
<span class="fc" id="L308">    config.setSaveTaskRunnerWithNoDb(true);</span>
<span class="fc" id="L309">    admin = new DbAdmin(); // no database support</span>
<span class="fc" id="L310">    noCommitAdmin = admin;</span>
<span class="fc" id="L311">    return true;</span>
  }

  /**
   * Initiate the configuration from the xml file for server
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setConfigurationProxyFromXml(final Configuration config,
                                                     final String filename) {
    final Document document;
    // Open config file
    try {
<span class="fc" id="L327">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L328">    } catch (final DocumentException e) {</span>
<span class="nc" id="L329">      logger.error(&quot;Unable to read the XML Config file: &quot; + filename + &quot;: {}&quot;,</span>
<span class="nc" id="L330">                   e.getMessage());</span>
<span class="nc" id="L331">      return false;</span>
<span class="fc" id="L332">    }</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L334">      logger.error(&quot;Unable to read the XML Config file: &quot; + filename);</span>
<span class="nc" id="L335">      return false;</span>
    }
<span class="fc" id="L337">    XmlValue[] configuration = XmlUtil.read(document, configServer);</span>
<span class="fc" id="L338">    hashConfig = new XmlHash(configuration);</span>
<span class="fc" id="L339">    final XmlRootHash xmlRootHash = new XmlRootHash(configuration);</span>
<span class="fc" id="L340">    setXmlRootHash(xmlRootHash);</span>
    // Now read the configuration
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">    if (!loadIdentity(config, xmlRootHash)) {</span>
<span class="nc" id="L343">      logger.error(&quot;Cannot load Identity&quot;);</span>
<span class="nc" id="L344">      return false;</span>
    }
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">    if (!loadDatabase(config)) {</span>
<span class="nc" id="L347">      logger.error(&quot;Cannot load Database configuration&quot;);</span>
<span class="nc" id="L348">      return false;</span>
    }
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">    if (!loadServerParam(config)) {</span>
<span class="nc" id="L351">      logger.error(&quot;Cannot load Server Parameters&quot;);</span>
<span class="nc" id="L352">      return false;</span>
    }
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L355">      logger.error(&quot;Cannot load Directory configuration&quot;);</span>
<span class="nc" id="L356">      return false;</span>
    }
<span class="fc" id="L358">    loadLimit(config, false);</span>
<span class="pc bpc" id="L359" title="2 of 4 branches missed.">    if (config.isUseSSL() &amp;&amp; !loadSsl(config, xmlRootHash)) {</span>
<span class="nc" id="L360">      logger.error(&quot;Cannot load SSL configuration&quot;);</span>
<span class="nc" id="L361">      return false;</span>
    }
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">    if (!loadNetworkServer(config)) {</span>
<span class="nc" id="L364">      logger.error(&quot;Cannot load Network configuration&quot;);</span>
<span class="nc" id="L365">      return false;</span>
    }
<span class="fc" id="L367">    hashConfig.clear();</span>
<span class="fc" id="L368">    hashConfig = null;</span>
<span class="fc" id="L369">    xmlRootHash.clear();</span>
<span class="fc" id="L370">    configuration = null;</span>
<span class="fc" id="L371">    return true;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>