<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DbRule.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Proxy in R66 protocol</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.database.data</a> &gt; <span class="el_source">DbRule.java</span></div><h1>DbRule.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.database.data;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.waarp.common.database.DbConstant;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseNoDataException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.file.FileUtils;
import org.waarp.common.json.JsonHandler;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.common.xml.XmlUtil;
import org.waarp.common.xml.XmlValue;
import org.waarp.openr66.configuration.RuleFileBasedConfiguration;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.dao.AbstractDAO;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.dao.Filter;
import org.waarp.openr66.dao.RuleDAO;
import org.waarp.openr66.dao.database.DBRuleDAO;
import org.waarp.openr66.dao.database.StatementExecutor;
import org.waarp.openr66.dao.exception.DAOConnectionException;
import org.waarp.openr66.dao.exception.DAONoDataException;
import org.waarp.openr66.database.data.DbTaskRunner.TASKSTEP;
import org.waarp.openr66.pojo.Rule;
import org.waarp.openr66.pojo.RuleTask;
import org.waarp.openr66.pojo.Transfer;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;

import java.io.File;
import java.io.StringReader;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Rule Table object
 */
public class DbRule extends AbstractDbDataDao&lt;Rule&gt; {
  private static final String RULE_NOT_FOUND = &quot;Rule not found&quot;;
  /**
   * Internal Logger
   */
<span class="fc" id="L76">  private static final WaarpLogger logger =</span>
<span class="fc" id="L77">      WaarpLoggerFactory.getLogger(DbRule.class);</span>
<span class="fc" id="L78">  private static final String[] STRING_0_LENGTH = new String[0];</span>
<span class="fc" id="L79">  private static final String[][] STRINGS_0_0_LENGTH = new String[0][0];</span>

<span class="fc" id="L81">  public enum Columns {</span>
<span class="fc" id="L82">    HOSTIDS, MODETRANS, RECVPATH, SENDPATH, ARCHIVEPATH, WORKPATH, RPRETASKS,</span>
<span class="fc" id="L83">    RPOSTTASKS, RERRORTASKS, SPRETASKS, SPOSTTASKS, SERRORTASKS, UPDATEDINFO,</span>
<span class="fc" id="L84">    IDRULE</span>
  }

<span class="fc" id="L87">  public static final int[] dbTypes = {</span>
      Types.LONGVARCHAR, Types.INTEGER, Types.VARCHAR, Types.VARCHAR,
      Types.VARCHAR, Types.VARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.INTEGER, Types.NVARCHAR
  };

  public static final String table = &quot; RULES &quot;;

<span class="fc" id="L96">  public static final Columns[] indexes = {</span>
      Columns.UPDATEDINFO
  };

  /**
   * Internal context XML fields
   */
  public static final String TASK_TYPE = &quot;type&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_PATH = &quot;path&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_DELAY = &quot;delay&quot;;
  /**
   * Internal context XML fields
   */
  public static final String TASK_RANK = &quot;rank&quot;;
  /**
   * Internal context XML fields
   */
  public static final String TASK_COMMENT = &quot;comment&quot;;

<span class="fc" id="L123">  protected static final String selectAllFields =</span>
<span class="fc" id="L124">      Columns.HOSTIDS.name() + ',' + Columns.MODETRANS.name() + ',' +</span>
<span class="fc" id="L125">      Columns.RECVPATH.name() + ',' + Columns.SENDPATH.name() + ',' +</span>
<span class="fc" id="L126">      Columns.ARCHIVEPATH.name() + ',' + Columns.WORKPATH.name() + ',' +</span>
<span class="fc" id="L127">      Columns.RPRETASKS.name() + ',' + Columns.RPOSTTASKS.name() + ',' +</span>
<span class="fc" id="L128">      Columns.RERRORTASKS.name() + ',' + Columns.SPRETASKS.name() + ',' +</span>
<span class="fc" id="L129">      Columns.SPOSTTASKS.name() + ',' + Columns.SERRORTASKS.name() + ',' +</span>
<span class="fc" id="L130">      Columns.UPDATEDINFO.name() + ',' + Columns.IDRULE.name();</span>

  @Override
  protected final void initObject() {
    // Nothing
<span class="fc" id="L135">  }</span>

  @Override
  protected final String getTable() {
<span class="nc" id="L139">    return table;</span>
  }

  @Override
  protected final AbstractDAO&lt;Rule&gt; getDao(final boolean isCacheable)
      throws DAOConnectionException {
<span class="fc" id="L145">    return DAOFactory.getInstance().getRuleDAO(isCacheable);</span>
  }

  @Override
  protected final String getPrimaryKey() {
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">    if (pojo != null) {</span>
<span class="fc" id="L151">      return pojo.getName();</span>
    }
<span class="nc" id="L153">    throw new IllegalArgumentException(&quot;pojo is null&quot;);</span>
  }

  @Override
  protected final String getPrimaryField() {
<span class="fc" id="L158">    return Columns.IDRULE.name();</span>
  }

  protected final void checkPathes() throws WaarpDatabaseSqlException {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(getRecvPath()) &amp;&amp;</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        getRecvPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="fc" id="L164">      pojo.setRecvPath(DirInterface.SEPARATOR + getRecvPath());</span>
    }
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(getSendPath()) &amp;&amp;</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        getSendPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="fc" id="L168">      pojo.setSendPath(DirInterface.SEPARATOR + getSendPath());</span>
    }
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(getArchivePath()) &amp;&amp;</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        getArchivePath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="fc" id="L172">      pojo.setArchivePath(DirInterface.SEPARATOR + getArchivePath());</span>
    }
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(getWorkPath()) &amp;&amp;</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        getWorkPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="fc" id="L176">      pojo.setWorkPath(DirInterface.SEPARATOR + getWorkPath());</span>
    }
<span class="fc" id="L178">  }</span>

  /**
   * @param idRule
   * @param ids
   * @param mode
   * @param recvPath
   * @param sendPath
   * @param archivePath
   * @param workPath
   * @param rpreTasks
   * @param rpostTasks
   * @param rerrorTasks
   * @param spreTasks
   * @param spostTasks
   * @param serrorTasks
   */
  public DbRule(final String idRule, final String ids, final int mode,
                final String recvPath, final String sendPath,
                final String archivePath, final String workPath,
                final String rpreTasks, final String rpostTasks,
                final String rerrorTasks, final String spreTasks,
                final String spostTasks, final String serrorTasks)
<span class="fc" id="L201">      throws WaarpDatabaseSqlException {</span>
<span class="fc" id="L202">    pojo = new Rule(idRule, mode, Arrays.asList(getIdsRule(ids)), recvPath,</span>
                    sendPath, archivePath, workPath,
<span class="fc" id="L204">                    fromLegacyTasks(getTasksRule(rpreTasks)),</span>
<span class="fc" id="L205">                    fromLegacyTasks(getTasksRule(rpostTasks)),</span>
<span class="fc" id="L206">                    fromLegacyTasks(getTasksRule(rerrorTasks)),</span>
<span class="fc" id="L207">                    fromLegacyTasks(getTasksRule(spreTasks)),</span>
<span class="fc" id="L208">                    fromLegacyTasks(getTasksRule(spostTasks)),</span>
<span class="fc" id="L209">                    fromLegacyTasks(getTasksRule(serrorTasks)));</span>
<span class="fc" id="L210">    checkPathes();</span>
<span class="fc" id="L211">  }</span>

  /**
   * @param idRule
   *
   * @throws WaarpDatabaseException
   */
<span class="fc" id="L218">  public DbRule(final String idRule) throws WaarpDatabaseException {</span>
<span class="fc" id="L219">    RuleDAO ruleAccess = null;</span>
    try {
<span class="fc" id="L221">      ruleAccess = DAOFactory.getInstance().getRuleDAO(true);</span>
<span class="fc" id="L222">      pojo = ruleAccess.select(idRule);</span>
<span class="nc" id="L223">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L224">      throw new WaarpDatabaseException(e);</span>
<span class="fc" id="L225">    } catch (final DAONoDataException e) {</span>
<span class="fc" id="L226">      throw new WaarpDatabaseNoDataException(RULE_NOT_FOUND + &quot; &quot; + idRule, e);</span>
    } finally {
<span class="fc" id="L228">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="fc" id="L230">    checkPathes();</span>
<span class="fc" id="L231">  }</span>

<span class="fc" id="L233">  public DbRule(final Rule rule) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">    if (rule == null) {</span>
<span class="nc" id="L235">      throw new IllegalArgumentException(</span>
          &quot;Argument in constructor cannot be null&quot;);
    }
<span class="fc" id="L238">    this.pojo = rule;</span>
    try {
<span class="fc" id="L240">      checkPathes();</span>
<span class="nc" id="L241">    } catch (final WaarpDatabaseSqlException e) {</span>
<span class="nc" id="L242">      throw new IllegalArgumentException(e);</span>
<span class="fc" id="L243">    }</span>
<span class="fc" id="L244">  }</span>

  /**
   * Constructor used from XML file
   *
   * @param idrule
   * @param idsArrayRef
   * @param recvpath
   * @param sendpath
   * @param archivepath
   * @param workpath
   * @param rpretasksArray
   * @param rposttasksArray
   * @param rerrortasksArray
   * @param spretasksArray
   * @param sposttasksArray
   * @param serrortasksArray
   */
  public DbRule(final String idrule, String[] idsArrayRef, final int mode,
                final String recvpath, final String sendpath,
                final String archivepath, final String workpath,
                final String[][] rpretasksArray,
                final String[][] rposttasksArray,
                final String[][] rerrortasksArray,
                final String[][] spretasksArray,
                final String[][] sposttasksArray,
                final String[][] serrortasksArray)
<span class="fc" id="L271">      throws WaarpDatabaseSqlException {</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">    if (idsArrayRef == null) {</span>
<span class="nc" id="L273">      idsArrayRef = STRING_0_LENGTH;</span>
    }
<span class="fc" id="L275">    pojo =</span>
<span class="fc" id="L276">        new Rule(idrule, mode, Arrays.asList(idsArrayRef), recvpath, sendpath,</span>
<span class="fc" id="L277">                 archivepath, workpath, fromLegacyTasks(rpretasksArray),</span>
<span class="fc" id="L278">                 fromLegacyTasks(rposttasksArray),</span>
<span class="fc" id="L279">                 fromLegacyTasks(rerrortasksArray),</span>
<span class="fc" id="L280">                 fromLegacyTasks(spretasksArray),</span>
<span class="fc" id="L281">                 fromLegacyTasks(sposttasksArray),</span>
<span class="fc" id="L282">                 fromLegacyTasks(serrortasksArray));</span>
<span class="fc" id="L283">    checkPathes();</span>
<span class="fc" id="L284">  }</span>

  /**
   * Constructor from Json
   *
   * @param source
   *
   * @throws WaarpDatabaseSqlException
   */
<span class="fc" id="L293">  public DbRule(final ObjectNode source) throws WaarpDatabaseSqlException {</span>
<span class="fc" id="L294">    pojo = new Rule();</span>
<span class="fc" id="L295">    setFromJson(source, false);</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">    if (ParametersChecker.isEmpty(getIdRule())) {</span>
<span class="nc" id="L297">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="fc" id="L300">    checkPathes();</span>
<span class="fc" id="L301">  }</span>

  @Override
  protected final void checkValues() throws WaarpDatabaseSqlException {
<span class="fc" id="L305">    pojo.checkValues();</span>
<span class="fc" id="L306">  }</span>

  @Override
  public final void setFromJson(final ObjectNode node,
                                final boolean ignorePrimaryKey)
      throws WaarpDatabaseSqlException {
<span class="fc" id="L312">    super.setFromJson(node, ignorePrimaryKey);</span>
<span class="fc" id="L313">    checkPathes();</span>
<span class="fc" id="L314">  }</span>

  @Override
  protected final void setFromJson(final String field, final JsonNode value)
      throws WaarpDatabaseSqlException {
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L320">      return;</span>
    }
<span class="fc bfc" id="L322" title="All 2 branches covered.">    for (final Columns column : Columns.values()) {</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">      if (column.name().equalsIgnoreCase(field)) {</span>
<span class="pc bpc" id="L324" title="2 of 15 branches missed.">        switch (column) {</span>
          case ARCHIVEPATH:
<span class="fc" id="L326">            pojo.setArchivePath(value.asText());</span>
<span class="fc" id="L327">            break;</span>
          case HOSTIDS:
<span class="fc" id="L329">            pojo.setHostids(Arrays.asList(getIdsRule(value.asText())));</span>
<span class="fc" id="L330">            break;</span>
          case IDRULE:
<span class="fc" id="L332">            pojo.setName(value.asText());</span>
<span class="fc" id="L333">            break;</span>
          case MODETRANS:
<span class="fc" id="L335">            pojo.setMode(value.asInt());</span>
<span class="fc" id="L336">            break;</span>
          case RECVPATH:
<span class="fc" id="L338">            pojo.setRecvPath(value.asText());</span>
<span class="fc" id="L339">            break;</span>
          case RERRORTASKS:
<span class="fc" id="L341">            pojo.setRErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L342">            break;</span>
          case RPOSTTASKS:
<span class="fc" id="L344">            pojo.setRPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L345">            break;</span>
          case RPRETASKS:
<span class="fc" id="L347">            pojo.setRPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L348">            break;</span>
          case SENDPATH:
<span class="fc" id="L350">            pojo.setSendPath(value.asText());</span>
<span class="fc" id="L351">            break;</span>
          case SERRORTASKS:
<span class="fc" id="L353">            pojo.setSErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L354">            break;</span>
          case SPOSTTASKS:
<span class="fc" id="L356">            pojo.setSPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L357">            break;</span>
          case SPRETASKS:
<span class="fc" id="L359">            pojo.setSPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="fc" id="L360">            break;</span>
          case WORKPATH:
<span class="fc" id="L362">            pojo.setWorkPath(value.asText());</span>
<span class="fc" id="L363">            break;</span>
          case UPDATEDINFO:
<span class="nc" id="L365">            pojo.setUpdatedInfo(</span>
<span class="nc" id="L366">                org.waarp.openr66.pojo.UpdatedInfo.valueOf(value.asInt()));</span>
            break;
        }
      }
    }
<span class="fc" id="L371">    checkPathes();</span>
<span class="fc" id="L372">  }</span>

  /**
   * Private constructor for Commander only
   */
<span class="fc" id="L377">  private DbRule() {</span>
<span class="fc" id="L378">    pojo = new Rule();</span>
<span class="fc" id="L379">  }</span>

  /**
   * Delete object from table DbRule only if no DbTaskRunner is using it.
   *
   * @throws WaarpDatabaseException
   */
  @Override
  public final void delete() throws WaarpDatabaseException {
<span class="fc" id="L388">    AbstractDAO&lt;Transfer&gt; transferDAO = null;</span>
    try {
<span class="fc" id="L390">      transferDAO = DAOFactory.getInstance().getTransferDAO();</span>
<span class="fc" id="L391">      final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;();</span>
<span class="fc" id="L392">      final Filter filter =</span>
<span class="fc" id="L393">          new Filter(DbTaskRunner.Columns.IDRULE.name(), &quot;=&quot;, this.getIdRule());</span>
<span class="fc" id="L394">      filters.add(filter);</span>
<span class="fc" id="L395">      final long nb = transferDAO.count(filters);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">      if (nb &gt; 0) {</span>
<span class="fc" id="L397">        throw new WaarpDatabaseNoDataException(&quot;Rule &quot; + this.getIdRule() +</span>
                                               &quot; is still used by TaskRunner therefore it cannot be deleted.&quot;);
      }
<span class="nc" id="L400">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L401">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L403">      DAOFactory.closeDAO(transferDAO);</span>
    }
<span class="fc" id="L405">    super.delete();</span>
<span class="fc" id="L406">  }</span>

  /**
   * Delete all Rules but returns original one, therefore not checking if
   * any TaskRunner are using it (used by reloading rules)
   *
   * @return the previously existing DbRule
   *
   * @throws WaarpDatabaseException
   */
  public static DbRule[] deleteAll() throws WaarpDatabaseException {
<span class="nc" id="L417">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L420">      ruleAccess = DAOFactory.getInstance().getRuleDAO(false);</span>
<span class="nc" id="L421">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L422">      ruleAccess.deleteAll();</span>
<span class="nc" id="L423">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L424">      throw new WaarpDatabaseException(e);</span>
    } finally {
<span class="nc" id="L426">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L428">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L429">    int i = 0;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L431">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L432">      res[i].isSaved = false;</span>
<span class="nc" id="L433">      i++;</span>
<span class="nc" id="L434">    }</span>
<span class="nc" id="L435">    return res;</span>
  }

  /**
   * Get All DbRule from database or from internal hashMap in case of no
   * database support
   *
   * @return the array of DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule[] getAllRules()
      throws WaarpDatabaseNoConnectionException {
<span class="fc" id="L449">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="fc" id="L452">      ruleAccess = DAOFactory.getInstance().getRuleDAO(false);</span>
<span class="fc" id="L453">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L454">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L455">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L457">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="fc" id="L459">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="fc" id="L460">    int i = 0;</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">    for (final Rule rule : rules) {</span>
<span class="fc" id="L462">      res[i] = new DbRule(rule);</span>
<span class="fc" id="L463">      i++;</span>
<span class="fc" id="L464">    }</span>
<span class="fc" id="L465">    return res;</span>
  }

  /**
   * For instance from Commander when getting updated information
   *
   * @param preparedStatement
   *
   * @return the next updated DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule getFromStatement(
      final DbPreparedStatement preparedStatement)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L481">    final DbRule dbRule = new DbRule();</span>
<span class="fc" id="L482">    AbstractDAO&lt;Rule&gt; ruleDAO = null;</span>
    try {
<span class="fc" id="L484">      ruleDAO = dbRule.getDao(false);</span>
<span class="fc" id="L485">      dbRule.pojo = ((StatementExecutor&lt;Rule&gt;) ruleDAO).getFromResultSet(</span>
<span class="fc" id="L486">          preparedStatement.getResultSet());</span>
<span class="fc" id="L487">      return dbRule;</span>
<span class="nc" id="L488">    } catch (final SQLException e) {</span>
<span class="nc" id="L489">      DbConstant.error(e);</span>
<span class="nc" id="L490">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
<span class="nc" id="L491">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L492">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
    } finally {
<span class="fc" id="L494">      DAOFactory.closeDAO(ruleDAO);</span>
    }
  }

  /**
   * @return the DbPreparedStatement for getting Updated Object
   *
   * @throws WaarpDatabaseNoConnectionException
   */
  public static DbRule[] getUpdatedPrepareStament()
      throws WaarpDatabaseNoConnectionException {
<span class="fc" id="L505">    final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;(1);</span>
<span class="fc" id="L506">    filters.add(new Filter(DBRuleDAO.UPDATED_INFO_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L507">                           org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(</span>
<span class="fc" id="L508">                               UpdatedInfo.TOSUBMIT).ordinal()));</span>
<span class="fc" id="L509">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="fc" id="L512">      ruleAccess = DAOFactory.getInstance().getRuleDAO(false);</span>
<span class="fc" id="L513">      rules = ruleAccess.find(filters);</span>
<span class="nc" id="L514">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L515">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L517">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="fc" id="L519">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="fc" id="L520">    int i = 0;</span>
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L522">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L523">      i++;</span>
<span class="nc" id="L524">    }</span>
<span class="fc" id="L525">    return res;</span>
  }

  @Override
  public final void changeUpdatedInfo(final UpdatedInfo info) {
<span class="fc" id="L530">    isSaved = false;</span>
<span class="fc" id="L531">    pojo.setUpdatedInfo(org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(info));</span>
<span class="fc" id="L532">  }</span>

  /**
   * Get Ids from String. If it is not ok, then it sets the default values and
   * return False, else returns True.
   *
   * @param idsref
   *
   * @return True if ok, else False (default values).
   */
  private String[] getIdsRule(final String idsref) {
<span class="fc bfc" id="L543" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(idsref)) {</span>
      // No ids so setting to the default!
<span class="fc" id="L545">      return STRING_0_LENGTH;</span>
    }
<span class="fc" id="L547">    final StringReader reader = new StringReader(idsref);</span>
    final Document document;
    try {
<span class="fc" id="L550">      document = XmlUtil.getNewSaxReader().read(reader);</span>
<span class="fc" id="L551">      final XmlValue[] values =</span>
<span class="fc" id="L552">          XmlUtil.read(document, RuleFileBasedConfiguration.hostsDecls);</span>
<span class="fc" id="L553">      return RuleFileBasedConfiguration.getHostIds(values[0]);</span>
<span class="nc" id="L554">    } catch (final DocumentException e) {</span>
<span class="nc" id="L555">      logger.warn(&quot;Unable to read the ids for Rule: &quot; + idsref + &quot; : {}&quot;,</span>
<span class="nc" id="L556">                  e.getMessage());</span>
      // No ids so setting to the default!
<span class="nc" id="L558">      return STRING_0_LENGTH;</span>
    } finally {
<span class="fc" id="L560">      FileUtils.close(reader);</span>
    }
  }

  /**
   * Get Tasks from String. If it is not ok, then it sets the default values
   * and
   * return new array of Tasks or
   * null if in error.
   *
   * @param tasks
   *
   * @return Array of tasks or empty array if in error.
   */
  private String[][] getTasksRule(final String tasks) {
<span class="fc bfc" id="L575" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(tasks)) {</span>
      // No tasks so setting to the default!
<span class="fc" id="L577">      return STRINGS_0_0_LENGTH;</span>
    }
<span class="fc" id="L579">    final StringReader reader = new StringReader(tasks);</span>
    final Document document;
    try {
<span class="fc" id="L582">      document = XmlUtil.getNewSaxReader().read(reader);</span>
<span class="nc" id="L583">    } catch (final DocumentException e) {</span>
      // No tasks so setting to the default!
<span class="nc" id="L585">      FileUtils.close(reader);</span>
<span class="nc" id="L586">      return STRINGS_0_0_LENGTH;</span>
<span class="fc" id="L587">    }</span>
<span class="fc" id="L588">    final XmlValue[] values =</span>
<span class="fc" id="L589">        XmlUtil.read(document, RuleFileBasedConfiguration.tasksDecl);</span>
<span class="fc" id="L590">    final String[][] result =</span>
<span class="fc" id="L591">        RuleFileBasedConfiguration.getTasksRule(values[0]);</span>
<span class="fc" id="L592">    FileUtils.close(reader);</span>
<span class="fc" id="L593">    return result;</span>
  }

  /**
   * Get the full path from RecvPath (used only in copy MODETRANS)
   *
   * @param filename
   *
   * @return the full String path
   */
  public final String setRecvPath(final String filename) {
<span class="fc bfc" id="L604" title="All 2 branches covered.">    if (ParametersChecker.isNotEmpty(pojo.getRecvPath())) {</span>
<span class="fc" id="L605">      return pojo.getRecvPath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="fc" id="L607">    return Configuration.configuration.getInPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from sendPath
   *
   * @param filename
   *
   * @return the full String path
   */
  public final String setSendPath(final String filename) {
<span class="nc bnc" id="L619" title="All 2 branches missed.">    if (pojo.getSendPath() != null) {</span>
<span class="nc" id="L620">      final File file = new File(filename);</span>
<span class="nc" id="L621">      final String basename = file.getName();</span>
<span class="nc" id="L622">      return pojo.getSendPath() + DirInterface.SEPARATOR + basename;</span>
    }
<span class="nc" id="L624">    return Configuration.configuration.getOutPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from archivePath
   *
   * @param filename
   *
   * @return the full String path
   */
  public final String setArchivePath(final String filename) {
<span class="nc bnc" id="L636" title="All 2 branches missed.">    if (pojo.getArchivePath() != null) {</span>
<span class="nc" id="L637">      return pojo.getArchivePath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="nc" id="L639">    return Configuration.configuration.getArchivePath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Get the full path from workPath
   *
   * @param filename
   *
   * @return the full String path
   */
  public final String setWorkingPath(final String filename) {
<span class="nc bnc" id="L651" title="All 2 branches missed.">    if (pojo.getWorkPath() != null) {</span>
<span class="nc" id="L652">      return pojo.getWorkPath() + DirInterface.SEPARATOR + filename +</span>
             Configuration.EXT_R66;
    }
<span class="nc" id="L655">    return Configuration.configuration.getWorkingPath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Check if the given hostTo is in the allowed list
   *
   * @param hostId
   *
   * @return True if allow, else False
   */
  public final boolean checkHostAllow(final String hostId) {
<span class="pc bpc" id="L667" title="2 of 4 branches missed.">    if (getIdsArray() == null || getIdsArray().length == 0) {</span>
<span class="fc" id="L668">      return true; // always true in this case</span>
    }
<span class="nc bnc" id="L670" title="All 2 branches missed.">    for (final String element : getIdsArray()) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">      if (element.equalsIgnoreCase(hostId)) {</span>
<span class="nc" id="L672">        return true;</span>
      }
    }
<span class="nc" id="L675">    return false;</span>
  }

  /**
   * @return True if this rule is adapted for SENDMODE
   */
  public final boolean isSendMode() {
<span class="fc bfc" id="L682" title="All 2 branches covered.">    return !RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * @return True if this rule is adapted for RECVMODE
   */
  public final boolean isRecvMode() {
<span class="fc" id="L689">    return RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  @Override
  public final String toString() {
<span class="fc" id="L701">    return &quot;Rule Name:&quot; + getIdRule() + &quot; IDS:&quot; + pojo.getXMLHostids() +</span>
<span class="fc" id="L702">           &quot; MODETRANS: &quot; + RequestPacket.TRANSFERMODE.values()[getMode()] +</span>
<span class="fc" id="L703">           &quot; RECV:&quot; + getRecvPath() + &quot; SEND:&quot; + getSendPath() + &quot; ARCHIVE:&quot; +</span>
<span class="fc" id="L704">           getArchivePath() + &quot; WORK:&quot; + getWorkPath() + &quot; RPRET:{&quot; +</span>
<span class="fc" id="L705">           pojo.getXMLRPreTasks().replace('\n', ' ') + &quot;} RPOST:{&quot; +</span>
<span class="fc" id="L706">           pojo.getXMLRPostTasks().replace('\n', ' ') + &quot;} RERROR:{&quot; +</span>
<span class="fc" id="L707">           pojo.getXMLRErrorTasks().replace('\n', ' ') + &quot;} SPRET:{&quot; +</span>
<span class="fc" id="L708">           pojo.getXMLSPreTasks().replace('\n', ' ') + &quot;} SPOST:{&quot; +</span>
<span class="fc" id="L709">           pojo.getXMLSPostTasks().replace('\n', ' ') + &quot;} SERROR:{&quot; +</span>
<span class="fc" id="L710">           pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
  }

  /**
   * @param isSender
   * @param step
   *
   * @return a string that prints (debug) the tasks to execute
   */
  public final String printTasks(final boolean isSender, final TASKSTEP step) {
<span class="nc bnc" id="L720" title="All 2 branches missed.">    if (isSender) {</span>
<span class="nc bnc" id="L721" title="All 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="nc" id="L723">          return &quot;S:{&quot; + pojo.getXMLSPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="nc" id="L725">          return &quot;S:{&quot; + pojo.getXMLSPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L727">          return &quot;S:{&quot; + pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L729">          return &quot;S:{no task}&quot;;</span>
      }
    } else {
<span class="nc bnc" id="L732" title="All 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="nc" id="L734">          return &quot;R:{&quot; + pojo.getXMLRPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="nc" id="L736">          return &quot;R:{&quot; + pojo.getXMLRPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L738">          return &quot;R:{&quot; + pojo.getXMLRErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L740">          return &quot;R:{no task}&quot;;</span>
      }
    }
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  public final String toShortString() {
<span class="nc" id="L753">    return &quot;Rule Name:&quot; + getIdRule() + &quot; MODETRANS: &quot; +</span>
<span class="nc" id="L754">           RequestPacket.TRANSFERMODE.values()[getMode()];</span>
  }

  /**
   * @param session
   * @param rule
   * @param mode
   *
   * @return the DbPreparedStatement according to the filter
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbPreparedStatement getFilterPrepareStament(
      final DbSession session, final String rule, final int mode)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L770">    final DbPreparedStatement preparedStatement =</span>
        new DbPreparedStatement(session);
<span class="fc" id="L772">    final String request = &quot;SELECT &quot; + selectAllFields + &quot; FROM &quot; + table;</span>
<span class="fc" id="L773">    String condition = null;</span>
<span class="pc bpc" id="L774" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(rule)) {</span>
<span class="nc" id="L775">      condition = &quot; WHERE &quot; + Columns.IDRULE.name() + &quot; = '&quot; + rule + &quot;' &quot;;</span>
    }
<span class="fc bfc" id="L777" title="All 2 branches covered.">    if (mode &gt;= 0) {</span>
<span class="pc bpc" id="L778" title="1 of 2 branches missed.">      if (condition != null) {</span>
<span class="nc" id="L779">        condition += &quot; AND &quot;;</span>
      } else {
<span class="fc" id="L781">        condition = &quot; WHERE &quot;;</span>
      }
<span class="fc" id="L783">      condition += Columns.MODETRANS.name() + &quot; = ?&quot;;</span>
    } else {
<span class="fc" id="L785">      condition = &quot;&quot;;</span>
    }
<span class="fc" id="L787">    preparedStatement.createPrepareStatement(</span>
<span class="fc" id="L788">        request + condition + &quot; ORDER BY &quot; + Columns.IDRULE.name());</span>
<span class="fc bfc" id="L789" title="All 2 branches covered.">    if (mode &gt;= 0) {</span>
      try {
<span class="fc" id="L791">        preparedStatement.getPreparedStatement().setInt(1, mode);</span>
<span class="nc" id="L792">      } catch (final SQLException e) {</span>
<span class="nc" id="L793">        preparedStatement.realClose();</span>
<span class="nc" id="L794">        throw new WaarpDatabaseSqlException(e);</span>
<span class="fc" id="L795">      }</span>
    }
<span class="fc" id="L797">    return preparedStatement;</span>
  }

  /**
   * Write selected DbRule to a Json String
   *
   * @param preparedStatement
   *
   * @return the associated Json String
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static String getJson(final DbPreparedStatement preparedStatement,
                               final int limit)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L813">    final ArrayNode arrayNode = JsonHandler.createArrayNode();</span>
    try {
<span class="fc" id="L815">      preparedStatement.executeQuery();</span>
<span class="fc" id="L816">      int nb = 0;</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">      while (preparedStatement.getNext()) {</span>
<span class="fc" id="L818">        final DbRule rule = getFromStatement(preparedStatement);</span>
<span class="fc" id="L819">        final ObjectNode node = rule.getInternalJson();</span>
<span class="fc" id="L820">        arrayNode.add(node);</span>
<span class="fc" id="L821">        nb++;</span>
<span class="fc bfc" id="L822" title="All 2 branches covered.">        if (nb &gt;= limit) {</span>
<span class="fc" id="L823">          break;</span>
        }
<span class="fc" id="L825">      }</span>
    } finally {
<span class="fc" id="L827">      preparedStatement.realClose();</span>
    }
    // \n is not correctly parsed within HTML so put double \\n in fine
<span class="fc" id="L830">    return WaarpStringUtils.cleanJsonForHtml(</span>
<span class="fc" id="L831">        JsonHandler.writeAsString(arrayNode));</span>
  }

  private ObjectNode getInternalJson() {
<span class="fc" id="L835">    final ObjectNode node = getJson();</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">    if (pojo.getHostids().isEmpty()) {</span>
<span class="fc" id="L837">      node.put(Columns.HOSTIDS.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L839" title="1 of 2 branches missed.">    if (pojo.getRecvPath() == null) {</span>
<span class="nc" id="L840">      node.put(Columns.RECVPATH.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">    if (pojo.getSendPath() == null) {</span>
<span class="nc" id="L843">      node.put(Columns.SENDPATH.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">    if (pojo.getArchivePath() == null) {</span>
<span class="nc" id="L846">      node.put(Columns.ARCHIVEPATH.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L848" title="1 of 2 branches missed.">    if (pojo.getWorkPath() == null) {</span>
<span class="nc" id="L849">      node.put(Columns.WORKPATH.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">    if (pojo.getRPreTasks().isEmpty()) {</span>
<span class="nc" id="L852">      node.put(Columns.RPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">    if (pojo.getRPostTasks().isEmpty()) {</span>
<span class="nc" id="L855">      node.put(Columns.RPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L857" title="1 of 2 branches missed.">    if (pojo.getRErrorTasks().isEmpty()) {</span>
<span class="nc" id="L858">      node.put(Columns.RERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="fc bfc" id="L860" title="All 2 branches covered.">    if (pojo.getSPreTasks().isEmpty()) {</span>
<span class="fc" id="L861">      node.put(Columns.SPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="fc bfc" id="L863" title="All 2 branches covered.">    if (pojo.getSPostTasks().isEmpty()) {</span>
<span class="fc" id="L864">      node.put(Columns.SPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="pc bpc" id="L866" title="1 of 2 branches missed.">    if (pojo.getSErrorTasks().isEmpty()) {</span>
<span class="nc" id="L867">      node.put(Columns.SERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="fc" id="L869">    return node;</span>
  }

  /**
   * @return the Json string for this
   */
  public final String getJsonAsString() {
<span class="fc" id="L876">    final ObjectNode node = getInternalJson();</span>
<span class="fc" id="L877">    return WaarpStringUtils.cleanJsonForHtml(JsonHandler.writeAsString(node));</span>
  }

  /**
   * @param session
   * @param body
   *
   * @return the runner in Html format specified by body by replacing all
   *     instance of fields
   */
  public final String toSpecializedHtml(final R66Session session,
                                        final String body) {
<span class="fc" id="L889">    final StringBuilder builder = new StringBuilder(body);</span>
<span class="fc" id="L890">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, getIdRule());</span>
<span class="fc" id="L891">    WaarpStringUtils.replace(builder, &quot;XXXIDSXXX&quot;,</span>
<span class="pc bpc" id="L892" title="1 of 2 branches missed.">                             pojo.getXMLHostids() == null? &quot;&quot; :</span>
<span class="fc" id="L893">                                 pojo.getXMLHostids());</span>
<span class="fc bfc" id="L894" title="All 2 branches covered.">    if (getMode() == RequestPacket.TRANSFERMODE.RECVMODE.ordinal()) {</span>
<span class="fc" id="L895">      WaarpStringUtils.replace(builder, &quot;XXXRECVXXX&quot;, &quot;checked&quot;);</span>
<span class="fc bfc" id="L896" title="All 2 branches covered.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMODE.ordinal()) {</span>
<span class="fc" id="L897">      WaarpStringUtils.replace(builder, &quot;XXXSENDXXX&quot;, &quot;checked&quot;);</span>
<span class="fc bfc" id="L898" title="All 2 branches covered.">    } else if (getMode() == RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal()) {</span>
<span class="fc" id="L899">      WaarpStringUtils.replace(builder, &quot;XXXRECVMXXX&quot;, &quot;checked&quot;);</span>
<span class="fc bfc" id="L900" title="All 2 branches covered.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal()) {</span>
<span class="fc" id="L901">      WaarpStringUtils.replace(builder, &quot;XXXSENDMXXX&quot;, &quot;checked&quot;);</span>
<span class="fc" id="L902">    } else if (getMode() ==</span>
<span class="fc bfc" id="L903" title="All 2 branches covered.">               RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal()) {</span>
<span class="fc" id="L904">      WaarpStringUtils.replace(builder, &quot;XXXRECVTXXX&quot;, &quot;checked&quot;);</span>
<span class="fc" id="L905">    } else if (getMode() ==</span>
<span class="pc bpc" id="L906" title="1 of 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal()) {</span>
<span class="fc" id="L907">      WaarpStringUtils.replace(builder, &quot;XXXSENDTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L908">    } else if (getMode() ==</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L910">      WaarpStringUtils.replace(builder, &quot;XXXRECVMTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L911">    } else if (getMode() ==</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L913">      WaarpStringUtils.replace(builder, &quot;XXXSENDMTXXX&quot;, &quot;checked&quot;);</span>
    }
<span class="fc" id="L915">    WaarpStringUtils.replace(builder, &quot;XXXRPXXX&quot;,</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">                             pojo.getRecvPath() == null? &quot;&quot; :</span>
<span class="fc" id="L917">                                 pojo.getRecvPath());</span>
<span class="fc" id="L918">    WaarpStringUtils.replace(builder, &quot;XXXSPXXX&quot;,</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">                             pojo.getSendPath() == null? &quot;&quot; :</span>
<span class="fc" id="L920">                                 pojo.getSendPath());</span>
<span class="fc" id="L921">    WaarpStringUtils.replace(builder, &quot;XXXAPXXX&quot;,</span>
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">                             pojo.getArchivePath() == null? &quot;&quot; :</span>
<span class="fc" id="L923">                                 pojo.getArchivePath());</span>
<span class="fc" id="L924">    WaarpStringUtils.replace(builder, &quot;XXXWPXXX&quot;,</span>
<span class="pc bpc" id="L925" title="1 of 2 branches missed.">                             pojo.getWorkPath() == null? &quot;&quot; :</span>
<span class="fc" id="L926">                                 pojo.getWorkPath());</span>
<span class="fc" id="L927">    WaarpStringUtils.replace(builder, &quot;XXXRPTXXX&quot;,</span>
<span class="pc bpc" id="L928" title="1 of 2 branches missed.">                             pojo.getXMLRPreTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L929">                                 pojo.getXMLRPreTasks());</span>
<span class="fc" id="L930">    WaarpStringUtils.replace(builder, &quot;XXXRSTXXX&quot;,</span>
<span class="pc bpc" id="L931" title="1 of 2 branches missed.">                             pojo.getXMLRPostTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L932">                                 pojo.getXMLRPostTasks());</span>
<span class="fc" id="L933">    WaarpStringUtils.replace(builder, &quot;XXXRETXXX&quot;,</span>
<span class="pc bpc" id="L934" title="1 of 2 branches missed.">                             pojo.getXMLRErrorTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L935">                                 pojo.getXMLRErrorTasks());</span>
<span class="fc" id="L936">    WaarpStringUtils.replace(builder, &quot;XXXSPTXXX&quot;,</span>
<span class="pc bpc" id="L937" title="1 of 2 branches missed.">                             pojo.getXMLSPreTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L938">                                 pojo.getXMLSPreTasks());</span>
<span class="fc" id="L939">    WaarpStringUtils.replace(builder, &quot;XXXSSTXXX&quot;,</span>
<span class="pc bpc" id="L940" title="1 of 2 branches missed.">                             pojo.getXMLSPostTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L941">                                 pojo.getXMLSPostTasks());</span>
<span class="fc" id="L942">    WaarpStringUtils.replace(builder, &quot;XXXSETXXX&quot;,</span>
<span class="pc bpc" id="L943" title="1 of 2 branches missed.">                             pojo.getXMLSErrorTasks() == null? &quot;&quot; :</span>
<span class="fc" id="L944">                                 pojo.getXMLSErrorTasks());</span>
<span class="fc" id="L945">    return builder.toString();</span>
  }

  /**
   * @return the recvPath
   */
  public final String getRecvPath() {
<span class="fc bfc" id="L952" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(getRuleRecvPath())) {</span>
<span class="fc" id="L953">      return Configuration.configuration.getInPath();</span>
    }
<span class="fc" id="L955">    return getRuleRecvPath();</span>
  }

  /**
   * @return the sendPath
   */
  public final String getSendPath() {
<span class="fc bfc" id="L962" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(getRuleSendPath())) {</span>
<span class="fc" id="L963">      return Configuration.configuration.getOutPath();</span>
    }
<span class="fc" id="L965">    return getRuleSendPath();</span>
  }

  /**
   * @return the archivePath
   */
  public final String getArchivePath() {
<span class="fc bfc" id="L972" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(getRuleArchivePath())) {</span>
<span class="fc" id="L973">      return Configuration.configuration.getArchivePath();</span>
    }
<span class="fc" id="L975">    return getRuleArchivePath();</span>
  }

  /**
   * @return the workPath
   */
  public final String getWorkPath() {
<span class="fc bfc" id="L982" title="All 2 branches covered.">    if (ParametersChecker.isEmpty(getRuleWorkPath())) {</span>
<span class="fc" id="L983">      return Configuration.configuration.getWorkingPath();</span>
    }
<span class="fc" id="L985">    return getRuleWorkPath();</span>
  }

  /**
   * @return the Rule recvPath
   */
  public final String getRuleRecvPath() {
<span class="fc" id="L992">    return pojo.getRecvPath();</span>
  }

  /**
   * @return the Rule sendPath
   */
  public final String getRuleSendPath() {
<span class="fc" id="L999">    return pojo.getSendPath();</span>
  }

  /**
   * @return the Rule archivePath
   */
  public final String getRuleArchivePath() {
<span class="fc" id="L1006">    return pojo.getArchivePath();</span>
  }

  /**
   * @return the Rule workPath
   */
  public final String getRuleWorkPath() {
<span class="fc" id="L1013">    return pojo.getWorkPath();</span>
  }

  /**
   * @return the idRule
   */
  public final String getIdRule() {
<span class="fc" id="L1020">    return pojo.getName();</span>
  }

  /**
   * @return the mode
   */
  public final int getMode() {
<span class="fc" id="L1027">    return pojo.getMode();</span>
  }

  /**
   * @return the idsArray
   */
  public final String[] getIdsArray() {
<span class="fc" id="L1034">    return pojo.getHostids().toArray(STRING_0_LENGTH);</span>
  }

  /**
   * @return the rpreTasksArray
   */
  public final String[][] getRpreTasksArray() {
<span class="fc" id="L1041">    return toLegacyTasks(pojo.getRPreTasks());</span>
  }

  /**
   * @return the rpostTasksArray
   */
  public final String[][] getRpostTasksArray() {
<span class="fc" id="L1048">    return toLegacyTasks(pojo.getRPostTasks());</span>
  }

  /**
   * @return the rerrorTasksArray
   */
  public final String[][] getRerrorTasksArray() {
<span class="fc" id="L1055">    return toLegacyTasks(pojo.getRErrorTasks());</span>
  }

  /**
   * @return the spreTasksArray
   */
  public final String[][] getSpreTasksArray() {
<span class="fc" id="L1062">    return toLegacyTasks(pojo.getSPreTasks());</span>
  }

  /**
   * @return the spostTasksArray
   */
  public final String[][] getSpostTasksArray() {
<span class="fc" id="L1069">    return toLegacyTasks(pojo.getSPostTasks());</span>
  }

  /**
   * @return the serrorTasksArray
   */
  public final String[][] getSerrorTasksArray() {
<span class="fc" id="L1076">    return toLegacyTasks(pojo.getSErrorTasks());</span>
  }

  private List&lt;RuleTask&gt; fromLegacyTasks(final String[][] tasks) {
<span class="fc" id="L1080">    final int size = tasks.length;</span>
<span class="fc" id="L1081">    final List&lt;RuleTask&gt; res = new ArrayList&lt;RuleTask&gt;(size);</span>
<span class="fc bfc" id="L1082" title="All 2 branches covered.">    for (final String[] task : tasks) {</span>
<span class="pc bpc" id="L1083" title="1 of 2 branches missed.">      if (task.length &gt;= 3) {</span>
<span class="fc" id="L1084">        res.add(new RuleTask(task[0], task[1], Integer.parseInt(task[2])));</span>
      }
    }
<span class="fc" id="L1087">    return res;</span>
  }

  private String[][] toLegacyTasks(final List&lt;RuleTask&gt; tasks) {
<span class="fc" id="L1091">    final int size = tasks.size();</span>
<span class="fc" id="L1092">    final String[][] res = new String[size][];</span>
<span class="fc" id="L1093">    int i = 0;</span>
<span class="fc bfc" id="L1094" title="All 2 branches covered.">    for (final RuleTask task : tasks) {</span>
<span class="fc" id="L1095">      res[i] = new String[3];</span>
<span class="fc" id="L1096">      res[i][0] = task.getType();</span>
<span class="fc" id="L1097">      res[i][1] = task.getPath();</span>
<span class="fc" id="L1098">      res[i][2] = String.valueOf(task.getDelay());</span>
<span class="fc" id="L1099">      i++;</span>
<span class="fc" id="L1100">    }</span>
<span class="fc" id="L1101">    return res;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>