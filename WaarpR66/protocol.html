<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/apt/protocol.apt at 2020-07-20

 | Rendered using Apache Maven Default Skin
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>Waarp OpenR66 &#x2013; </title>
    <link rel="stylesheet" href="./css/maven-base.css" />
    <link rel="stylesheet" href="./css/maven-theme.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
  </head>
  <body class="composite">
    <div id="banner">
<a href="http://www.waarp.fr" id="bannerLeft"><img src="images/waarp.jpg"  alt="Waarp Project"/></a>      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2020-07-20</span>
          &#xA0;| <span id="projectVersion">Version: 3.4.0</span>
      </div>
      <div class="xright"><a href="http://www.waarp.fr/" class="externalLink" title="Waarp">Waarp</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Waarp OpenR66</h5>
    <ul>
     <li class="none"><a href="index.html" title="Overview of OpenR66">Overview of OpenR66</a></li>
     <li class="none"><a href="configuration.html" title="Configuration of OpenR66 Server and Clients">Configuration of OpenR66 Server and Clients</a></li>
     <li class="none"><a href="sslconfig.html" title="Configuration of OpenR66 SSL keys">Configuration of OpenR66 SSL keys</a></li>
     <li class="none"><a href="commands.html" title="Commands for OpenR66 Server and Clients">Commands for OpenR66 Server and Clients</a></li>
     <li class="none"><strong>Protocol for OpenR66 File Transfer</strong></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="https://www.waarp.fr/" title="Waarp" class="poweredBy">
        <img class="poweredBy"  alt="Waarp" src="https://www.waarp.fr/i/logo.png"     />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
<section>
<h2><a name="OpenR66-Protocol"></a>OpenR66-Protocol</h2>
<p>We describe here the logic of the protocol.</p>
<p>A simplified picture is shown here:</p><figure><img src="images/OpenR66-Protocol.png" alt="" /><figcaption>Waarp Protocol</figcaption></figure>
<p>First we describe the different value that can be found.</p></section><section>
<h2><a name="UpdatedInfo_status"></a>UpdatedInfo status</h2>
<p>A Request (DbTaskRunner) can have several UpdatedInfo status:</p>
<ul>
<li>UNKNOWN : no particular information on it.</li>
<li>NOTUPDATED : in used by other database object when they are taken into account.</li>
<li>INTERRUPTED : a request is interrupted but can be rescheduled.</li>
<li>TOSUBMIT : a request is proposed to be submited by the Commander (or other database object are supposed to be taken into account).</li>
<li>INERROR : a request is in error and can not be submited by the Commander until its status is changed explicitely.</li>
<li>RUNNING : a request is currently running.</li>
<li>DONE : a request is over and fully done.</li></ul></section><section>
<h2><a name="Step_values"></a>Step values</h2>
<p>A Request can have several Step values:</p>
<ul>
<li>NOTASK : the request has never started.</li>
<li>PRETASK : the request is currently in Pre transfer step.</li>
<li>TRANSFERTASK : the request is currently in transfer step.</li>
<li>POSTTASK : the request is currently in Post transfer step (valid transfer only).</li>
<li>ALLDONETASK : the request is fully finished (UpdatedInfo is in DONE status too).</li>
<li>ERRORTASK : the request is currently in the Error step while an error occurs (either in PRE, TRANSFER or POST step).</li></ul>
<p>A Request has two Step values:</p>
<ul>
<li>GlobalStep : the current request step value</li>
<li>GlobalLastStep : this is the last valid request step value. When GlobalStep is in ERROR step, GlobalLastStep says in which step it was before entering in error. This information is used to enable restart of the Request from this valid last step.</li></ul></section><section>
<h2><a name="Detailed_information"></a>Detailed information</h2>
<p>Each Step values and UpdatedInfo has an ErrorCode detailed information:</p>
<ul>
<li>InitOk : stands for correct initialization of the Request (startup and authentication)</li>
<li>PreProcessingOk, TransferOk, PostProcessingOk : stand for correct ending of the specified step</li>
<li>CompleteOk : stands for all action are correct (ALLDONE for step and DONE for UpdatedInfo)</li>
<li>Running : stands for current Step is in Running status.</li>
<li>StoppedTransfer, CanceledTransfer : stand for a Request where an action stopped or canceled the given Request. A Stopped Request can be restart from the current status. A Canceled Request starts from the beginning of the current step. For instance for the Transfer step, Stopped will imply that restart is from the current valid transferred block, while Cancel will imply to restart from the very beginning of the transfer (first block).</li>
<li>QueryAlreadyFinished : stands for special code where the Request is in fact remotely already finished and so can be finished locally.</li>
<li>Other code specifies different kinds of error (NotKnownHost, Shutdown, RemoteError, ...).</li></ul></section><section>
<h2><a name="Sequential_logic"></a>Sequential logic</h2>
<p>A request of transfer follows a sequential logic:</p>
<ul>
<li>The request is registered in the database with a TOSUBMIT status.</li>
<li>A Request that was in a INTERRUPTED status is changed in a TOSUBMIT status.</li>
<li>The Commander get some requests with the TOSUBMIT status and makes them as RUNNING status.</li>
<li>The Commander submits those requests as separates ClientRunners.</li>
<li>The ClientRunner first checks that the given Request is not a &quot;Self Requested&quot; request, meaning that only requester host can execute a ClientRunner, except if this request was in the POSTTASK step so that Requested Host can finalize the request.</li>
<li>The ClientRunner gets the remote requested Host address and tries to open the connection. If a network conection with the given requested host is already opened, this network connection is reused by the new ClientRunner.</li>
<li>The connection can use SSL support (different port than non SSL). This is an option of transfer. This option is selected while selecting the Host ID for SSL support for the remote Requested Host. This option is CPU and Memory consuming.</li>
<li>Once the network connection is found, a private connection (in memory connection) is opened to enable the multiplexing of this request with other requests on the same network connection. This private connection is attached to a new LocalChannelReference which references the Request, the session, the remote and private connections. A valid LocalChannelReference contains two private connection Ids, one for the local private connection, and one for the remote private connection.
<ul>
<li>A Startup Message is sent to the local private connection to initiate it.</li>
<li>The same Startup Message is sent back to the remote private connection to initiate too the relation between them and to instantiate the same LocalChannelReference on the remote host.</li></ul></li>
<li>Once the LocalChannelReference is OK, the Requester host sends an Authent Message in order to authenticate this host.</li>
<li>The Requested host sends back its own Authent Message too. In case of Check of IP, the authentication is confirmed if both password and IP are aligned with the local definition of the remote partner.</li>
<li>Once authenticated, the Requester Host sends the Request Message.</li>
<li>The Requested Host check if the authentication and the request are compatibles, check some constraints (like CPU or connexion limits), check some specific options on the request itself (start, restart, ...) and sends back the validated request to the Requester Host.
<ul>
<li>The Request is in InitOk as detailed information.</li></ul></li>
<li>The validated Request is now running the Pre Task step.
<ul>
<li>Once finished, the Request is in PreProcessingOK status.</li></ul></li>
<li>Now the transmission can start. The sender (which could be either the Requested or the Requester host) launch its own RetrieveRunner. This RetrieveRunner sends to the other host all DataBlock Messages.</li>
<li>Each DataBlock Message can include a MD5 control of the packet in it (option of transfer). This option is not mandatory and is CPU consuming.</li>
<li>Once all DataBlock are sent, the RetrieveRunner sends an EndTransfer Message to the receiver host.</li>
<li>The receiver host executes first its PostProcessing actions.
<ul>
<li>The Request is first in TransferOk status for Receiver.</li>
<li>The Request is in PostProcesseingOk status for receiver.</li></ul></li>
<li>The receiver sends back the validated EndTransfer Message.
<ul>
<li>The Request is in TransferOk status for Sender.</li></ul></li>
<li>The Request is now on Finalize way. Sender host executes the Post actions on its turn.
<ul>
<li>The Request is in PostProcesseingOk status for Sender.</li></ul></li>
<li>Once the PostProcessing is over, the RetrieveRunner (Sender) sends to the remote host a EndRequest Message.
<ul>
<li>The remote host sends back the validated EndRequest Message.</li>
<li>The Request is now totally finished and its status is CompleteOk ALLDONE on both side.</li></ul></li></ul>
<p>At each step, an error can occurs and will stop the request, setting its UpdatedInfo to INERROR or INTERRUPTED status. The GlobalStep could be in ERROR status if the ERROR step action is run.</p></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2009&#x2013;2020<a href="http://www.waarp.fr">Waarp</a>.
.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
