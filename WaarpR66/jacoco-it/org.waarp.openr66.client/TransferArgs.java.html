<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransferArgs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp OpenR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.client</a> &gt; <span class="el_source">TransferArgs.java</span></div><h1>TransferArgs.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package org.waarp.openr66.client;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.DefaultParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Option;
import org.apache.commons.cli.OptionGroup;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoDataException;
import org.waarp.common.guid.LongUuid;
import org.waarp.common.json.JsonHandler;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.openr66.client.utils.OutputFormat;
import org.waarp.openr66.client.utils.OutputFormat.OUTPUTFORMAT;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;

import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import static org.waarp.common.database.DbConstant.*;

/**
 * Transfer arguments:&lt;br&gt;
 * &lt;br&gt;
 * -to &lt;arg&gt;        Specify the requested Host&lt;br&gt;
 * (-id &lt;arg&gt;|      Specify the id of transfer&lt;br&gt;
 * (-file &lt;arg&gt;     Specify the file path to operate on&lt;br&gt;
 * -rule &lt;arg&gt;))    Specify the Rule&lt;br&gt;
 * [-block &lt;arg&gt;]   Specify the block size&lt;br&gt;
 * [-nofollow]      Specify the transfer should not integrate a FOLLOW id&lt;br&gt;
 * [-md5]           Specify the option to have a hash computed for the
 * transfer&lt;br&gt;
 * [-delay &lt;arg&gt;]   Specify the delay time as an epoch time or '+' a delay in ms&lt;br&gt;
 * [-start &lt;arg&gt;]   Specify the start time as yyyyMMddHHmmss&lt;br&gt;
 * [-info &lt;arg&gt;)    Specify the transfer information (generally in last position)&lt;br&gt;
 * [-nolog]         Specify to not log anything included database once the
 * transfer is done&lt;br&gt;
 * [-notlogWarn |   Specify to log final result as Info if OK&lt;br&gt;
 * -logWarn]        Specify to log final result as Warn if OK&lt;br&gt;
 */
public class TransferArgs {
<span class="fc" id="L73">  private static final WaarpLogger logger =</span>
<span class="fc" id="L74">      WaarpLoggerFactory.getLogger(TransferArgs.class);</span>

  private static final String FILE = &quot;file&quot;;
  public static final String FILE_ARG = &quot;-&quot; + FILE;
<span class="fc" id="L78">  private static final Option FILE_OPTION =</span>
<span class="fc" id="L79">      Option.builder(FILE).required(false).hasArg(true)</span>
<span class="fc" id="L80">            .desc(&quot;Specify the file path to operate on&quot;).build();</span>
  private static final String TO = &quot;to&quot;;
  public static final String TO_ARG = &quot;-&quot; + TO;
<span class="fc" id="L83">  private static final Option TO_OPTION =</span>
<span class="fc" id="L84">      Option.builder(TO).required(true).hasArg(true)</span>
<span class="fc" id="L85">            .desc(&quot;Specify the requested Host&quot;).build();</span>
  private static final String RULE = &quot;rule&quot;;
  public static final String RULE_ARG = &quot;-&quot; + RULE;
<span class="fc" id="L88">  private static final Option RULE_OPTION =</span>
<span class="fc" id="L89">      Option.builder(RULE).required(false).hasArg(true).desc(&quot;Specify the Rule&quot;)</span>
<span class="fc" id="L90">            .build();</span>
  private static final String ID_FIELD = &quot;id&quot;;
  public static final String ID_ARG = &quot;-&quot; + ID_FIELD;
<span class="fc" id="L93">  private static final Option ID_OPTION =</span>
<span class="fc" id="L94">      Option.builder(ID_FIELD).required(false).hasArg(true)</span>
<span class="fc" id="L95">            .desc(&quot;Specify the id of transfer&quot;).build();</span>
  private static final String NO_FOLLOW = &quot;nofollow&quot;;
  public static final String NO_FOLLOW_ARG = &quot;-&quot; + NO_FOLLOW;
<span class="fc" id="L98">  private static final Option NO_FOLLOW_OPTION =</span>
<span class="fc" id="L99">      Option.builder(NO_FOLLOW).required(false).hasArg(false)</span>
<span class="fc" id="L100">            .desc(&quot;Specify if the transfer should not integrate a FOLLOW id&quot;)</span>
<span class="fc" id="L101">            .build();</span>
  public static final String FOLLOW_JSON_KEY = &quot;follow&quot;;
  private static final String INFO = &quot;info&quot;;
  public static final String INFO_ARG = &quot;-&quot; + INFO;
<span class="fc" id="L105">  private static final Option INFO_OPTION =</span>
<span class="fc" id="L106">      Option.builder(INFO).required(false).hasArg(true)</span>
<span class="fc" id="L107">            .desc(&quot;Specify the transfer information&quot;).build();</span>
  private static final String HASH = &quot;md5&quot;;
  public static final String HASH_ARG = &quot;-&quot; + HASH;
<span class="fc" id="L110">  private static final Option HASH_OPTION =</span>
<span class="fc" id="L111">      Option.builder(HASH).required(false).hasArg(false)</span>
<span class="fc" id="L112">            .desc(&quot;Specify the option to have a hash computed for the transfer&quot;)</span>
<span class="fc" id="L113">            .build();</span>
  private static final String BLOCK = &quot;block&quot;;
  public static final String BLOCK_ARG = &quot;-&quot; + BLOCK;
<span class="fc" id="L116">  private static final Option BLOCK_OPTION =</span>
<span class="fc" id="L117">      Option.builder(BLOCK).required(false).hasArg(true)</span>
<span class="fc" id="L118">            .desc(&quot;Specify the block size&quot;).build();</span>
  private static final String START = &quot;start&quot;;
  public static final String START_ARG = &quot;-&quot; + START;
<span class="fc" id="L121">  private static final Option START_OPTION =</span>
<span class="fc" id="L122">      Option.builder(START).required(false).hasArg(true)</span>
<span class="fc" id="L123">            .desc(&quot;Specify the start time as yyyyMMddHHmmss&quot;).build();</span>
  private static final String DELAY = &quot;delay&quot;;
  public static final String DELAY_ARG = &quot;-&quot; + DELAY;
<span class="fc" id="L126">  private static final Option DELAY_OPTION =</span>
<span class="fc" id="L127">      Option.builder(DELAY).required(false).hasArg(true).desc(</span>
          &quot;Specify the delay time as an epoch time or '+' a delay in ms&quot;)
<span class="fc" id="L129">            .build();</span>

  private static final String LOGWARN = &quot;logWarn&quot;;
  public static final String LOGWARN_ARG = &quot;-&quot; + LOGWARN;
<span class="fc" id="L133">  private static final Option LOGWARN_OPTION =</span>
<span class="fc" id="L134">      Option.builder(LOGWARN).required(false).hasArg(false)</span>
<span class="fc" id="L135">            .desc(&quot;Specify to log final result as Warn if OK&quot;).build();</span>
  private static final String NOTLOGWARN = &quot;notlogWarn&quot;;
  public static final String NOTLOGWARN_ARG = &quot;-&quot; + NOTLOGWARN;
<span class="fc" id="L138">  private static final Option NOTLOGWARN_OPTION =</span>
<span class="fc" id="L139">      Option.builder(NOTLOGWARN).required(false).hasArg(false)</span>
<span class="fc" id="L140">            .desc(&quot;Specify to log final result as Info if OK&quot;).build();</span>

  private static final String NOTLOG = &quot;nolog&quot;;
  public static final String NOTLOG_ARG = &quot;-&quot; + NOTLOG;
<span class="fc" id="L144">  private static final Option NOTLOG_OPTION =</span>
<span class="fc" id="L145">      Option.builder(NOTLOG).required(false).hasArg(false).desc(</span>
          &quot;Specify to not log anything included database once the &quot; +
<span class="fc" id="L147">          &quot;transfer is done&quot;).build();</span>

<span class="fc" id="L149">  private static final OptionGroup LOGWARN_OPTIONS =</span>
<span class="fc" id="L150">      new OptionGroup().addOption(LOGWARN_OPTION).addOption(NOTLOGWARN_OPTION);</span>
<span class="fc" id="L151">  private static final OptionGroup DELAY_OPTIONS =</span>
<span class="fc" id="L152">      new OptionGroup().addOption(DELAY_OPTION).addOption(START_OPTION);</span>

  private static final String QUIET = &quot;quiet&quot;;
  private static final String CSV = &quot;csv&quot;;
  private static final String XML = &quot;xml&quot;;
  private static final String JSON = &quot;json&quot;;
  private static final String PROPERTY = &quot;property&quot;;
  public static final String QUIET_ARG = &quot;-&quot; + QUIET;
  public static final String CSV_ARG = &quot;-&quot; + CSV;
  public static final String XML_ARG = &quot;-&quot; + XML;
  public static final String JSON_ARG = &quot;-&quot; + JSON;
  public static final String PROPERTY_ARG = &quot;-&quot; + PROPERTY;
<span class="fc" id="L164">  private static final Option QUIET_OPTION =</span>
<span class="fc" id="L165">      Option.builder(QUIET).required(false).hasArg(false).desc(</span>
          &quot;meaning no output at all (logs are not changed, exit value still &quot; +
<span class="fc" id="L167">          &quot;uses 0 as Success, 1 as Warning and others as Failure)&quot;).build();</span>
<span class="fc" id="L168">  private static final Option CSV_OPTION =</span>
<span class="fc" id="L169">      Option.builder(CSV).required(false).hasArg(false).desc(</span>
          &quot;meaning output will be in CSV format (2 lines, 1 with title, 1 &quot; +
<span class="fc" id="L171">          &quot;with content, separator is ';')&quot;).build();</span>
<span class="fc" id="L172">  private static final Option XML_OPTION =</span>
<span class="fc" id="L173">      Option.builder(XML).required(false).hasArg(false)</span>
<span class="fc" id="L174">            .desc(&quot;meaning output will be in XML&quot;).build();</span>
<span class="fc" id="L175">  private static final Option JSON_OPTION =</span>
<span class="fc" id="L176">      Option.builder(JSON).required(false).hasArg(false)</span>
<span class="fc" id="L177">            .desc(&quot;meaning output will be in JSON&quot;).build();</span>
<span class="fc" id="L178">  private static final Option PROPERTY_OPTION =</span>
<span class="fc" id="L179">      Option.builder(PROPERTY).required(false).hasArg(false)</span>
<span class="fc" id="L180">            .desc(&quot;meaning output will be in Property format (name=value)&quot;)</span>
<span class="fc" id="L181">            .build();</span>
<span class="fc" id="L182">  private static final OptionGroup OUTPUT_OPTIONS =</span>
<span class="fc" id="L183">      new OptionGroup().addOption(QUIET_OPTION).addOption(CSV_OPTION)</span>
<span class="fc" id="L184">                       .addOption(XML_OPTION).addOption(JSON_OPTION)</span>
<span class="fc" id="L185">                       .addOption(PROPERTY_OPTION);</span>

<span class="fc" id="L187">  private static final Options TRANSFER_OPTIONS =</span>
<span class="fc" id="L188">      new Options().addOption(FILE_OPTION).addOption(TO_OPTION)</span>
<span class="fc" id="L189">                   .addOption(NO_FOLLOW_OPTION).addOption(RULE_OPTION)</span>
<span class="fc" id="L190">                   .addOption(ID_OPTION).addOption(INFO_OPTION)</span>
<span class="fc" id="L191">                   .addOption(HASH_OPTION).addOption(BLOCK_OPTION)</span>
<span class="fc" id="L192">                   .addOptionGroup(DELAY_OPTIONS).addOption(NOTLOG_OPTION)</span>
<span class="fc" id="L193">                   .addOptionGroup(LOGWARN_OPTIONS)</span>
<span class="fc" id="L194">                   .addOptionGroup(OUTPUT_OPTIONS);</span>

  public static final String SEPARATOR_SEND = &quot;--&quot;;


  /**
   * Print to standard output the help of this command
   */
  public static void printHelp() {
<span class="nc" id="L203">    final HelpFormatter formatter = new HelpFormatter();</span>
<span class="nc" id="L204">    formatter.printHelp(&quot;Transfer&quot;, TRANSFER_OPTIONS);</span>
<span class="nc" id="L205">  }</span>

  /**
   * Analyze the parameters according to TransferArgs options
   * &lt;br&gt;&lt;br&gt;
   * Transfer arguments:&lt;br&gt;
   * &lt;br&gt;
   * -to &lt;arg&gt;        Specify the requested Host&lt;br&gt;
   * (-id &lt;arg&gt;|      Specify the id of transfer&lt;br&gt;
   * (-file &lt;arg&gt;     Specify the file path to operate on&lt;br&gt;
   * -rule &lt;arg&gt;))    Specify the Rule&lt;br&gt;
   * [-block &lt;arg&gt;]   Specify the block size&lt;br&gt;
   * [-nofollow]      Specify the transfer should not integrate a FOLLOW id&lt;br&gt;
   * [-md5]           Specify the option to have a hash computed for the
   * transfer&lt;br&gt;
   * [-delay &lt;arg&gt;]   Specify the delay time as an epoch time or '+' a delay in ms&lt;br&gt;
   * [-start &lt;arg&gt;]   Specify the start time as yyyyMMddHHmmss&lt;br&gt;
   * [-info &lt;arg&gt;)    Specify the transfer information (generally in last position)&lt;br&gt;
   * [-nolog]         Specify to not log anything included database once the
   * transfer is done&lt;br&gt;
   * [-notlogWarn |   Specify to log final result as Info if OK&lt;br&gt;
   * -logWarn]        Specify to log final result as Warn if OK&lt;br&gt;
   *
   * @param rank the rank to analyze from
   * @param args the argument to analyze
   * @param analyseFollow if True, will check follow possible argument in info
   *
   * @return the TransferArgs or null if an error occurs
   */
  public static TransferArgs getParamsInternal(final int rank,
                                               final String[] args,
                                               final boolean analyseFollow) {
<span class="pc bpc" id="L237" title="2 of 4 branches missed.">    if (args == null || args.length == 0) {</span>
<span class="nc" id="L238">      logger.error(&quot;Arguments cannot be empty or null&quot;);</span>
<span class="nc" id="L239">      return null;</span>
    }
<span class="fc" id="L241">    final String[] realArgs = getRealArgs(rank, args);</span>

    // Now set default values from configuration
<span class="fc" id="L244">    final TransferArgs transferArgs1 = new TransferArgs();</span>
<span class="fc" id="L245">    transferArgs1.setBlockSize(Configuration.configuration.getBlockSize());</span>

<span class="fc" id="L247">    final CommandLineParser parser = new DefaultParser();</span>
    try {
<span class="fc" id="L249">      final CommandLine cmd = parser.parse(TRANSFER_OPTIONS, realArgs, true);</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">      if (getTransferMinimalArgs(transferArgs1, cmd)) {</span>
<span class="nc" id="L251">        return null;</span>
      }
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">      if (checkDelayStart(transferArgs1, cmd)) {</span>
<span class="nc" id="L254">        return null;</span>
      }
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">      if (checkExtraTransferArgs(transferArgs1, cmd)) {</span>
<span class="nc" id="L257">        return null;</span>
      }
<span class="fc" id="L259">      checkLog(transferArgs1, cmd);</span>
<span class="fc" id="L260">      checkOutput(cmd);</span>
<span class="nc" id="L261">    } catch (final ParseException e) {</span>
<span class="nc" id="L262">      printHelp();</span>
<span class="nc" id="L263">      logger.error(&quot;Arguments are incorrect&quot;, e);</span>
<span class="nc" id="L264">      return null;</span>
<span class="fc" id="L265">    }</span>
<span class="fc" id="L266">    return finalizeTransferArgs(analyseFollow, transferArgs1);</span>
  }

  /**
   * Check extra arguments for Transfer
   *
   * @param transferArgs1
   * @param cmd
   *
   * @return the TransferArgs or null
   */
  private static boolean checkExtraTransferArgs(
      final TransferArgs transferArgs1, final CommandLine cmd) {
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">    if (!cmd.hasOption(NO_FOLLOW)) {</span>
<span class="fc" id="L280">      transferArgs1.setFollowId(&quot;&quot;);</span>
    }
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">    if (cmd.hasOption(INFO)) {</span>
<span class="nc" id="L283">      transferArgs1.setTransferInfo(cmd.getOptionValue(INFO));</span>
    }
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">    if (cmd.hasOption(HASH)) {</span>
<span class="nc" id="L286">      transferArgs1.setMD5(true);</span>
    }
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">    if (cmd.hasOption(BLOCK)) {</span>
      try {
<span class="nc" id="L290">        transferArgs1.setBlockSize(Integer.parseInt(cmd.getOptionValue(BLOCK)));</span>
<span class="nc" id="L291">      } catch (final NumberFormatException ignored) {</span>
<span class="nc" id="L292">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="nc" id="L293">        logger.error(Messages.getString(&quot;AbstractTransfer.20&quot;) + &quot; block&quot;);</span>
        //$NON-NLS-1$
<span class="nc" id="L295">        return true;</span>
<span class="nc" id="L296">      }</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">      if (transferArgs1.getBlockSize() &lt; 100) {</span>
<span class="nc" id="L298">        logger.error(Messages.getString(&quot;AbstractTransfer.1&quot;) +</span>
<span class="nc" id="L299">                     transferArgs1.getBlockSize());</span>
        //$NON-NLS-1$
<span class="nc" id="L301">        return true;</span>
      }
    }
<span class="fc" id="L304">    return false;</span>
  }

  /**
   * Check minimal argyments for Transfer
   *
   * @param transferArgs1
   * @param cmd
   *
   * @return True if an error occurs
   */
  private static boolean getTransferMinimalArgs(
      final TransferArgs transferArgs1, final CommandLine cmd) {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">    if (cmd.hasOption(TO)) {</span>
<span class="fc" id="L318">      transferArgs1.setRemoteHost(cmd.getOptionValue(TO));</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">      if (Configuration.configuration.getAliases().containsKey(</span>
<span class="fc" id="L320">          transferArgs1.getRemoteHost())) {</span>
<span class="nc" id="L321">        transferArgs1.setRemoteHost(Configuration.configuration.getAliases()</span>
<span class="nc" id="L322">                                                               .get(</span>
                                                                   transferArgs1
<span class="nc" id="L324">                                                                       .getRemoteHost()));</span>
      }
    }
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">    if (cmd.hasOption(FILE)) {</span>
<span class="fc" id="L328">      transferArgs1.setFilename(cmd.getOptionValue(FILE));</span>
<span class="fc" id="L329">      transferArgs1.setFilename(transferArgs1.getFilename().replace('ยง', '*'));</span>
    }
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">    if (cmd.hasOption(RULE)) {</span>
<span class="fc" id="L332">      transferArgs1.setRulename(cmd.getOptionValue(RULE));</span>
    }
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">    if (cmd.hasOption(ID_FIELD)) {</span>
      try {
<span class="nc" id="L336">        transferArgs1.setId(Long.parseLong(cmd.getOptionValue(ID_FIELD)));</span>
<span class="nc" id="L337">      } catch (final NumberFormatException ignored) {</span>
<span class="nc" id="L338">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="nc" id="L339">        logger.error(Messages.getString(&quot;AbstractTransfer.20&quot;) + &quot; id&quot;);</span>
        //$NON-NLS-1$
<span class="nc" id="L341">        return true;</span>
<span class="nc" id="L342">      }</span>
    }
<span class="fc" id="L344">    return false;</span>
  }

  /**
   * Finalize the real arguments to parse (stopping at &quot;--&quot; and starting at
   * rank)
   *
   * @param rank
   * @param args
   *
   * @return the real arguments
   */
  private static String[] getRealArgs(final int rank, final String[] args) {
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">    String[] realArgs =</span>
<span class="pc" id="L358">        rank == 0? args : Arrays.copyOfRange(args, rank, args.length);</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">    for (int i = rank; i &lt; args.length; i++) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">      if (SEPARATOR_SEND.equals(args[i])) {</span>
<span class="nc" id="L361">        realArgs = Arrays.copyOfRange(args, rank, i);</span>
<span class="nc" id="L362">        break;</span>
      }
    }
<span class="fc" id="L365">    return realArgs;</span>
  }

  /**
   * Finalize the TransferArgs
   *
   * @param analyseFollow
   * @param transferArgs1
   *
   * @return the TransferArgs or null
   */
  private static TransferArgs finalizeTransferArgs(final boolean analyseFollow,
                                                   final TransferArgs transferArgs1) {
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">    if (transferArgs1.getTransferInfo() == null) {</span>
<span class="fc" id="L379">      transferArgs1.setTransferInfo(AbstractTransfer.NO_INFO_ARGS);</span>
    }
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">    if (analyseFollow) {</span>
<span class="nc" id="L382">      analyzeFollow(transferArgs1);</span>
    }
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">    if (transferArgs1.getRemoteHost() != null &amp;&amp;</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">        transferArgs1.getRulename() != null &amp;&amp;</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        transferArgs1.getFilename() != null) {</span>
<span class="fc" id="L387">      return transferArgs1;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">    } else if (transferArgs1.getId() != ILLEGALVALUE &amp;&amp;</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">               transferArgs1.getRemoteHost() != null) {</span>
      try {
<span class="nc" id="L391">        final DbTaskRunner runner = new DbTaskRunner(transferArgs1.getId(),</span>
                                                     transferArgs1
<span class="nc" id="L393">                                                         .getRemoteHost());</span>
<span class="nc" id="L394">        transferArgs1.setRulename(runner.getRuleId());</span>
<span class="nc" id="L395">        transferArgs1.setFilename(runner.getOriginalFilename());</span>
<span class="nc" id="L396">        return transferArgs1;</span>
<span class="nc" id="L397">      } catch (final WaarpDatabaseNoDataException e) {</span>
<span class="nc" id="L398">        logger.error(&quot;No transfer found with this id and partner&quot;);</span>
<span class="nc" id="L399">        logger.error(Messages.getString(&quot;AbstractBusinessRequest.NeedMoreArgs&quot;,</span>
                                        &quot;(-to -rule -file | -to -id with &quot; +
                                        &quot;existing id transfer)&quot;)
                     //$NON-NLS-1$
            , e);
<span class="nc" id="L404">        return null;</span>
<span class="nc" id="L405">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L406">        logger.error(Messages.getString(&quot;AbstractBusinessRequest.NeedMoreArgs&quot;,</span>
                                        &quot;(-to -rule -file | -to -id) with a &quot; +
                                        &quot;correct database connexion&quot;)
                     //$NON-NLS-1$
            , e);
<span class="nc" id="L411">        return null;</span>
      }
    }
<span class="nc" id="L414">    logger.error(Messages.getString(&quot;AbstractBusinessRequest.NeedMoreArgs&quot;,</span>
                                    &quot;(-to -rule -file | -to -id)&quot;) +
                 //$NON-NLS-1$
                 AbstractTransfer.INFO_ARGS);
<span class="nc" id="L418">    return null;</span>
  }

  /**
   * Check LOG and NOT LOG options
   *
   * @param transferArgs1
   * @param cmd
   */
  private static void checkLog(final TransferArgs transferArgs1,
                               final CommandLine cmd) {
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">    if (cmd.hasOption(LOGWARN)) {</span>
<span class="nc" id="L430">      transferArgs1.setNormalInfoAsWarn(true);</span>
    }
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">    if (cmd.hasOption(NOTLOGWARN)) {</span>
<span class="nc" id="L433">      transferArgs1.setNormalInfoAsWarn(false);</span>
    }
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">    if (cmd.hasOption(NOTLOG)) {</span>
<span class="nc" id="L436">      transferArgs1.setNolog(true);</span>
    }
<span class="fc" id="L438">  }</span>

  /**
   * Check if any output format specification is set
   *
   * @param cmd
   */
  private static void checkOutput(final CommandLine cmd) {
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">    if (cmd.hasOption(QUIET)) {</span>
<span class="nc" id="L447">      OutputFormat.setDefaultOutput(OUTPUTFORMAT.QUIET);</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">    } else if (cmd.hasOption(CSV)) {</span>
<span class="nc" id="L449">      OutputFormat.setDefaultOutput(OUTPUTFORMAT.CSV);</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">    } else if (cmd.hasOption(XML)) {</span>
<span class="nc" id="L451">      OutputFormat.setDefaultOutput(OUTPUTFORMAT.XML);</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">    } else if (cmd.hasOption(JSON)) {</span>
<span class="nc" id="L453">      OutputFormat.setDefaultOutput(OUTPUTFORMAT.JSON);</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">    } else if (cmd.hasOption(PROPERTY)) {</span>
<span class="nc" id="L455">      OutputFormat.setDefaultOutput(OUTPUTFORMAT.PROPERTY);</span>
    }
<span class="fc" id="L457">  }</span>

  /**
   * Check DELAY or START
   *
   * @param transferArgs1
   * @param cmd
   *
   * @return True if an error occurs
   */
  private static boolean checkDelayStart(final TransferArgs transferArgs1,
                                         final CommandLine cmd) {
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">    if (cmd.hasOption(START)) {</span>
      final Date date;
<span class="nc" id="L471">      final SimpleDateFormat dateFormat =</span>
          new SimpleDateFormat(AbstractTransfer.TIMESTAMP_FORMAT);
      try {
<span class="nc" id="L474">        date = dateFormat.parse(cmd.getOptionValue(START));</span>
<span class="nc" id="L475">        transferArgs1.setStartTime(new Timestamp(date.getTime()));</span>
<span class="nc" id="L476">      } catch (final java.text.ParseException ignored) {</span>
<span class="nc" id="L477">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="nc" id="L478">        logger.error(Messages.getString(&quot;AbstractTransfer.20&quot;) + &quot; StartTime&quot;);</span>
        //$NON-NLS-1$
<span class="nc" id="L480">        return true;</span>
<span class="nc" id="L481">      }</span>
    }
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">    if (cmd.hasOption(DELAY)) {</span>
<span class="nc" id="L484">      final String delay = cmd.getOptionValue(DELAY);</span>
      try {
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (delay.charAt(0) == '+') {</span>
<span class="nc" id="L487">          transferArgs1.setStartTime(new Timestamp(</span>
<span class="nc" id="L488">              System.currentTimeMillis() + Long.parseLong(delay.substring(1))));</span>
        } else {
<span class="nc" id="L490">          transferArgs1.setStartTime(new Timestamp(Long.parseLong(delay)));</span>
        }
<span class="nc" id="L492">      } catch (final NumberFormatException ignored) {</span>
<span class="nc" id="L493">        SysErrLogger.FAKE_LOGGER.ignoreLog(ignored);</span>
<span class="nc" id="L494">        logger.error(Messages.getString(&quot;AbstractTransfer.20&quot;) + &quot; Delay&quot;);</span>
        //$NON-NLS-1$
<span class="nc" id="L496">        return true;</span>
<span class="nc" id="L497">      }</span>
    }
<span class="fc" id="L499">    return false;</span>
  }

  /**
   * Get all Info in case of last argument
   *
   * @param transferArgs the original TransferArgs
   * @param rank the rank to start from in args array
   * @param args the original arguments
   * @param copiedInfo might be null, original information to copy
   */
  public static void getAllInfo(final TransferArgs transferArgs, final int rank,
                                final String[] args, final String copiedInfo) {
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">    if (transferArgs != null) {</span>
<span class="fc" id="L513">      final StringBuilder builder = new StringBuilder();</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">      if (copiedInfo != null) {</span>
<span class="fc" id="L515">        builder.append(copiedInfo);</span>
      }
<span class="fc bfc" id="L517" title="All 2 branches covered.">      for (int i = rank; i &lt; args.length; i++) {</span>
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">        if (INFO_ARG.equalsIgnoreCase(args[i])) {</span>
<span class="nc" id="L519">          i++;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">          if (builder.length() == 0) {</span>
<span class="nc" id="L521">            builder.append(args[i].trim());</span>
          } else {
<span class="nc" id="L523">            builder.append(' ').append(args[i].trim());</span>
          }
<span class="nc" id="L525">          i++;</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">          while (i &lt; args.length) {</span>
<span class="nc" id="L527">            builder.append(' ').append(args[i].trim());</span>
<span class="nc" id="L528">            i++;</span>
          }
        }
      }
<span class="fc" id="L532">      transferArgs.setTransferInfo(builder.toString());</span>
<span class="fc" id="L533">      TransferArgs.analyzeFollow(transferArgs);</span>
    }
<span class="fc" id="L535">  }</span>

  /**
   * Mainly Junit, but also special command where Follow Id might be lost or
   * not set
   *
   * @param abstractTransfer
   */
  public static void forceAnalyzeFollow(
      final AbstractTransfer abstractTransfer) {
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">    if (abstractTransfer.transferArgs.getFollowId() == null) {</span>
<span class="fc" id="L546">      abstractTransfer.transferArgs.setFollowId(&quot;&quot;);</span>
<span class="fc" id="L547">      analyzeFollow(abstractTransfer.transferArgs);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">    } else if (!abstractTransfer.transferArgs.getFollowId().isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">               abstractTransfer.transferArgs.getTransferInfo() != null) {</span>
<span class="nc" id="L550">      if (!abstractTransfer.transferArgs.getTransferInfo()</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                                        .contains(FOLLOW_JSON_KEY)) {</span>
        // Add FOLLOW ID to transferArgs
<span class="nc" id="L553">        final Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L554">        map.put(FOLLOW_JSON_KEY, abstractTransfer.transferArgs.getFollowId());</span>
<span class="nc" id="L555">        abstractTransfer.transferArgs.setTransferInfo(</span>
<span class="nc" id="L556">            abstractTransfer.transferArgs.getTransferInfo() + &quot; &quot; +</span>
<span class="nc" id="L557">            JsonHandler.writeAsStringEscaped(map));</span>
      }
    }
<span class="fc" id="L560">  }</span>

  /**
   * Analyze Follow option: fill it if Follow is &quot;&quot; (do not if null).
   * It corrects argument of information if needed.
   *
   * @param transferArgs1 the current TransferArgs
   */
  public static void analyzeFollow(final TransferArgs transferArgs1) {
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">    if (transferArgs1.getFollowId() != null &amp;&amp;</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">        transferArgs1.getTransferInfo() != null) {</span>
<span class="fc" id="L571">      final Map&lt;String, Object&gt; map =</span>
<span class="fc" id="L572">          DbTaskRunner.getMapFromString(transferArgs1.getTransferInfo());</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">      if (map.containsKey(FOLLOW_JSON_KEY)) {</span>
<span class="fc" id="L574">        transferArgs1.setFollowId(map.get(FOLLOW_JSON_KEY).toString());</span>
      }
<span class="fc bfc" id="L576" title="All 2 branches covered.">      if (transferArgs1.getFollowId().isEmpty()) {</span>
<span class="fc" id="L577">        final LongUuid longUuid = new LongUuid();</span>
<span class="fc" id="L578">        map.put(FOLLOW_JSON_KEY, longUuid.getLong());</span>
<span class="fc" id="L579">        transferArgs1.setTransferInfo(transferArgs1.getTransferInfo() + &quot; &quot; +</span>
<span class="fc" id="L580">                                      JsonHandler.writeAsStringEscaped(map));</span>
<span class="fc" id="L581">        transferArgs1.setFollowId(&quot;&quot; + longUuid.getLong());</span>
<span class="fc" id="L582">      } else {</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">        if (map.size() &gt; 1) {</span>
<span class="nc" id="L584">          transferArgs1.setTransferInfo(transferArgs1.getTransferInfo() + &quot; &quot; +</span>
<span class="nc" id="L585">                                        JsonHandler.writeAsStringEscaped(map));</span>
        }
      }
    }
<span class="fc" id="L589">  }</span>

  private String filename;
  private String rulename;
  private String transferInfo;
  private boolean isMD5;
  private String remoteHost;
<span class="fc" id="L596">  private int blocksize = 0x10000; // 64K</span>
<span class="fc" id="L597">  private long id = ILLEGALVALUE;</span>
  private Timestamp startTime;
  private String followId;
<span class="fc" id="L600">  private boolean normalInfoAsWarn = true;</span>
<span class="fc" id="L601">  private boolean nolog = false;</span>

  /**
   * Empty constructor
   */
<span class="fc" id="L606">  public TransferArgs() {</span>
    // Empty
<span class="fc" id="L608">  }</span>

  public String getFilename() {
<span class="fc" id="L611">    return filename;</span>
  }

  public TransferArgs setFilename(final String filename) {
<span class="fc" id="L615">    this.filename = filename;</span>
<span class="fc" id="L616">    return this;</span>
  }

  public String getRulename() {
<span class="fc" id="L620">    return rulename;</span>
  }

  public TransferArgs setRulename(final String rulename) {
<span class="fc" id="L624">    this.rulename = rulename;</span>
<span class="fc" id="L625">    return this;</span>
  }

  public String getTransferInfo() {
<span class="fc" id="L629">    return transferInfo;</span>
  }

  public TransferArgs setTransferInfo(final String transferInfo) {
<span class="fc" id="L633">    this.transferInfo = transferInfo;</span>
<span class="fc" id="L634">    return this;</span>
  }

  public boolean isMD5() {
<span class="fc" id="L638">    return isMD5;</span>
  }

  public TransferArgs setMD5(final boolean md5) {
<span class="fc" id="L642">    isMD5 = md5;</span>
<span class="fc" id="L643">    return this;</span>
  }

  public String getRemoteHost() {
<span class="fc" id="L647">    return remoteHost;</span>
  }

  public TransferArgs setRemoteHost(final String remoteHost) {
<span class="fc" id="L651">    this.remoteHost = remoteHost;</span>
<span class="fc" id="L652">    return this;</span>
  }

  public int getBlockSize() {
<span class="fc" id="L656">    return blocksize;</span>
  }

  public TransferArgs setBlockSize(final int blocksize) {
<span class="fc" id="L660">    this.blocksize = blocksize;</span>
<span class="fc" id="L661">    return this;</span>
  }

  public long getId() {
<span class="fc" id="L665">    return id;</span>
  }

  public TransferArgs setId(final long id) {
<span class="fc" id="L669">    this.id = id;</span>
<span class="fc" id="L670">    return this;</span>
  }

  public Timestamp getStartTime() {
<span class="fc" id="L674">    return startTime;</span>
  }

  public TransferArgs setStartTime(final Timestamp startTime) {
<span class="fc" id="L678">    this.startTime = startTime;</span>
<span class="fc" id="L679">    return this;</span>
  }

  public String getFollowId() {
<span class="fc" id="L683">    return followId;</span>
  }

  public TransferArgs setFollowId(final String followId) {
<span class="fc" id="L687">    this.followId = followId;</span>
<span class="fc" id="L688">    return this;</span>
  }

  public boolean isNormalInfoAsWarn() {
<span class="nc" id="L692">    return normalInfoAsWarn;</span>
  }

  public TransferArgs setNormalInfoAsWarn(final boolean normalInfoAsWarn) {
<span class="nc" id="L696">    this.normalInfoAsWarn = normalInfoAsWarn;</span>
<span class="nc" id="L697">    return this;</span>
  }

  public boolean isNolog() {
<span class="nc" id="L701">    return nolog;</span>
  }

  public TransferArgs setNolog(final boolean nolog) {
<span class="nc" id="L705">    this.nolog = nolog;</span>
<span class="nc" id="L706">    return this;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>