<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ZipUtility.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Exec</a> &gt; <a href="../index.html" class="el_bundle">WaarpCommon</a> &gt; <a href="index.source.html" class="el_package">org.waarp.common.tar</a> &gt; <span class="el_source">ZipUtility.java</span></div><h1>ZipUtility.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.common.tar;

import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
import org.apache.commons.compress.archivers.zip.ZipArchiveInputStream;
import org.apache.commons.compress.archivers.zip.ZipArchiveOutputStream;
import org.apache.commons.compress.utils.IOUtils;
import org.waarp.common.file.FileUtils;
import org.waarp.common.logging.SysErrLogger;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.List;

/**
 *
 */
public final class ZipUtility {

<span class="fc" id="L44">  private static final File[] FILE_0_LENGTH = {};</span>

  private ZipUtility() {
  }

  /**
   * Create a new Zip from a root directory
   *
   * @param directory the base directory
   * @param filename the output filename
   * @param absolute store absolute filepath (from directory) or only
   *     filename
   *
   * @return True if OK
   */
  public static boolean createZipFromDirectory(final String directory,
                                               final String filename,
                                               final boolean absolute) {
<span class="fc" id="L62">    final File rootDir = new File(directory);</span>
<span class="fc" id="L63">    final File saveFile = new File(filename);</span>
    // recursive call
    final ZipArchiveOutputStream zaos;
    try {
<span class="fc" id="L67">      zaos = new ZipArchiveOutputStream(new FileOutputStream(saveFile));</span>
<span class="nc" id="L68">    } catch (final FileNotFoundException e) {</span>
<span class="nc" id="L69">      return false;</span>
<span class="fc" id="L70">    }</span>
    try {
<span class="fc" id="L72">      recurseFiles(rootDir, rootDir, zaos, absolute);</span>
<span class="nc" id="L73">    } catch (final IOException e2) {</span>
<span class="nc" id="L74">      FileUtils.close(zaos);</span>
<span class="nc" id="L75">      return false;</span>
<span class="fc" id="L76">    }</span>
    try {
<span class="fc" id="L78">      zaos.finish();</span>
<span class="nc" id="L79">    } catch (final IOException e1) {</span>
      // ignore
<span class="fc" id="L81">    }</span>
<span class="fc" id="L82">    FileUtils.close(zaos);</span>
<span class="fc" id="L83">    return true;</span>
  }

  /**
   * Recursive traversal to add files
   *
   * @param root
   * @param file
   * @param zaos
   * @param absolute
   *
   * @throws IOException
   */
  private static void recurseFiles(final File root, final File file,
                                   final ZipArchiveOutputStream zaos,
                                   final boolean absolute) throws IOException {
<span class="fc bfc" id="L99" title="All 2 branches covered.">    if (file.isDirectory()) {</span>
      // recursive call
<span class="fc" id="L101">      final File[] files = file.listFiles();</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">      for (final File file2 : files) {</span>
<span class="fc" id="L103">        recurseFiles(root, file2, zaos, absolute);</span>
      }
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">    } else if (!file.getName().endsWith(&quot;.zip&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">               !file.getName().endsWith(&quot;.ZIP&quot;)) {</span>
      final String filename;
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">      if (absolute) {</span>
<span class="nc" id="L109">        filename =</span>
<span class="nc" id="L110">            file.getAbsolutePath().substring(root.getAbsolutePath().length());</span>
      } else {
<span class="fc" id="L112">        filename = file.getName();</span>
      }
<span class="fc" id="L114">      final ZipArchiveEntry zae = new ZipArchiveEntry(filename);</span>
<span class="fc" id="L115">      zae.setSize(file.length());</span>
<span class="fc" id="L116">      zaos.putArchiveEntry(zae);</span>
<span class="fc" id="L117">      final FileInputStream fis = new FileInputStream(file);</span>
<span class="fc" id="L118">      IOUtils.copy(fis, zaos);</span>
<span class="fc" id="L119">      zaos.closeArchiveEntry();</span>
    }
<span class="fc" id="L121">  }</span>

  /**
   * Create a new Zip from a list of Files (only name of files will be used)
   *
   * @param files list of files to add
   * @param filename the output filename
   *
   * @return True if OK
   */
  public static boolean createZipFromFiles(final List&lt;File&gt; files,
                                           final String filename) {
<span class="fc" id="L133">    return createZipFromFiles(files.toArray(FILE_0_LENGTH), filename);</span>
  }

  /**
   * Create a new Zip from an array of Files (only name of files will be used)
   *
   * @param files array of files to add
   * @param filename the output filename
   *
   * @return True if OK
   */
  public static boolean createZipFromFiles(final File[] files,
                                           final String filename) {
<span class="fc" id="L146">    final File saveFile = new File(filename);</span>
    final ZipArchiveOutputStream zaos;
    try {
<span class="fc" id="L149">      zaos = new ZipArchiveOutputStream(new FileOutputStream(saveFile));</span>
<span class="nc" id="L150">    } catch (final FileNotFoundException e) {</span>
<span class="nc" id="L151">      return false;</span>
<span class="fc" id="L152">    }</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">    for (final File file : files) {</span>
      try {
<span class="fc" id="L155">        addFile(file, zaos);</span>
<span class="nc" id="L156">      } catch (final IOException e) {</span>
<span class="nc" id="L157">        FileUtils.close(zaos);</span>
<span class="nc" id="L158">        return false;</span>
<span class="fc" id="L159">      }</span>
    }
    try {
<span class="fc" id="L162">      zaos.finish();</span>
<span class="nc" id="L163">    } catch (final IOException e1) {</span>
      // ignore
<span class="fc" id="L165">    }</span>
<span class="fc" id="L166">    FileUtils.close(zaos);</span>
<span class="fc" id="L167">    return true;</span>
  }

  /**
   * Recursive traversal to add files
   *
   * @param file
   * @param zaos
   *
   * @throws IOException
   */
  private static void addFile(final File file,
                              final ZipArchiveOutputStream zaos)
      throws IOException {
    final String filename;
<span class="fc" id="L182">    filename = file.getName();</span>
<span class="fc" id="L183">    final ZipArchiveEntry zae = new ZipArchiveEntry(filename);</span>
<span class="fc" id="L184">    zae.setSize(file.length());</span>
<span class="fc" id="L185">    zaos.putArchiveEntry(zae);</span>
<span class="fc" id="L186">    final FileInputStream fis = new FileInputStream(file);</span>
<span class="fc" id="L187">    IOUtils.copy(fis, zaos);</span>
<span class="fc" id="L188">    zaos.closeArchiveEntry();</span>
<span class="fc" id="L189">  }</span>

  /**
   * Extract all files from Tar into the specified directory
   *
   * @param tarFile
   * @param directory
   *
   * @return the list of extracted filenames
   *
   * @throws IOException
   */
  public static List&lt;String&gt; unZip(final File tarFile, final File directory)
      throws IOException {
<span class="fc" id="L203">    final List&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L204">    final InputStream inputStream = new FileInputStream(tarFile);</span>
<span class="fc" id="L205">    final ZipArchiveInputStream in = new ZipArchiveInputStream(inputStream);</span>
    try {
<span class="fc" id="L207">      ZipArchiveEntry entry = in.getNextZipEntry();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">      while (entry != null) {</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (entry.isDirectory()) {</span>
<span class="nc" id="L210">          entry = in.getNextZipEntry();</span>
<span class="nc" id="L211">          continue;</span>
        }
<span class="fc" id="L213">        final File curfile = new File(directory, entry.getName());</span>
<span class="fc" id="L214">        final File parent = curfile.getParentFile();</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (!parent.exists()) {</span>
<span class="nc" id="L216">          parent.mkdirs();//NOSONAR</span>
        }
<span class="fc" id="L218">        final OutputStream out = new FileOutputStream(curfile);</span>
        try {
<span class="fc" id="L220">          IOUtils.copy(in, out);</span>
        } finally {
<span class="fc" id="L222">          FileUtils.close(out);</span>
        }
<span class="fc" id="L224">        result.add(entry.getName());</span>
<span class="fc" id="L225">        entry = in.getNextZipEntry();</span>
<span class="fc" id="L226">      }</span>
    } finally {
<span class="fc" id="L228">      FileUtils.close(in);</span>
    }
<span class="fc" id="L230">    return result;</span>
  }

  public static void main(final String[] args) {
<span class="nc bnc" id="L234" title="All 2 branches missed.">    if (args.length &lt; 3) {</span>
<span class="nc" id="L235">      SysErrLogger.FAKE_LOGGER.syserr(&quot;You need to provide 3 arguments:\n&quot; +</span>
                                      &quot;   option filedest.tar \&quot;source\&quot;\n&quot; +
                                      &quot;   where option=1 means unzip and source is a directory\n&quot; +
                                      &quot;   option=2 means zip and source is a directory\n&quot; +
                                      &quot;   option=3 means zip and source is a list of files comma separated&quot;);
<span class="nc" id="L240">      System.exit(1);//NOSONAR</span>
    }
<span class="nc" id="L242">    final int option = Integer.parseInt(args[0]);</span>
<span class="nc" id="L243">    final String tarfile = args[1];</span>
<span class="nc" id="L244">    final String tarsource = args[2];</span>
    final String[] tarfiles;
<span class="nc bnc" id="L246" title="All 2 branches missed.">    if (option == 3) {</span>
<span class="nc" id="L247">      tarfiles = args[2].split(&quot;,&quot;);</span>
<span class="nc" id="L248">      final File[] files = new File[tarfiles.length];</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">      for (int i = 0; i &lt; tarfiles.length; i++) {</span>
<span class="nc" id="L250">        files[i] = new File(tarfiles[i]);</span>
      }
<span class="nc bnc" id="L252" title="All 2 branches missed.">      if (createZipFromFiles(files, tarfile)) {</span>
<span class="nc" id="L253">        SysErrLogger.FAKE_LOGGER.sysout(&quot;ZIP OK from multiple files&quot;);</span>
      } else {
<span class="nc" id="L255">        SysErrLogger.FAKE_LOGGER.syserr(&quot;ZIP KO from multiple files&quot;);</span>
      }
<span class="nc bnc" id="L257" title="All 2 branches missed.">    } else if (option == 2) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      if (createZipFromDirectory(tarsource, tarfile, false)) {</span>
<span class="nc" id="L259">        SysErrLogger.FAKE_LOGGER.sysout(&quot;ZIP OK from directory&quot;);</span>
      } else {
<span class="nc" id="L261">        SysErrLogger.FAKE_LOGGER.syserr(&quot;ZIP KO from directory&quot;);</span>
      }
<span class="nc bnc" id="L263" title="All 2 branches missed.">    } else if (option == 1) {</span>
<span class="nc" id="L264">      final File tarFile = new File(tarfile);</span>
<span class="nc" id="L265">      final File directory = new File(tarsource);</span>
<span class="nc" id="L266">      List&lt;String&gt; result = null;</span>
      try {
<span class="nc" id="L268">        result = unZip(tarFile, directory);</span>
<span class="nc" id="L269">      } catch (final IOException e) {</span>
<span class="nc" id="L270">        SysErrLogger.FAKE_LOGGER.syserr(e);</span>
<span class="nc" id="L271">      }</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">      if (result == null || result.isEmpty()) {</span>
<span class="nc" id="L273">        SysErrLogger.FAKE_LOGGER.syserr(&quot;UNZIP KO from directory&quot;);</span>
      } else {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        for (final String string : result) {</span>
<span class="nc" id="L276">          SysErrLogger.FAKE_LOGGER.sysout(&quot;File: &quot; + string);</span>
<span class="nc" id="L277">        }</span>
      }
    }

<span class="nc" id="L281">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>